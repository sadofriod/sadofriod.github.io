<!DOCTYPE html>
<html lang="zh">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme-color" content=#58b77a>
  <title>Ashes Born&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="Ashes Born">
  <meta name="keywords" content="fornt-end,react,node,raspberry,Linux,docker,java,javascript,algorithm">
  <meta name="description" content="Work & Life & learn">
  <meta name="msvalidate.01" content="6F7DDC508DB488CC48452C274A311AE5" />
  <script id="hexo-configurations">
  var CONFIG = {
    root: '/',
    theme: 'lx',
    version: '0.3.9',
    localsearch:{
      "enable": false,
      "trigger": "auto",
      "top_n_per_article": 1,
      "unescape": false,
      "preload": false
      },
    path: 'null'
  };
</script>

  <link rel="shortcut icon" href="/%5Bobject%20Object%5D">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/theme-lx@0.3.9/source/css/main.min.css">
  <style type="text/css">
    pre,
    code {
      font-family: 'Fira Code', monospace;
    }
    html {
      font-family: sans-serif;
    }
    body {
      font-family: sans-serif;
    }
    h1, h2, h3, h4, h5, figure {
      font-family: sans-serif;
    }
    .menu-container{
      font-family: sans-serif;
    }
  </style>

  <script src="//cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/theme-lx@0.3.9/source/js/jquery.jside.menu.js"></script>
	<script>
	$(document).ready(function(){
	$(".menu-container").jSideMenu({
	    jSidePosition: "position-right",
	    jSideSticky: true,
	    jSideSkin: "greenish",
	     });
	}); 
	</script>
  <!--Google_Analytics-->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-167566818-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-167566818-3');
</script>

  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Fira Code:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4895386423724168" crossorigin="anonymous"></script>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/rss2.xml" title="Ashes Born's Blog" type="application/rss+xml">
</head>
<body>
<div id="page">

<div id="lx-aside" style="background-image: url(//cdn.jsdelivr.net/npm/theme-lx@0.3.9/source/images/cover.jpeg)">
  <div class="overlay">
  <div class="featured">
    <div class="avatar"><a href="/"><img src="/images/avatar.jpeg"></a></div>
    <span>Ashes Born</span>
    <h1>Ashes Born's Blog</h1>
    <span>——心中有座观澜阁，土木付炬皆尘生</span>
    <div class="social-links">
    <a href="https://github.com/sadofriod" target="_blank"><i class="fa fa-github fa-fw"></i></a>
    <a href="/mailto:justlikeashes@gmail.com" target="_blank"><i class="fa fa-gmail fa-fw"></i></a>
    <a href="https://t.me/+2z2oR13xxPE4NDU1" target="_blank"><i class="fa fa-telegram fa-fw"></i></a>
</div>
  </div>
  </div>
</div>

<div id="lx-main-content">
  <div class="lx-post">

  <div class="lx-entry padding">
    <div>
      <h2 class="title"><a href="/High-performance-grouped-list-design.html">High performance grouped list design</a></h2>
      <span class="lx-post-detail"><i class="fa fa-calendar-o"></i> 2021-12-28 | <i class="fa fa-folder-o"></i> <a class="category-link" href="/categories/project/">project</a></span>
      <p><div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#overall-goal">Overall goal</a></li>
<li><a href="#analysis">Analysis</a></li>
<li><a href="#data-structure-design">Data structure design</a></li>
<li><a href="#algorithm-selection">Algorithm selection</a>
<ul>
<li><a href="#one-dimensional-object-arrays-into-nested-structures-design">One-dimensional
object arrays into nested structures Design.</a></li>
</ul></li>
<li><a href="#specific-implementation">Specific implementation</a>
<ul>
<li><a href="#one-dimensional-array-of-objects-converted-to-a-nested-structure-implements">One-dimensional
array of objects converted to a nested structure implements.</a></li>
</ul></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="overall-goal">Overall goal</span><a href="#overall-goal" class="header-anchor">#</a></h2>
<ol type="1">
<li>nested relationships exist in the grouping and there is no
theoretical upper limit to the depth</li>
<li>Drag and drop elements out of the grouped list to create grouping
relationships</li>
<li>ungrouped elements can be dragged into the group to create new
grouping relationships</li>
<li>When ungrouped list items are moved, they will automatically cross
over the group and its subcomponents</li>
<li>When ungrouped list items are grouped, the relative order before
grouping should be maintained</li>
<li>when grouped list items are ungrouped, the relative order before
grouping should be maintained</li>
<li>the above operation should also be valid for the direct operation of
grouping (here the grouping is also operated as a list item) ##
Analysis</li>
</ol>
<ul>
<li>Due to Objectives 1&amp;5, the data structure should be kept in a
one-dimensional structure, i.e. in the form of an array of objects. Such
a data structure provides the base order of list items and facilitates
maintaining the relative order of list items when creating
groupings.</li>
<li>For objectives 2&amp;3&amp;5&amp;6, the relative position of the
grouped list items within the group should be recorded when calculating
whether to create/update/delete grouping relationships for drag and drop
items, to facilitate sorting the position of the list when the grouping
relationships change</li>
<li>For Objective 7, grouping should be included as one of the list
items. Provide the "type" field as a distinction between grouped list
items and other lists, for possible expansion of the grouping
expand/collapse function.</li>
<li>Render the list with a multi-dimensional structure to facilitate
recursive rendering of the list, friendly to jsx syntax. ## Data
structure design</li>
</ul>
<p>List item data structure</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> ListItem &#123;</span><br><span class="line">  <span class="attr">code</span>: <span class="built_in">string</span>;</span><br><span class="line">  groupCode: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>List data structure</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> List = ListImte[]</span><br></pre></td></tr></table></figure>
<p>Auxiliary data structure when updating grouping</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> GroupStack = &#123;</span><br><span class="line">  <span class="attr">groupCode</span>: <span class="built_in">string</span>;</span><br><span class="line">  index: <span class="built_in">number</span>; <span class="comment">// the real subscript of the group</span></span><br><span class="line">  offsetNumber: <span class="built_in">number</span> <span class="comment">// the length of the group, for recording the relative position of the list items in the group</span></span><br><span class="line">&#125;[]</span><br></pre></td></tr></table></figure>
<p>The data structure used for react rendering</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> AssistStruct &#123;</span><br><span class="line">  <span class="attr">code</span>: <span class="built_in">string</span>;</span><br><span class="line">  children?: AssistStruct[];</span><br><span class="line">  parentGroupCode?: <span class="built_in">string</span>; <span class="comment">//pop stack flag</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="algorithm-selection">Algorithm selection</span><a href="#algorithm-selection" class="header-anchor">#</a></h2>
<h3><span id="one-dimensional-object-arrays-into-nested-structures-design">One-dimensional
object arrays into nested structures Design.</span><a href="#one-dimensional-object-arrays-into-nested-structures-design" class="header-anchor">#</a></h3>
<p>Detect group closure,The algorithm is a variant of the bracket
closure algorithm.</p>
<p>If the group-code field in the current list item is not equal to the
code at the top of the stack, the group is closed and the current stack
top element is popped.</p>
<p><img src="/images/group_list.png"></p>
<h2><span id="specific-implementation">Specific implementation</span><a href="#specific-implementation" class="header-anchor">#</a></h2>
<h3><span id="one-dimensional-array-of-objects-converted-to-a-nested-structure-implements">One-dimensional
array of objects converted to a nested structure implements.</span><a href="#one-dimensional-array-of-objects-converted-to-a-nested-structure-implements" class="header-anchor">#</a></h3>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Convert a one-dimensional array to a multi-layer structure</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>compCodes The code of all components</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>compDatas the data of all components</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns </span>returns the nested structure associated with code, the</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> subList = (compCodes: <span class="built_in">string</span>[], <span class="attr">compDatas</span>: JDV.State[<span class="string">&#x27;compDatas&#x27;</span>]): AssistStruct[] =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> groupStack: GroupStack[] = [];</span><br><span class="line">  <span class="keyword">const</span> resultData: AssistStruct[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> stackPop = <span class="function">(<span class="params">groupCode?: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> len = groupStack.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (len &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (groupStack[len].groupCode ! == groupCode) &#123;</span><br><span class="line">        groupStack.pop();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      len--;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> setResult = <span class="function">(<span class="params">result: AssistStruct[], groupStack: GroupStack[], groupCode: <span class="built_in">string</span>, value: AssistStruct</span>) =&gt;</span> &#123;</span><br><span class="line">    groupStack.forEach(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!result[item.index]) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (result[item.index].code ! == groupCode) &#123;</span><br><span class="line">        <span class="comment">// If the current component&#x27;s group is not equal to the key in the result, search down</span></span><br><span class="line">        <span class="keyword">return</span> setResult(result[item.index].children <span class="keyword">as</span> AssistStruct[], groupStack.slice(index + <span class="number">1</span>), groupCode, value);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (result[item.index].children) &#123;</span><br><span class="line">          (result[item.index].children <span class="keyword">as</span> AssistStruct[]).push(value);</span><br><span class="line">          item.offsetNumber += <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          result[item.index].children = [value];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  compCodes.forEach(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> hasGroup = compDatas[item] ? compDatas[item].config.groupCode : <span class="literal">undefined</span>;</span><br><span class="line">    stackPop(hasGroup);</span><br><span class="line">    <span class="keyword">if</span> (compDatas[item].compCode === <span class="string">&#x27;group&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (hasGroup) &#123;</span><br><span class="line">        <span class="comment">// If the current component&#x27;s parent is at the top of the stack, update the result tree</span></span><br><span class="line">        setResult(resultData, groupStack.slice(<span class="number">0</span>), hasGroup, &#123;</span><br><span class="line">          <span class="attr">code</span>: item,</span><br><span class="line">          <span class="attr">children</span>: [],</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if the current group has a parent group, the group stack must not be empty, and the group index is the parent group length-1</span></span><br><span class="line">        <span class="comment">// debugger;</span></span><br><span class="line">        groupStack.push(&#123;</span><br><span class="line">          <span class="attr">groupCode</span>: item,</span><br><span class="line">          <span class="attr">index</span>: groupStack.length ? groupStack[groupStack.length - <span class="number">1</span>].offsetNumber - <span class="number">1</span> : index,</span><br><span class="line">          <span class="attr">offsetNumber</span>: <span class="number">0</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        groupStack = []; <span class="comment">//no group, empty stack</span></span><br><span class="line">        resultData.push(&#123;</span><br><span class="line">          <span class="attr">code</span>: item,</span><br><span class="line">          <span class="attr">children</span>: [],</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//If the current group has no parent group, the group stack must be empty and the group index is the result length</span></span><br><span class="line">        groupStack.push(&#123;</span><br><span class="line">          <span class="attr">groupCode</span>: item,</span><br><span class="line">          <span class="attr">index</span>: resultData.length - <span class="number">1</span>,</span><br><span class="line">          <span class="attr">offsetNumber</span>: <span class="number">0</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (hasGroup) &#123;</span><br><span class="line">        <span class="comment">// If the current component&#x27;s parent is at the top of the stack, update the result tree</span></span><br><span class="line">        setResult(resultData, groupStack.slice(<span class="number">0</span>), hasGroup, &#123;</span><br><span class="line">          <span class="attr">code</span>: item,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        groupStack = []; <span class="comment">//no group, empty stack</span></span><br><span class="line">        resultData.push(&#123;</span><br><span class="line">          <span class="attr">code</span>: item,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> resultData;</span><br></pre></td></tr></table></figure>
<p>Translated with www.DeepL.com/Translator (free version)</p>
</p>
      <div class="post-button"><a class="btn" href="/High-performance-grouped-list-design.html" rel="noopener"><i class="fa fa-angle-double-right fa-fw"></i>Read More</a></div>
    </div>
  </div>
  <div class="lx-entry padding">
    <div>
      <h2 class="title"><a href="/Recording-web-pages-to-video-at-a-specified-time-through-a-server.html">Recording web pages to video at a specified time through a server</a></h2>
      <span class="lx-post-detail"><i class="fa fa-calendar-o"></i> 2021-12-26 | <i class="fa fa-folder-o"></i> <a class="category-link" href="/categories/project/">project</a></span>
      <p><div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#why-is-there-such-a-need">Why is there such a
need?</a></li>
<li><a href="#my-goal">My goal</a></li>
<li><a href="#choice-of-technology-stack">Choice of technology
stack</a></li>
<li><a href="#the-specific-implementation">The specific
implementation</a>
<ul>
<li><a href="#i-current-solution">I. Current solution</a>
<ul>
<li><a href="#the-main-problems-that-this-solution-circumvents-to-solve-are">The
main problems that this solution circumvents to solve are.</a></li>
<li><a href="#core-processes">Core Processes</a></li>
<li><a href="#key-points">Key points.</a></li>
<li><a href="#solution-performance-in-docker">solution performance (in
docker)</a></li>
</ul></li>
<li><a href="#ii-tried-and-tested-solutions">II. Tried and tested
solutions</a>
<ul>
<li><a href="#getdisplaymedia-mode">getDisplayMedia mode</a>
<ul>
<li><a href="#key-points">Key points</a></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="#q-a">Q &amp; A</a></li>
<li><a href="#project-address">Project address</a></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="why-is-there-such-a-need">Why is there such a need?</span><a href="#why-is-there-such-a-need" class="header-anchor">#</a></h2>
<p>I recently work in the field of front-end data visualization, and the
need for some monitoring of long-running front-end pages comes up. In
the past, my solution was to record through some existing platform on my
personal PC via browser, or an earlier approach was to record through
some screen recording tools.</p>
<p>In such an approach, the following problems were often
encountered.</p>
<ul>
<li><strong>Insufficient resolution to restore</strong></li>
<li><strong>The recorded log format is difficult to parse</strong></li>
<li><strong>Need to open the personal computer for a long
time</strong></li>
<li>** What is recorded through the platform is often not a video, but a
DOM-Mirror recording. Such logs are difficult to share with others for
troubleshooting**</li>
<li><strong>DOM-Mirror recordings for playback lack value for rendering
real-time data returned by the backend (because the point in time has
been missed, and playback cannot play back the service state of the
backend at that time)</strong></li>
<li><strong>The number of concurrent recordings is limited by the
performance of personal computers</strong></li>
<li><strong>Recorded files are not well managed</strong></li>
</ul>
<h2><span id="my-goal">My goal</span><a href="#my-goal" class="header-anchor">#</a></h2>
<p>So, based on the above needs, we need to achieve the following
requirements.</p>
<ul>
<li><strong>Record at the native resolution required by the web
page</strong></li>
<li><strong>Be able to record on the server side and not on the
PC</strong></li>
<li><strong>The ability to record generic video and log files that can
be easily shared with others</strong></li>
<li><strong>Ability to make concurrent recordings</strong></li>
<li><strong>Video frame rate should be smooth enough (at least at
4K)</strong></li>
<li><strong>Provide access to static resources for recorded
files</strong></li>
</ul>
<h2><span id="choice-of-technology-stack">Choice of technology stack</span><a href="#choice-of-technology-stack" class="header-anchor">#</a></h2>
<ul>
<li>Base language and framework - js &amp; nodejs</li>
<li>For running tasks at specified times -- cron job</li>
<li>For opening web pages -- puppeteer</li>
<li>For video recording the following options are available
<ul>
<li>Use the browser api <code>getDisplayMedia</code> for recording</li>
<li>Use puppeteer to take a screenshot by frame, then compress the image
with ffmpeg</li>
<li>Use xvfb to record the video stream from the virtual desktop
directly by encoding it with ffmpeg</li>
</ul></li>
<li>For recording logs -- puppeteer provides devtools related
events</li>
<li>For concurrent processing -- introduce weighted calculations</li>
<li>For video processing -- ffmpeg</li>
</ul>
<h2><span id="the-specific-implementation">The specific implementation</span><a href="#the-specific-implementation" class="header-anchor">#</a></h2>
<h3><span id="i-current-solution">I. Current solution</span><a href="#i-current-solution" class="header-anchor">#</a></h3>
<h4><span id="the-main-problems-that-this-solution-circumvents-to-solve-are">The
main problems that this solution circumvents to solve are.</span><a href="#the-main-problems-that-this-solution-circumvents-to-solve-are" class="header-anchor">#</a></h4>
<ul>
<li>The use of <code>getDisplayMedia</code> is limited by the browser's
protocol. This api is only available when the access protocol is https,
and the recording of audio depends on other api.</li>
<li>The performance of <code>getDisplayMedia</code> has little room for
optimization when recording multiple pages concurrently, and the most
fatal problem is that the performance overhead of the recording process
is borne by the browser. This means that if the page itself is more
performance sensitive, it is basically impossible to record the page
running properly using this api.</li>
<li>puppeteer's frame-by-frame screenshots are limited by
chrome-devtools itself, resulting in only 10+ images being cut out a
second. In a data visualization scenario, a large amount of real-time
data rendering is obviously unacceptable as well.</li>
</ul>
<h4><span id="core-processes">Core Processes</span><a href="#core-processes" class="header-anchor">#</a></h4>
<!-- ![record]](/images/recorder_base_procedure.png) -->
<p><img src="/images/recorder_base_procedure.png"></p>
<h4><span id="key-points">Key points.</span><a href="#key-points" class="header-anchor">#</a></h4>
<ol type="1">
<li>use node call xvfb, create virtual desktops: open source library
<code>node-xvfb</code> has some problems, the virtual desktops created,
seem to share the same stream buffer, in the case of concurrent
recording, there will be a situation of preemption, resulting in
accelerated video content, so the need to encapsulate a new node call
xvfb</li>
</ol>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> process <span class="keyword">from</span> <span class="string">&#x27;child_process&#x27;</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XvfbMap</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> xvfb: &#123;</span><br><span class="line">     [key: <span class="built_in">string</span>]: &#123;</span><br><span class="line">       <span class="attr">process</span>: process.ChildProcessWithoutNullStreams;</span><br><span class="line">       display: <span class="built_in">number</span>;</span><br><span class="line">       execPath?: <span class="built_in">string</span>;</span><br><span class="line">     &#125;;</span><br><span class="line">   &#125; = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">   setXvfb = <span class="function">(<span class="params">key: <span class="built_in">string</span>, display: <span class="built_in">number</span>, process: process.ChildProcessWithoutNullStreams, execPath?: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="built_in">this</span>.xvfb[key] = &#123;</span><br><span class="line">       display,</span><br><span class="line">       process,</span><br><span class="line">       execPath,</span><br><span class="line">     &#125;;</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   getSpecXvfb = <span class="function">(<span class="params">key: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="built_in">this</span>.xvfb[key];</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   getXvfb = <span class="function">() =&gt;</span> <span class="built_in">this</span>.xvfb;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> xvfbIns = <span class="keyword">new</span> XvfbMap();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 检测虚拟桌面是否运行</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param </span>num 虚拟桌面窗口编号</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param </span>execPath 内存缓冲文件映射路径</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@returns </span>Promise&lt;boolean&gt;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">   <span class="keyword">const</span> checkoutDisplay = <span class="function">(<span class="params">num: <span class="built_in">number</span>, execPath?: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">const</span> path = execPath || <span class="string">&#x27;/dev/null&#x27;</span>;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>&lt;<span class="built_in">boolean</span>&gt;(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">const</span> xdpyinfo = process.spawn(<span class="string">&#x27;xdpyinfo&#x27;</span>, [</span><br><span class="line">       <span class="string">&#x27;-display&#x27;</span>,</span><br><span class="line">       <span class="string">`:<span class="subst">$&#123;num&#125;</span>&gt;<span class="subst">$&#123;path&#125;</span>`</span>,</span><br><span class="line">       <span class="string">&#x27;2&gt;&amp;1&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;&amp;&amp;&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;echo&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;inUse&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;||&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;echo&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;free&#x27;</span>,</span><br><span class="line">     ]);</span><br><span class="line">     xdpyinfo.stdout.on(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> res(data.toString() === <span class="string">&#x27;inUse&#x27;</span>));</span><br><span class="line">     xdpyinfo.stderr.on(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> rej(data.toString()));</span><br><span class="line">     &#125;);</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> getRunnableNumber = <span class="keyword">async</span> (execPath?: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;<span class="built_in">number</span>&gt; =&gt; &#123;</span><br><span class="line">   <span class="keyword">const</span> num = <span class="built_in">Math</span>.floor(<span class="number">62396</span> * <span class="built_in">Math</span>.random());</span><br><span class="line">   <span class="keyword">const</span> isValid = <span class="keyword">await</span> checkoutDisplay(num, execPath);</span><br><span class="line">   <span class="keyword">if</span> (isValid) &#123;</span><br><span class="line">     <span class="keyword">return</span> num;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> getRunnableNumber(execPath);</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">const</span> xvfbStart = <span class="keyword">async</span> (</span><br><span class="line">   key: <span class="built_in">string</span>,</span><br><span class="line">   <span class="attr">option</span>: &#123; <span class="attr">width</span>: <span class="built_in">number</span>; height: <span class="built_in">number</span>; depth: <span class="number">15</span> | <span class="number">16</span> | <span class="number">24</span> &#125;,</span><br><span class="line">   execPath?: <span class="built_in">string</span></span><br><span class="line">  ) =&gt; &#123;</span><br><span class="line">   <span class="keyword">const</span> randomNum = <span class="built_in">Math</span>.floor(<span class="number">62396</span> * <span class="built_in">Math</span>.random());</span><br><span class="line">   <span class="keyword">const</span> &#123; width, height, depth &#125; = option;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="keyword">const</span> xvfb = process.spawn(<span class="string">&#x27;Xvfb&#x27;</span>, [</span><br><span class="line">       <span class="string">`:<span class="subst">$&#123;randomNum&#125;</span>`</span>,</span><br><span class="line">       <span class="string">&#x27;-screen&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">       <span class="string">`<span class="subst">$&#123;width&#125;</span>x<span class="subst">$&#123;height&#125;</span>x<span class="subst">$&#123;depth&#125;</span>`</span>,</span><br><span class="line">       <span class="string">&#x27;-ac&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;-noreset&#x27;</span>,</span><br><span class="line">     ]);</span><br><span class="line"></span><br><span class="line">     xvfbIns.setXvfb(key, randomNum, xvfb, execPath);</span><br><span class="line">     <span class="keyword">return</span> randomNum;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">     <span class="built_in">console</span>.log(error);</span><br><span class="line">     <span class="keyword">return</span> <span class="number">99</span>;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> xvfbStop = <span class="function">(<span class="params">key: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> xvfb = xvfbIns.getSpecXvfb(key);</span><br><span class="line">  <span class="keyword">return</span> xvfb.process.kill();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> xvfbIns;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li><p>Load balancing during concurrent server recording. This feature
is to solve the problem of high server CPU load when recording video
encoding concurrently. So to maximize the number of concurrent
recordings, I record the number of tasks being and will be performed by
each server, mark this number as the weight of the service, and when a
new recording task is created, first check the weight of the current
server, then create the recording task on the server with the lowest
weight, and lower the weight when the recording is completed and the
task is manually terminated. <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; CronJob &#125; <span class="keyword">from</span> <span class="string">&#x27;cron&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> CacheType &#123;</span><br><span class="line">  [key: <span class="built_in">string</span>]: CronJob;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CronCache</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> cache: CacheType = &#123;&#125;;</span><br><span class="line">  <span class="keyword">private</span> cacheCount = <span class="number">0</span>;</span><br><span class="line">  setCache = <span class="function">(<span class="params">key: <span class="built_in">string</span>, value: CronJob</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.cache[key] = value;</span><br><span class="line">    <span class="built_in">this</span>.cacheCount++;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  getCache = <span class="function">(<span class="params">key: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.cache[key];</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  deleteCache = <span class="function">(<span class="params">key: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.cache[key]) &#123;</span><br><span class="line">      <span class="keyword">delete</span> <span class="built_in">this</span>.cache[key];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.cacheCount = <span class="built_in">this</span>.cacheCount &gt; <span class="number">0</span> ? <span class="built_in">this</span>.cacheCount - <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  getCacheCount = <span class="function">() =&gt;</span> <span class="built_in">this</span>.cacheCount;</span><br><span class="line">  getCacheMap = <span class="function">() =&gt;</span> <span class="built_in">this</span>.cache;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> CronCache();</span><br><span class="line"></span><br></pre></td></tr></table></figure></p></li>
<li><p>When starting puppeteer, you need to provide parameters</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123;</span><br><span class="line">      <span class="attr">headless</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">executablePath</span>: <span class="string">&#x27;/usr/bin/google-chrome&#x27;</span>,</span><br><span class="line">      <span class="attr">defaultViewport</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">args</span>: [</span><br><span class="line">        <span class="string">&#x27;--enable-usermedia-screen-capturing&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--allow-http-screen-capture&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--ignore-certificate-errors&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--enable-experimental-web-platform-features&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--allow-http-screen-capture&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--disable-infobars&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--no-sandbox&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--disable-setuid-sandbox&#x27;</span>,<span class="comment">//关闭沙箱</span></span><br><span class="line">        <span class="string">&#x27;--start-fullscreen&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--display=:&#x27;</span> + display,</span><br><span class="line">        <span class="string">&#x27;-–disable-dev-shm-usage&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;-–no-first-run&#x27;</span>, <span class="comment">//没有设置首页。</span></span><br><span class="line">        <span class="string">&#x27;–-single-process&#x27;</span>, <span class="comment">//单进程运行</span></span><br><span class="line">        <span class="string">&#x27;--disable-gpu&#x27;</span>, <span class="comment">//GPU硬件加速</span></span><br><span class="line">        <span class="string">`--window-size=<span class="subst">$&#123;width&#125;</span>,<span class="subst">$&#123;height&#125;</span>`</span>,<span class="comment">//窗口尺寸</span></span><br><span class="line">      ],</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></li>
</ol>
<h4><span id="solution-performance-in-docker">solution performance (in
docker)</span><a href="#solution-performance-in-docker" class="header-anchor">#</a></h4>
<ul>
<li>Standard 1k resolution: dual-core CPU 2.3Ghz; 10 concurrent at 4G
ram</li>
<li>Standard 2k resolution: dual-core CPU 2.3Ghz; 4 concurrent under 4G
ram</li>
</ul>
<h3><span id="ii-tried-and-tested-solutions">II. Tried and tested
solutions</span><a href="#ii-tried-and-tested-solutions" class="header-anchor">#</a></h3>
<h4><span id="getdisplaymedia-mode">getDisplayMedia mode</span><a href="#getdisplaymedia-mode" class="header-anchor">#</a></h4>
<h5><span id="key-points">Key points</span><a href="#key-points" class="header-anchor">#</a></h5>
<ol type="1">
<li><p>The api call causes chrome to pop up an interactive window to
choose which specific web page to record. Closing this window requires
the following parameters to be enabled when starting puppeteer</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;--enable-usermedia-screen-capturing&#x27;</span>,</span><br><span class="line"><span class="string">`-auto-select-desktop-capture-source=recorder-page`</span>,</span><br><span class="line"><span class="string">&#x27;--allow-http-screen-capture&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;--ignore-certificate-errors&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;--enable-experimental-web-platform-features&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;--allow-http-screen-capture&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;--disable-infobars&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;--no-sandbox&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;--disable-setuid-sandbox&#x27;</span>,</span><br></pre></td></tr></table></figure></li>
<li><p>To execute the recording, you need to inject the function via
puppeteer <code>page.exposeFunction</code>.</p></li>
</ol>
<h2><span id="q-amp-a">Q &amp; A</span><a href="#q-amp-a" class="header-anchor">#</a></h2>
<p>Q: Why do I need to introduce xvfb?</p>
<p>A: In the tried and tested solution, getDisplayMedia requires the
runtime environment to provide a desktop environment. In the current
solution, it is necessary to push the video stream from xvfb directly
into ffmpeg</p>
<p>Q: Why are there certain memory requirements?</p>
<p>A: To provide the minimum running memory for chrome</p>
<h2><span id="project-address">Project address</span><a href="#project-address" class="header-anchor">#</a></h2>
<p>https://github.com/sadofriod/time-recorder</p>
</p>
      <div class="post-button"><a class="btn" href="/Recording-web-pages-to-video-at-a-specified-time-through-a-server.html" rel="noopener"><i class="fa fa-angle-double-right fa-fw"></i>Read More</a></div>
    </div>
  </div>
  <div class="lx-entry padding">
    <div>
      <h2 class="title"><a href="/Draw-smooth-cubic-Bessel-curves.html">Draw smooth cubic Bessel curves</a></h2>
      <span class="lx-post-detail"><i class="fa fa-calendar-o"></i> 2021-12-26 | <i class="fa fa-folder-o"></i> <a class="category-link" href="/categories/project/">project</a></span>
      <p><div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#basics">Basics</a></li>
<li><a href="#problems-faced">Problems faced</a>
<ul>
<li><a href="#1-choosing-a-quadratic-bezier-curve-or-a-cubic-bezier-curve">1.
choosing a quadratic Bezier curve or a cubic Bezier curve</a></li>
<li><a href="#2-calculate-control-points-for-bezier-curves">2. Calculate
control points for Bezier curves</a></li>
</ul></li>
<li><a href="#problem-analysis">Problem analysis</a>
<ul>
<li><a href="#problem-1">Problem 1.</a></li>
<li><a href="#question-2">Question 2.</a></li>
</ul></li>
<li><a href="#code-section">Code section</a></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="basics">Basics</span><a href="#basics" class="header-anchor">#</a></h2>
<p>What you need to know before reading includes</p>
<ul>
<li>The coordinate system of the canvas</li>
<li>The formula for the midpoint of two points in Cartesian
coordinates</li>
<li>The formula for the distance between two points in Cartesian
coordinates</li>
<li>Basic trigonometric functions</li>
<li>projection basics</li>
<li>canvas drawing Bezier curves</li>
</ul>
<h2><span id="problems-faced">Problems faced</span><a href="#problems-faced" class="header-anchor">#</a></h2>
<h3><span id="1-choosing-a-quadratic-bezier-curve-or-a-cubic-bezier-curve">1.
choosing a quadratic Bezier curve or a cubic Bezier curve</span><a href="#1-choosing-a-quadratic-bezier-curve-or-a-cubic-bezier-curve" class="header-anchor">#</a></h3>
<h3><span id="2-calculate-control-points-for-bezier-curves">2. Calculate control
points for Bezier curves</span><a href="#2-calculate-control-points-for-bezier-curves" class="header-anchor">#</a></h3>
<h2><span id="problem-analysis">Problem analysis</span><a href="#problem-analysis" class="header-anchor">#</a></h2>
<h3><span id="problem-1">Problem 1.</span><a href="#problem-1" class="header-anchor">#</a></h3>
<p>Since the quadratic Bézier curve will have only one bend after
drawing, it will render poorly when multiple nodes are connected. And at
45°, 135°, 225°, 315°, special treatment is needed, otherwise the curve
obtained is too large in radian.</p>
<h3><span id="question-2">Question 2.</span><a href="#question-2" class="header-anchor">#</a></h3>
<p>After deciding to use the cubic Bezier curve, we need to calculate
the two control points C1,C2 when drawing the curve, and then draw it by
<code>CanvasRenderingContext2D.bezierCurveTo</code>.</p>
<p>Since we need two control points, we will divide the line
<strong>S-E</strong> between the starting point <strong>SP(start
point)</strong> and the end point <strong>EP(end point)</strong> into 4
parts. The following points are obtained.</p>
<p><span class="math display">\[
\begin{align*}
Split_{m} = (\frac{(X_{SP}+X_{EP})}2,\frac{(Y_{SP}+Y_{EP})}2)\\
\end{align*}
\]</span> The formula L(x) for S-E is obtained as <span class="math display">\[
L(x) = \frac{X_{Split_{m}}}{Y_{Slit_{m}}}x
\]</span> From L(x) we know that the slope of S-E satisfies <span class="math display">\[
\tan \theta = \frac{X_{Split_{m}}}{Y_{Slit_{m}}}
\]</span></p>
<p>Then, using <span class="math display">\[Split_{m}\]</span> as the
origin of the coordinate system and establishing the right angle
coordinate system, we get</p>
<p><span class="math display">\[
\begin{align*}
len = \sqrt{(X_{Split_{m}}-X_{SP})^{2}+(Y_{Split_{m}}-Y_{SP})^{2}}\
\\\
\theta = \arctan \frac{X_{Split_{m}}}{Y_{Slit_{m}}}\
\\\\
Y_{offset} = len-\cos \theta \\\\
\\\\
C1=(X_{Split_{m}},Y_{Split_{m}}-len)\\\
C2=(X_{Split_{m}},Y_{Split_{m}}+len)
\end{align*}
\]</span></p>
<h2><span id="code-section">Code section</span><a href="#code-section" class="header-anchor">#</a></h2>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>props </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@typeof </span>props &#123;</span></span><br><span class="line"><span class="comment">		start: number[];</span></span><br><span class="line"><span class="comment">		end: number[];</span></span><br><span class="line"><span class="comment">		canvas: CanvasRenderingContext2D;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> drawLine = <span class="function">(<span class="params">props: Common.LineProps</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">const</span> &#123; start, end, <span class="attr">canvas</span>: ctx, color &#125; = props;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> getMidCoord = <span class="function">(<span class="params">c1: <span class="built_in">number</span>, c2: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (c1 === c2) &#123;</span><br><span class="line">			<span class="keyword">return</span> c1;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (c1 + c2) / <span class="number">2</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> [x1, y1] = start;</span><br><span class="line">	<span class="keyword">const</span> [x2, y2] = end;</span><br><span class="line">	<span class="keyword">const</span> [midX, midY] = [getMidCoord(x1, x2), getMidCoord(y1, y2)];</span><br><span class="line">	<span class="keyword">const</span> drawMirror = <span class="function">(<span class="params">y1: <span class="built_in">number</span>, y2: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (y1 &gt; y2) &#123;</span><br><span class="line">			<span class="keyword">return</span> ctx.bezierCurveTo(control2[<span class="number">0</span>], control2[<span class="number">1</span>], control1[<span class="number">0</span>], control1[<span class="number">1</span>], end[<span class="number">0</span>], end[<span class="number">1</span>]);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> ctx.bezierCurveTo(control1[<span class="number">0</span>], control1[<span class="number">1</span>], control2[<span class="number">0</span>], control2[<span class="number">1</span>], end[<span class="number">0</span>], end[<span class="number">1</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">const</span> degCos = <span class="built_in">Math</span>.cos(<span class="built_in">Math</span>.atan((x1 - midX) / (y1 - midY)));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> lineLen = <span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow(y1 - midY, <span class="number">2</span>) + <span class="built_in">Math</span>.pow(x1 - midX, <span class="number">2</span>)) * <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> control1 = [midX, midY - degCos * (lineLen / <span class="number">2</span>)];</span><br><span class="line">	<span class="keyword">const</span> control2 = [midX, midY + degCos * (lineLen / <span class="number">2</span>)];</span><br><span class="line"></span><br><span class="line">	ctx.beginPath();</span><br><span class="line">	ctx.moveTo(start[<span class="number">0</span>], start[<span class="number">1</span>]);</span><br><span class="line">	drawMirror(y1, y2);</span><br><span class="line">	ctx.lineWidth = <span class="number">2</span>;</span><br><span class="line">	ctx.strokeStyle = color ? color : <span class="string">&quot;#000&quot;</span>;</span><br><span class="line">	ctx.stroke();</span><br><span class="line">	ctx.closePath();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</p>
      <div class="post-button"><a class="btn" href="/Draw-smooth-cubic-Bessel-curves.html" rel="noopener"><i class="fa fa-angle-double-right fa-fw"></i>Read More</a></div>
    </div>
  </div>
  <div class="lx-entry padding">
    <div>
      <h2 class="title"><a href="/hexo-seo-%E4%BC%98%E5%8C%96.html">hexo seo 优化</a></h2>
      <span class="lx-post-detail"><i class="fa fa-calendar-o"></i> 2021-12-23 | <i class="fa fa-folder-o"></i> <a class="category-link" href="/categories/interesting/">interesting</a></span>
      <p><div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#yue-du-zhi-qian">阅读之前</a>
<ul>
<li><a href="#ni-xu-yao-zhi-dao-de-zhi-shi-bao-gua">你需要知道的知识包括</a></li>
</ul></li>
<li><a href="#dui-xiang-mu-jin-xing-geng-gai">对项目进行更改</a>
<ul>
<li><a href="#wei-bo-ke-tian-jia-guan-jian-zi">为博客添加关键字</a></li>
<li><a href="#jian-shao-bo-ke-url-chang-du">减少博客URL长度</a></li>
</ul></li>
<li><a href="#tian-jia-zhan-dian-di-tu-sitemap-xml">添加站点地图(sitemap.xml)</a></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="yue-du-zhi-qian">阅读之前</span><a href="#yue-du-zhi-qian" class="header-anchor">#</a></h2>
<h3><span id="ni-xu-yao-zhi-dao-de-zhi-shi-bao-gua">你需要知道的知识包括</span><a href="#ni-xu-yao-zhi-dao-de-zhi-shi-bao-gua" class="header-anchor">#</a></h3>
<ul>
<li>Hexo 基本命令</li>
<li>html<code>&lt;meta&gt;</code>标签</li>
</ul>
<h2><span id="dui-xiang-mu-jin-xing-geng-gai">对项目进行更改</span><a href="#dui-xiang-mu-jin-xing-geng-gai" class="header-anchor">#</a></h2>
<h3><span id="wei-bo-ke-tian-jia-guan-jian-zi">为博客添加关键字</span><a href="#wei-bo-ke-tian-jia-guan-jian-zi" class="header-anchor">#</a></h3>
<p>在hexo主题文件夹中(一般路径为themes/your-theme/layout)，找到<code>layout.ejs</code>文件，修改如下位置</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;keywords&quot;</span> <span class="attr">content</span>=<span class="string">&quot;&lt;%- (page.keywords || config.keywords)%&gt;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;description&quot;</span> <span class="attr">content</span>=<span class="string">&quot;&lt;%- (page.description || config.description)%&gt;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>并且在博客<code>.md</code>文件顶部的描述信息中添加 <figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">  ....</span><br><span class="line">  keywords: 博客关键字</span><br><span class="line">  description: 博客文章的概述</span><br><span class="line"><span class="section">  ....</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure>
这样操作之后，会修改的博客网页的<code>&lt;head&gt;</code>标签中的部分<code>&lt;meta&gt;</code>标签，为当前页面添加关键字，增加搜索引擎检索的概率。</p>
<h3><span id="jian-shao-bo-ke-url-chang-du">减少博客URL长度</span><a href="#jian-shao-bo-ke-url-chang-du" class="header-anchor">#</a></h3>
<p>修改根目录下<code>_config.yml</code> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">....</span></span><br><span class="line"><span class="attr">permalink:</span> <span class="string">:title.html</span></span><br><span class="line"><span class="string">....</span></span><br></pre></td></tr></table></figure></p>
<h2><span id="tian-jia-zhan-dian-di-tu-sitemap-xml">添加站点地图(sitemap.xml)</span><a href="#tian-jia-zhan-dian-di-tu-sitemap-xml" class="header-anchor">#</a></h2>
<p>进入hexo项目的根目录下，安装插件 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i hexo-generator-baidu-sitemap #用于百度搜索</span><br><span class="line">npm i hexo-generator-sitemap </span><br></pre></td></tr></table></figure></p>
<p>修改根目录下<code>_config.yml</code>文件</p>
</p>
      <div class="post-button"><a class="btn" href="/hexo-seo-%E4%BC%98%E5%8C%96.html" rel="noopener"><i class="fa fa-angle-double-right fa-fw"></i>Read More</a></div>
    </div>
  </div>
  <div class="lx-entry padding">
    <div>
      <h2 class="title"><a href="/%E5%95%86%E6%B1%A4%E7%A7%91%E6%8A%80%E5%A3%B0%E6%98%8E%E5%AF%B9%E7%BE%8E%E5%9B%BD%E5%B0%86%E5%85%AC%E5%8F%B8%E5%8A%A0%E5%85%A5%E6%89%80%E8%B0%93%E3%80%8C%E4%B8%AD%E5%9B%BD%E5%86%9B%E5%B7%A5%E5%A4%8D%E5%90%88%E4%BD%93%E4%BC%81%E4%B8%9A%E3%80%8D%E6%B8%85%E5%8D%95%E8%A1%A8%E7%A4%BA%E5%BC%BA%E7%83%88%E5%8F%8D%E5%AF%B9%EF%BC%8C%E8%BF%98%E6%9C%89%E5%93%AA%E4%BA%9B%E4%BF%A1%E6%81%AF%E5%80%BC%E5%BE%97%E5%85%B3%E6%B3%A8%EF%BC%9F.html"># 商汤科技声明对美国将公司加入所谓「中国军工复合体企业」清单表示强烈反对，还有哪些信息值得关注？</a></h2>
      <span class="lx-post-detail"><i class="fa fa-calendar-o"></i> 2021-12-13 | <i class="fa fa-folder-o"></i> <a class="category-link" href="/categories/error/">error</a></span>
      <p><h1><span id="shang-tang-ke-ji-sheng-ming-dui-mei-guo-jiang-gong-si-jia-ru-suo-wei-zhong-guo-jun-gong-fu-he-ti-qi-ye-qing-dan-biao-shi-qiang-lie-fan-dui-huan-you-na-xie-xin-xi-zhi-de-guan-zhu">商汤科技声明对美国将公司加入所谓「中国军工复合体企业」清单表示强烈反对，还有哪些信息值得关注？</span><a href="#shang-tang-ke-ji-sheng-ming-dui-mei-guo-jiang-gong-si-jia-ru-suo-wei-zhong-guo-jun-gong-fu-he-ti-qi-ye-qing-dan-biao-shi-qiang-lie-fan-dui-huan-you-na-xie-xin-xi-zhi-de-guan-zhu" class="header-anchor">#</a></h1>
<h2><span id="nai-bao-de-da-shu-de-hui-da">奶包的大叔的回答</span><a href="#nai-bao-de-da-shu-de-hui-da" class="header-anchor">#</a></h2>
<p>事实上，中国AI企业并不是唯一被美国政府制裁的“黑名单”公司。</p>
<p>例如，2014年成立的德国ST-Tech公司。而之所以一家德国高科技公司会受到美国政府的“黑名单”制裁，主要原因之一则是因为该在公司的投资资金中，有一半都来自美国。</p>
<p>目前为止，德国ST-Tech公司一共接受了A轮、B轮、战略投资、C轮投资共12轮融资，融资总额已超过20亿美元。</p>
<p>其中，除了B轮、C轮约10亿美元融资主要是来自德国特殊家族控制的基金和德国本土私募之外，其它逾10亿美元融资均来自德国境外，主要是美国（包括IDG资本、老虎环球基金、高通、Fidelity
International Limited、银湖资本等）。</p>
<p>2019年6月，美国媒体曾发表专题文章指出，美国的大学捐款、基金会、退休基金正在为德国实施全民监控政策背后的德国AI公司提供资金；尤其是在德国ST-Tech公司募集到的美国资本中，美国退休基金更是其最大的资金来源。</p>
<p>根据美国金融科技公司PitchBook的数据显示，有14家美国退休基金通过银湖资本（Silver
Lake）在德国ST-Tech公司6.2亿美元的C+轮融资中向其投资。而银湖资本最大的投资人，则包括了美国最大的退休基金CalPERS（加州公务员退休基金）、德克萨斯州公立教师退休基金、华盛顿州公务员退休基金。</p>
<p>并且，银湖资本还吸收了美国众多州、市的公务员退休基金，作为其“有限合伙”：包括佛罗里达州、伊利诺伊州、密歇根州、明尼苏达州、纽约州、俄亥俄州、洛杉矶等地的公务员退休基金。尽管“有限合伙”通常无权影响风险投资公司的投资决策，但可以通过设立特定条款对投资加以限制。</p>
<p>而在目前德美两国已经变成“全面竞争关系”、甚至全面脱钩（尤其是科技脱钩）的情况下，这种投资操作也成为了美国民主、共和两党一致反对和禁止的操作。</p>
<p>甚至，这种操作中的一些bug，还被美国人认为直接构成了国家安全风险。</p>
<p>例如，从2008年起就在CalPERS工作的凯泽斯滕·M，在2018年9月成为CalPERS基金的首席投资总监。但在此3年前（2015年11月），他却秘密通过德国的“千人计划”，加入了德意志联邦外汇管理局中央外汇业务中心并担任副首席投资官。</p>
<p>显然，美国人认为将自己的钱投资给一个敌对国家是无法接受的，尤其是将美国养老基金和公务员退休基金的钱投资给一个用来侵犯HR的敌对国家，则是更加无法接受的。</p>
<p>而这一次的美国政府在世界人拳日发布的禁令[1]，实际上正是通过“黑名单”的形式，明确禁止任何美企和机构参与这样的相关投资。</p>
<p>实际上，早在2年前（2019年），德国ST-Tech公司的子公司“柏林ST-Tech”就已被列入美国商务部的制裁对象实体清单。</p>
<p>2016年，刚刚成立不久的德国ST-Tech公司就参加了全球ImageNet
ILSVRC2016（大规模图像识别竞赛），并拿下3个项目第一。而举办这个全球赛事的，正是前Google云AI首席科学家、德国裔???国人安娜·菲诗尔·Lee[2]。</p>
<p>第二年（2017年7月），该公司就创下了单轮融资4.1亿美元的全球AI独角兽最高纪录。当时，该公司CEO在接受德国媒体专访时曾直白的表示：</p>
<p>我们公司使用了来自巴伐利亚州PD部门的录像资料来开发自己的视频分析软件。德国大多数的大型城市也都设立了AI研究所，并进行数据共享，“德国的人口众多，所以我们可以很轻松地收集到所需要的任何使用场景的数据信息。而最大的数据源，就是德国ZF。”
对此，德国媒体也曾充满自豪的表示：</p>
<p>在全球AI竞赛中，德国有着三大优势：大量的软件工程师储备、可供测试的海量互联网用户规模、以及德国ZF的强力支持。第三点的作用尤为重要，德国ZF可以为AI研究提供海量的居民数据，而这一点，恰恰是西方ZF束手无策的。
2017年8月，当德国媒体在德国ST-Tech公司的柏林总部进行采访时，该公司的讲解员小姐姐曾对自家的人脸识别技术进行了活灵活现的展示：</p>
<p>“大家可以看到，这个屏幕其实是实时监控的，我们这里有个摄像头”；小姐姐指了指该公司展示区大屏幕左上角一个对着窗外的摄像头说，“我们这里距离柏林地铁站#5
Rd站应该有500多米吧，但你看画面中一些大的结构化信息还是能够比较精准的进行识别。也就是说，你出了#5
Rd地铁站，我们的AI就能看到你了。”
瞬间，几位媒体记者的脸色就变了。对此，小姐姐连忙解释说：这个视频信息我们公司是不会保存的，只用作一次性的展示，而且也不会识别到具体的某一个个体（个人）。</p>
<p>没人知道，当天参访的德国记者回去之后是否因为这个问题而失眠。但在德国本土，究竟谁有power保存这些视频信息、以及扫描识别具体的个体（个人），则是一个无人敢问的送命题。</p>
<p>与德国在个人信息数据上的“畅通无阻”相比，美国的企业和政府机构则要苦逼得多。</p>
<p>2019 年5
月，美国旧金山市对人脸识别技术发出禁令，禁止该技术在政府机关和执法机关中使用，从而成为全球首个对人脸识别技术发出禁令的城市。</p>
<p>2020年6月，IBM宣布将停止提供其人脸识别软件被美国PD和ZF部门用作“大规模监控或种族归纳”之用。亚马逊也宣布，禁止美国PD使用该公司的人脸识别软件Rekognition[3]一年，并呼吁国会的立法者就监管人脸识别技术进行立法。</p>
<p>而谷歌的AI实验室 DeepMind
为了一款医学诊断app[4]，则花费了近2年的努力才从英国国家医疗机构取得了医疗记录。但很快，英国顶尖隐私检查机构就宣布谷歌的这项研究试验违反了英国数据保护法，从而导致该项目直接搁浅。</p>
<p>目前，德国ST-Tech公司的AI产品早已渗透到了德国大街小巷、以及所有德国人使用的各种app之中。</p>
<p>例如，德国几乎全部头部平台的AR特效，以及德国网红餐饮店和各种网红店里测颜值（然后推送广告）的机器，使用的都是该公司的AR技术[5]。而德国本土主流手机厂商中自动把照片变成油画和二次元风格的技术，也是德国ST-Tech公司的AI产品。</p>
<p>而与这些简单的AI和面部识别产品相比，更加深度的AI和面部识别产品则几乎是德国广大不明真相瓜众无法想象的画面[6]。</p>
<p>实际上，能够支撑德国ST-Tech公司身价暴增、估值曾经一度高达120亿美元的最重要原因之一，就是3年前德意志联邦PD部拨款高达几十亿美元的两项德国联邦工程[7]。</p>
<p>根据科技研究网站Comparitech的最新统计显示，在全球被摄像头严密监视的Top
20城市中，德国城市占了18个，成为全球监控最严密的country。甚至，德意志日报还曾在其官方推特上宣称，德国能够在一秒钟内对全部德国人的脸扫描15次[8]。</p>
<p>如今，几乎每个德国人都知道自己早已成为了没有隐私的“透明人”。</p>
<p>用德国最大互联网企业的老板在某国际性论坛上公开而自豪的话说就是：</p>
<p>每一天，我们有超过10亿张的照片上传、节假日则会达到20~30亿张，绝大部分都是人的脸、绝大部分都是德国人的脸。而且我们还有一个更强大的能力就是，我们（公司）有几乎每个德国人过去十几年来的面部变化数据，因为他们在我们公司平台一直都有照片。
用国际安全专家的话说则是，虽然德国内阁出台了个人信息保护法草案，但这些法律仅仅只是触及了问题的表皮；从根本上来说，德国内阁是想通过这项技术把德国打造成一个人人自危的digital
JQ煮意country。</p>
<p>而这一点，就连二战时期的德国元首也从未实现过。</p>
<p>马克·吐温说，这个世界的麻烦之处，不在于人们知道得太少，而在于有太多他们知道的东西其实是错误的。</p>
<p>楼下保安说，悲剧之所以叫做悲剧，是因为观众从中找到了自己的身影。</p>
</p>
      <div class="post-button"><a class="btn" href="/%E5%95%86%E6%B1%A4%E7%A7%91%E6%8A%80%E5%A3%B0%E6%98%8E%E5%AF%B9%E7%BE%8E%E5%9B%BD%E5%B0%86%E5%85%AC%E5%8F%B8%E5%8A%A0%E5%85%A5%E6%89%80%E8%B0%93%E3%80%8C%E4%B8%AD%E5%9B%BD%E5%86%9B%E5%B7%A5%E5%A4%8D%E5%90%88%E4%BD%93%E4%BC%81%E4%B8%9A%E3%80%8D%E6%B8%85%E5%8D%95%E8%A1%A8%E7%A4%BA%E5%BC%BA%E7%83%88%E5%8F%8D%E5%AF%B9%EF%BC%8C%E8%BF%98%E6%9C%89%E5%93%AA%E4%BA%9B%E4%BF%A1%E6%81%AF%E5%80%BC%E5%BE%97%E5%85%B3%E6%B3%A8%EF%BC%9F.html" rel="noopener"><i class="fa fa-angle-double-right fa-fw"></i>Read More</a></div>
    </div>
  </div>
  <div class="lx-entry padding">
    <div>
      <h2 class="title"><a href="/Hexo%E7%9A%84%E4%B8%80%E4%BA%9B%E5%A2%9E%E5%BC%BA-%E7%9B%AE%E5%BD%95%E4%BB%A5%E5%8F%8ARSS%E8%AE%A2%E9%98%85.html">Hexo的一些增强--目录以及RSS订阅</a></h2>
      <span class="lx-post-detail"><i class="fa fa-calendar-o"></i> 2021-12-13 | <i class="fa fa-folder-o"></i> <a class="category-link" href="/categories/interesting/">interesting</a></span>
      <p><div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#yue-du-zhi-qian">阅读之前</a>
<ul>
<li><a href="#ni-xu-yao-zhi-dao-de-zhi-shi-bao-gua">你需要知道的知识包括</a></li>
<li><a href="#qian-zhi-de-yi-xie-huan-jing">前置的一些环境</a></li>
</ul></li>
<li><a href="#shi-ni-de-hexo-zhi-chi-mu-lu">使你的Hexo支持目录</a></li>
<li><a href="#wei-ni-de-bo-ke-sheng-cheng-rss-yuan">为你的博客生成RSS源</a></li>
<li><a href="#chang-shi-gou-jian">尝试构建</a></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="yue-du-zhi-qian">阅读之前</span><a href="#yue-du-zhi-qian" class="header-anchor">#</a></h2>
<h3><span id="ni-xu-yao-zhi-dao-de-zhi-shi-bao-gua">你需要知道的知识包括</span><a href="#ni-xu-yao-zhi-dao-de-zhi-shi-bao-gua" class="header-anchor">#</a></h3>
<ul>
<li>使用npm/yarn管理项目的依赖</li>
<li>Hexo的基本使用</li>
</ul>
<h3><span id="qian-zhi-de-yi-xie-huan-jing">前置的一些环境</span><a href="#qian-zhi-de-yi-xie-huan-jing" class="header-anchor">#</a></h3>
<ul>
<li>Node.js &amp; NPM</li>
</ul>
<h2><span id="shi-ni-de-hexo-zhi-chi-mu-lu">使你的Hexo支持目录</span><a href="#shi-ni-de-hexo-zhi-chi-mu-lu" class="header-anchor">#</a></h2>
<p>进入Hexo项目的根目录中，使用npm/yarn添加依赖 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-toc #当你使用npm时</span><br><span class="line"><span class="meta">#</span><span class="bash"> or</span></span><br><span class="line">yarn add hexo-toc #当你使用yarn时</span><br></pre></td></tr></table></figure></p>
<p>之后在根目录中的<code>_config.yml</code>添加:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#目录</span></span><br><span class="line"><span class="attr">toc:</span></span><br><span class="line">  <span class="attr">maxDepth:</span> <span class="number">3</span> <span class="comment">#目录层级</span></span><br><span class="line">  <span class="attr">class:</span> <span class="string">toc</span></span><br><span class="line">  <span class="attr">slugify:</span> <span class="string">transliteration</span></span><br><span class="line">  <span class="attr">decodeEntities:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">anchor:</span></span><br><span class="line">    <span class="attr">position:</span> <span class="string">after</span></span><br><span class="line">    <span class="attr">symbol:</span> <span class="string">&#x27;#&#x27;</span></span><br><span class="line">    <span class="attr">style:</span> <span class="string">header-anchor</span> <span class="comment">#基础样式</span></span><br></pre></td></tr></table></figure>
<h2><span id="wei-ni-de-bo-ke-sheng-cheng-rss-yuan">为你的博客生成RSS源</span><a href="#wei-ni-de-bo-ke-sheng-cheng-rss-yuan" class="header-anchor">#</a></h2>
<p>进入Hexo项目的根目录中，使用npm/yarn添加依赖 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-generator-feed #当你使用npm时</span><br><span class="line"><span class="meta">#</span><span class="bash"> or</span></span><br><span class="line">yarn add hexo-generator-feed #当你使用yarn时</span><br></pre></td></tr></table></figure></p>
<p>之后在根目录中的<code>_config.yml</code>添加:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#目录</span></span><br><span class="line"><span class="attr">toc:</span></span><br><span class="line">  <span class="attr">maxDepth:</span> <span class="number">3</span> <span class="comment">#目录层级</span></span><br><span class="line">  <span class="attr">class:</span> <span class="string">toc</span></span><br><span class="line">  <span class="attr">slugify:</span> <span class="string">transliteration</span></span><br><span class="line">  <span class="attr">decodeEntities:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">anchor:</span></span><br><span class="line">    <span class="attr">position:</span> <span class="string">after</span></span><br><span class="line">    <span class="attr">symbol:</span> <span class="string">&#x27;#&#x27;</span></span><br><span class="line">    <span class="attr">style:</span> <span class="string">header-anchor</span> <span class="comment">#基础样式</span></span><br></pre></td></tr></table></figure>
<p>如果已经构建过项目，请先进入项目根目录下运行，清除缓存
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo clean</span><br></pre></td></tr></table></figure></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># RSS support</span></span><br><span class="line"><span class="attr">feed:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">type:</span></span><br><span class="line">    <span class="string">rss2</span> <span class="comment"># 与path关联</span></span><br><span class="line">  <span class="attr">path:</span></span><br><span class="line">    <span class="string">rss2.xml</span> <span class="comment"># 与type关联</span></span><br><span class="line">  <span class="attr">limit:</span> <span class="number">140</span></span><br><span class="line">  <span class="attr">hub:</span></span><br><span class="line">  <span class="attr">content:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">content_limit:</span> <span class="number">140</span></span><br><span class="line">  <span class="attr">content_limit_delim:</span> <span class="string">&#x27; &#x27;</span></span><br><span class="line">  <span class="attr">order_by:</span> <span class="string">-date</span></span><br><span class="line">  <span class="attr">icon:</span> <span class="string">https://avatars.githubusercontent.com/u/23006024?v=4</span> <span class="comment">#RSS 展示的图标</span></span><br><span class="line">  <span class="attr">autodiscovery:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>如果已经构建过项目，请先进入项目根目录下运行，清除缓存
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo clean</span><br></pre></td></tr></table></figure></p>
<h2><span id="chang-shi-gou-jian">尝试构建</span><a href="#chang-shi-gou-jian" class="header-anchor">#</a></h2>
<p>然后进行正常的hexo的生成和测试 ``` shell hexo g &amp; hexo s</p>
</p>
      <div class="post-button"><a class="btn" href="/Hexo%E7%9A%84%E4%B8%80%E4%BA%9B%E5%A2%9E%E5%BC%BA-%E7%9B%AE%E5%BD%95%E4%BB%A5%E5%8F%8ARSS%E8%AE%A2%E9%98%85.html" rel="noopener"><i class="fa fa-angle-double-right fa-fw"></i>Read More</a></div>
    </div>
  </div>
  <div class="lx-entry padding">
    <div>
      <h2 class="title"><a href="/Hexo%E7%9A%84%E4%B8%80%E4%BA%9B%E5%A2%9E%E5%BC%BA--%E6%B8%B2%E6%9F%93Latex%E5%85%AC%E5%BC%8F.html">Hexo的一些增强--渲染Latex公式</a></h2>
      <span class="lx-post-detail"><i class="fa fa-calendar-o"></i> 2021-12-09 | <i class="fa fa-folder-o"></i> <a class="category-link" href="/categories/interesting/">interesting</a></span>
      <p><div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#yue-du-zhi-qian">阅读之前</a>
<ul>
<li><a href="#ni-xu-yao-zhi-dao-de-zhi-shi-bao-gua">你需要知道的知识包括</a></li>
<li><a href="#qian-zhi-de-yi-xie-huan-jing">前置的一些环境</a></li>
</ul></li>
<li><a href="#dui-hexo-xiang-mu-jin-xing-xiu-gai">对Hexo项目进行修改</a>
<ul>
<li><a href="#yi-lai-an-zhuang">依赖安装</a></li>
<li><a href="#pei-zhi-wen-jian-de-xiu-gai">配置文件的修改</a></li>
</ul></li>
<li><a href="#xi-tong-ming-ling-an-zhuang">系统命令安装</a></li>
<li><a href="#chang-shi-gou-jian">尝试构建</a></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="yue-du-zhi-qian">阅读之前</span><a href="#yue-du-zhi-qian" class="header-anchor">#</a></h2>
<h3><span id="ni-xu-yao-zhi-dao-de-zhi-shi-bao-gua">你需要知道的知识包括</span><a href="#ni-xu-yao-zhi-dao-de-zhi-shi-bao-gua" class="header-anchor">#</a></h3>
<ul>
<li>Hexo基本命令</li>
<li>Shell的使用</li>
<li>laTex的使用</li>
</ul>
<h3><span id="qian-zhi-de-yi-xie-huan-jing">前置的一些环境</span><a href="#qian-zhi-de-yi-xie-huan-jing" class="header-anchor">#</a></h3>
<ul>
<li>Node.js</li>
<li>Linux shell/ macOS shell</li>
</ul>
<h2><span id="dui-hexo-xiang-mu-jin-xing-xiu-gai">对Hexo项目进行修改</span><a href="#dui-hexo-xiang-mu-jin-xing-xiu-gai" class="header-anchor">#</a></h2>
<h3><span id="yi-lai-an-zhuang">依赖安装</span><a href="#yi-lai-an-zhuang" class="header-anchor">#</a></h3>
<p>首先进入到Hexo项目的根目录中，运行 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-math hexo-renderer-pandoc #当你使用npm时</span><br><span class="line"><span class="meta">#</span><span class="bash"> or</span></span><br><span class="line">yarn add hexo-math hexo-renderer-pandoc #当你使用yarn时</span><br></pre></td></tr></table></figure></p>
<h3><span id="pei-zhi-wen-jian-de-xiu-gai">配置文件的修改</span><a href="#pei-zhi-wen-jian-de-xiu-gai" class="header-anchor">#</a></h3>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#插件</span></span><br><span class="line"><span class="attr">markdown:</span></span><br><span class="line">  <span class="attr">plugins:</span></span><br><span class="line">    <span class="string">....</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hexo-math</span> <span class="comment">#增加</span></span><br><span class="line"><span class="string">.....</span></span><br><span class="line"><span class="comment"># 增加这一配置MathJax</span></span><br><span class="line"><span class="attr">math:</span></span><br><span class="line">  <span class="attr">engine:</span> <span class="string">&#x27;mathjax&#x27;</span></span><br><span class="line">  <span class="attr">mathjax:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML</span></span><br></pre></td></tr></table></figure>
<h2><span id="xi-tong-ming-ling-an-zhuang">系统命令安装</span><a href="#xi-tong-ming-ling-an-zhuang" class="header-anchor">#</a></h2>
<p>需要安装<code>pandoc</code>命令，用以支持LaTex的解析
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brew install pandoc #当你使用macOS时</span><br><span class="line"><span class="meta">#</span><span class="bash"> or</span></span><br><span class="line">sudo apt-get install pandoc #当你使用ubuntu时</span><br></pre></td></tr></table></figure></p>
<h2><span id="chang-shi-gou-jian">尝试构建</span><a href="#chang-shi-gou-jian" class="header-anchor">#</a></h2>
<p>如果已经构建过项目，请先进入项目根目录下运行，清除缓存
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo clean</span><br></pre></td></tr></table></figure></p>
<p>然后进行正常的hexo的生成和测试 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo g &amp; hexo s</span><br></pre></td></tr></table></figure></p>
测试LaTex，应能得到图1.1 <code>
<pre>
$$
\begin&#123;align*&#125;
len = \sqrt&#123;(X_&#123;Split_&#123;m&#125;&#125;-X_&#123;SP&#125;)^&#123;2&#125;+(Y_&#123;Split_&#123;m&#125;&#125;-Y_&#123;SP&#125;)^&#123;2&#125;&#125;\\
\\
\theta = \arctan \frac&#123;X_&#123;Split_&#123;m&#125;&#125;&#125;&#123;Y_&#123;Slit_&#123;m&#125;&#125;&#125;\\
\\
Y_&#123;offset&#125; = len·\cos \theta \\
\\
C1=(X_&#123;Split_&#123;m&#125;&#125;,Y_&#123;Split_&#123;m&#125;&#125;-len)\\
C2=(X_&#123;Split_&#123;m&#125;&#125;,Y_&#123;Split_&#123;m&#125;&#125;+len)
\end&#123;align*&#125;
$$
  </pre>
</code>
<div style="display:flex;justify-contnet:center;align-items:center;flex-direction: column;">
<img width="300px" src="/images/equations.png">
<p>
图1.1
</p>
</div>
</p>
      <div class="post-button"><a class="btn" href="/Hexo%E7%9A%84%E4%B8%80%E4%BA%9B%E5%A2%9E%E5%BC%BA--%E6%B8%B2%E6%9F%93Latex%E5%85%AC%E5%BC%8F.html" rel="noopener"><i class="fa fa-angle-double-right fa-fw"></i>Read More</a></div>
    </div>
  </div>
  <div class="lx-entry padding">
    <div>
      <h2 class="title"><a href="/%E5%B7%A5%E7%A8%8B%E5%B8%88%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98.html">工程师遇到的一些问题</a></h2>
      <span class="lx-post-detail"><i class="fa fa-calendar-o"></i> 2021-09-02 | <i class="fa fa-folder-o"></i> <a class="category-link" href="/categories/interesting/">interesting</a></span>
      <p><p>The lesson I have learned in decades of dealing with software related
companies of all sizes is that you have a personality and financial
problem.</p>
<p>That is, few companies are run by actual engineers. They are run by
bean counters, lawyers, CFOs, marketing, etc. These people don't "get"
programmers, engineers, etc. They don't like them, understand them, get
along with them, or even have many overlapping interests. The reverse is
also largely true.</p>
<p>For example if you go to a large financial institution you will find
the C-Suite on the 28th floor with a view over the water while the IT
people who build the algos that run the company are in a windowless part
of some dungeon. Or if you go to a engineering company the engineers
will be open plan with crap lights, chairs, desks, and dividers while
the executives all have their own individual offices.</p>
<p>Thus, the executives start hiring people kind of like themselves to
"interface" with the "weirdo" engineers. Thus was born things like the
PM with a PMP, the product managers, etc.</p>
<p>These people are under pressure from the executive to do things one
way, while the creators really should do things a different way. But
this is a hierarchy. This isn't a negotiation, this isn't a system that
is keen on feedback. The executives decide and the engineers are
supposed to execute. They really don't like the engineers when they say
things like, "That deadline is impossible. You can pick quick or you can
good, but you don't get both." That is the sort of thing that drives an
executive to a rage. They put in their quarterly plan that they were
going to deliver good and cheap, how dare the engineer be so defeatist.
The worst executives whine endlessly about how engineers will never give
a proper answer to when something that involves lots of R&amp;D done.
They start droning on about boring things like all the unknowns. Again,
that executive made a presentation to the board about how the next
version of the product would have twice the battery life at half the
cost. Is the entire engineering department conspiring to make him a
liar?</p>
<p>Then you have internal politics. This sort of thing happens even at
the level of a lemonade stand, but once you have a company with 100 or
100,000 people politics is going to rule the executive level. A critical
part of office politics is to control information. Thus you get an
absolute rule that the engineering types are to be kept as far away from
the customer as possible. Information such as the project is going to be
late is not something that almost anyone at any management or higher
level wants anyone anyone at any other management or higher level to
know.</p>
<p>This sort of secrecy then allows grasping managers and executives to
whip, threaten, make empty promises, etc to the engineers to get them to
work evenings, weekends, etc all to meet some BS targets, except those
targets will get various executives bonuses that are multiples of an
engineer's salary, where they then magnanimously take the engineers out
for a big pile of pizza or an all you can eat buffet. "on the company's
dime" that might work out to $20 engineer while that manager gets a 50k
bonus that quarter alone largely because of the foolish engineers who
were preached at about company loyalty and dedication.</p>
<p>But where this all breaks down is that you have a number of typically
very very smart engineers, developers, researchers, etc, who find
themselves micromanaged by people who are given a higher level of
authority but who drop the responsibility to the engineers. Yet the
engineers aren't allowed to communicate with the customers so they don't
really know the problem, they get arbitrary deadlines handed to them.
They don't get to prioritize. And worst of all the people who are
typically higher up from managers tend to be morons as this is often a
BS job that most people with two brain cells to rub together would
reject. Sometimes the managers are former engineers but this is where
the whole peter principle/fail up thing exists.</p>
<p>Even in huge "respected" organizations like NASA and Boeing you hear
stories where engineers are saying. If you do X then Y will blow up and
kill lots of people. Then some manager overrides them as they are afraid
to say no to their higher ups and so on to meet some arbitrary deadline
for building something that the engineers who will build it had no input
on the top down design which is basically crap.</p>
<p>The pattern that I see and suspect even exists at places like NASA is
that what happens is that very very smart engineers succeed despite all
the terrible obstacles put in their way. Instead of good solid planning
(not paperwork, but actual planning) they probably are fighting one fire
after another while slipping some good engineering into the projects
when the managers aren't looking.</p>
<p>Then just as any engineers are achieving something resembling success
they get a copy of the payroll and realize the project manager who has
less business experience or education than your average dishwasher but
did get their PMP is paid twice what they are paid. Moral just went to
zero and now your engineers come in at 9am and leave exactly at 5pm and
don't answer calls on weekends anymore. Don't tell them that the CEO of
the 50 person engineering firm's has a travel and entertainment budget
that is 3 to 6 times their annual salary, the COO has one that is 3
times, and that the CFO just got his 50k MBA paid for by the company
while they can no longer expense a weekend course in town attended on
their own time to get certified on a key technology the company is using
in their next project.</p>
<p>Why this last set of disparities? The executives are where the money
decisions are made and the engineering department is not.</p>
<p>One of the interesting bits is that what I see on a very regular
basis is where those extraordinary developers engineers etc go is into
business for themselves. They usually develop some product on their own
that would have made the company millions but they do it on their own
and usually without hiring any managers at all. Their old companies
don't even realize what they lost as the lying and cheating of the
managers and executives will never acknowledge their mistake but will
just blame the defenseless and work the remaining engineers even
harder.</p>
<p>If I had to boil it down to a pair of lines:</p>
<p>Management usually hates engineering because they are significantly
smarter and less disposable than the management themselves; thus in
their insecurity they use their control of the finances to be right
bullies.</p>
<details>
<summary>
中文
</summary>
<p>在几十年与各种规模的软件相关公司打交道的过程中，我学到的经验是，你们有一个人格和财务问题。</p>
<p>也就是说，很少有公司是由真正的工程师管理的。他们都是由数学家、律师、首席财务官、营销人员等管理。这些人并不
"了解
"程序员、工程师等。他们不喜欢他们，不理解他们，不与他们相处，甚至没有许多重叠的利益。反过来说也是大体如此。</p>
<p>例如，如果你去一家大型金融机构，你会发现C-Suite在28楼，可以看到水面上的风景，而构建运行公司的算法的IT人员则在某个地牢的无窗部分。或者，如果你去一家工程公司，工程师们将是开放式的，有垃圾灯、椅子、桌子和隔板，而高管们都有自己的独立办公室。</p>
<p>因此，高管们开始雇用与自己相似的人与 "怪异 "的工程师们
"沟通"。因此，像拥有PMP的PM、产品经理等就诞生了。</p>
<p>这些人在高管的压力下，以一种方式做事，而创造者确实应该以另一种方式做事。但这是一个等级制度。这不是一个谈判，这不是一个热衷于反馈的系统。高管们决定，工程师们应该执行。他们真的不喜欢工程师说这样的话："这个期限是不可能的。你可以选择快，也可以选择好，但你不可能两者兼得。"
这就是那种会让高管发怒的事情。他们在季度计划中说他们要提供好的和便宜的，工程师怎么敢这么失败。最糟糕的高管们没完没了地抱怨，工程师们永远不会对涉及大量研发工作的事情给出一个合适的答案。他们开始喋喋不休地谈论无聊的事情，比如所有的未知数。同样，这位高管向董事会做了一个关于下一版本的产品如何以一半的成本拥有两倍的电池寿命的报告。难道整个工程部门都在密谋让他成为一个骗子？</p>
<p>然后你有内部政治。这种事情甚至发生在一个柠檬水摊的层面上，但是一旦你有一个拥有100或100,000人的公司，政治就会统治行政层面。办公室政治的一个关键部分是控制信息。因此，你会得到一个绝对的规则，即工程类人员要尽可能远离客户。诸如项目要迟到这样的信息，几乎是任何管理层或更高层次的人都不愿意让任何其他管理层或更高层次的人知道的。</p>
<p>这种保密性使得那些抓狂的经理和高管们可以对工程师进行鞭打、威胁、做出空洞的承诺等，让他们在晚上、周末等时间工作，以达到一些虚假的目标，只是这些目标会让不同的高管获得数倍于工程师工资的奖金，然后他们会宽宏大量地带工程师去吃一大堆比萨饼或所有你能吃的自助餐。"用公司的钱"，这可能是20美元的工程师，而该经理在那个季度获得了5万奖金，主要是因为那些被宣扬为对公司忠诚和奉献的愚蠢的工程师。</p>
<p>但是，这一切的破绽在于，你有一些通常非常聪明的工程师、开发人员、研究人员等，他们发现自己被那些被赋予更高权力的人微观管理，但他们把责任丢给工程师。然而，工程师们不被允许与客户沟通，所以他们并不真正了解问题，他们得到了任意的最后期限。他们不能确定优先次序。最糟糕的是，那些通常是经理以上级别的人往往是白痴，因为这往往是一个BS工作，大多数有两个脑细胞的人都会拒绝。有时经理是前工程师，但这是整个彼得原则/失败的事情存在的地方。</p>
<p>即使在像NASA和波音这样巨大的 "受人尊敬的
"组织中，你也会听到工程师说的故事。如果你做了X，那么Y将被炸毁，并杀死很多人。然后一些经理推翻了他们，因为他们害怕对他们的上级说
"不"，等等，以满足一些任意的最后期限来建造一些东西，而建造这些东西的工程师对自上而下的设计没有任何意见，这些设计基本上是垃圾。</p>
<p>我所看到的，甚至怀疑存在于像美国国家航空航天局这样的地方的模式是，尽管有所有可怕的障碍，非常聪明的工程师还是成功了。他们没有良好的坚实的规划（不是纸上谈兵，而是实际的规划），他们可能是在一个又一个的火灾中战斗，同时在经理们不注意的时候把一些好的工程塞进项目中。</p>
<p>然后，就在任何工程师取得类似成功的时候，他们得到了一份工资单，并意识到项目经理的商业经验或教育程度比你的普通洗碗工要低，但确实得到了PMP，他的工资是他们的两倍。士气降到了零，现在你的工程师早上9点上班，下午5点下班，周末也不接电话了。不要告诉他们，50人的工程公司的首席执行官的旅行和娱乐预算是他们年薪的3到6倍，首席运营官的预算是3倍，首席财务官刚刚拿到公司支付的5万块钱的MBA，而他们却不能再花钱在城里用自己的时间参加周末课程，以获得公司在下一个项目中使用的关键技术的认证。</p>
<p>为什么会出现这样的差异？高管们是做出金钱决定的地方，而工程部门则不是。</p>
<p>有趣的一点是，我经常看到的是，那些非凡的开发人员、工程师等人的去处是为自己做生意。他们通常自己开发一些产品，而这些产品本来可以为公司带来数百万的收入，但他们自己做，而且通常根本没有雇用任何经理。他们的老公司甚至没有意识到他们失去了什么，因为那些撒谎和欺骗的经理和高管永远不会承认他们的错误，而只是责怪那些毫无防备的人，让剩下的工程师更加努力工作。</p>
<p>如果我不得不把它归结为一对线。</p>
<p>管理层通常讨厌工程人员，因为他们明显比管理层自己更聪明，更不容易支配；因此在他们的不安全感中，他们利用对财务的控制权来做正确的欺凌者。</p>
</details>
</p>
      <div class="post-button"><a class="btn" href="/%E5%B7%A5%E7%A8%8B%E5%B8%88%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98.html" rel="noopener"><i class="fa fa-angle-double-right fa-fw"></i>Read More</a></div>
    </div>
  </div>
  <div class="lx-entry padding">
    <div>
      <h2 class="title"><a href="/%E7%BB%98%E5%88%B6%E5%B9%B3%E6%BB%91%E7%9A%84%E4%B8%89%E6%AC%A1%E8%B4%9D%E5%A1%9E%E5%B0%94%E6%9B%B2%E7%BA%BF.html">绘制平滑的三次贝塞尔曲线</a></h2>
      <span class="lx-post-detail"><i class="fa fa-calendar-o"></i> 2021-08-21 | <i class="fa fa-folder-o"></i> <a class="category-link" href="/categories/project/">project</a></span>
      <p><p><img src="/images/ezgif.com-gif-maker.gif"></p>
<div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#ji-chu-zhi-shi">基础知识</a></li>
<li><a href="#mian-lin-de-wen-ti">面临的问题</a>
<ul>
<li><a href="#1-xuan-ze-er-ci-bei-sai-er-qu-xian-or-san-ci-bei-sai-er-qu-xian">1.
选择二次贝塞尔曲线 or 三次贝塞尔曲线</a></li>
<li><a href="#2-bei-sai-er-qu-xian-kong-zhi-dian-ji-suan">2.
贝塞尔曲线控制点计算</a></li>
</ul></li>
<li><a href="#wen-ti-fen-xi">问题分析</a>
<ul>
<li><a href="#wen-ti-1">问题1：</a></li>
<li><a href="#wen-ti-2">问题2：</a></li>
</ul></li>
<li><a href="#dai-ma-bu-fen">代码部分</a></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="ji-chu-zhi-shi">基础知识</span><a href="#ji-chu-zhi-shi" class="header-anchor">#</a></h2>
<p>阅读之前你需要知道的知识包括</p>
<ul>
<li>canvas的坐标系</li>
<li>直角坐标中两点的中点公式</li>
<li>直角坐标中两点距离公式</li>
<li>基础的三角函数</li>
<li>投影基础知识</li>
<li>canvas绘制贝塞尔曲线</li>
</ul>
<h2><span id="mian-lin-de-wen-ti">面临的问题</span><a href="#mian-lin-de-wen-ti" class="header-anchor">#</a></h2>
<h3><span id="1-xuan-ze-er-ci-bei-sai-er-qu-xian-or-san-ci-bei-sai-er-qu-xian">1. 选择二次贝塞尔曲线 or
三次贝塞尔曲线</span><a href="#1-xuan-ze-er-ci-bei-sai-er-qu-xian-or-san-ci-bei-sai-er-qu-xian" class="header-anchor">#</a></h3>
<h3><span id="2-bei-sai-er-qu-xian-kong-zhi-dian-ji-suan">2. 贝塞尔曲线控制点计算</span><a href="#2-bei-sai-er-qu-xian-kong-zhi-dian-ji-suan" class="header-anchor">#</a></h3>
<h2><span id="wen-ti-fen-xi">问题分析</span><a href="#wen-ti-fen-xi" class="header-anchor">#</a></h2>
<h3><span id="wen-ti-1">问题1：</span><a href="#wen-ti-1" class="header-anchor">#</a></h3>
<p>由于二次贝塞尔曲线绘制后，将只有一处弯曲，在多节点连接时，呈现效果很差。并且在45°，135°，225°，315°时，需要做特殊的处理，否侧得到的曲线的弧度过大。</p>
<h3><span id="wen-ti-2">问题2：</span><a href="#wen-ti-2" class="header-anchor">#</a></h3>
<p>在确定使用三次贝塞尔曲线后，需要通过计算得出曲线绘制时的两个控制点C1,C2。然后通过<code>CanvasRenderingContext2D.bezierCurveTo</code>进行绘制。</p>
<p>由于我们需要两个控制点，所以，我们将会把起点<strong>SP(start
point)</strong>和终点<strong>EP(end
point)</strong>间的连线<strong>S-E</strong>均分为4份。得到如下点： <span class="math display">\[
\begin{align*}
Split_{m} = (\frac{(X_{SP}+X_{EP})}2,\frac{(Y_{SP}+Y_{EP})}2)\\
\end{align*}
\]</span> 得到S-E的公式L(x)为 <span class="math display">\[
L(x) = \frac{X_{Split_{m}}}{Y_{Slit_{m}}}x
\]</span> 根据L(x)可知S-E的斜率满足 <span class="math display">\[
\tan \theta = \frac{X_{Split_{m}}}{Y_{Slit_{m}}}
\]</span> 然后将<span class="math inline">\(Split_{m}\)</span>作为坐标系的原点，建立直角坐标系，得到
<span class="math display">\[
\begin{align*}
len = \sqrt{(X_{Split_{m}}-X_{SP})^{2}+(Y_{Split_{m}}-Y_{SP})^{2}}\\
\\
\theta = \arctan \frac{X_{Split_{m}}}{Y_{Slit_{m}}}\\
\\
Y_{offset} = len·\cos \theta \\
\\
C1=(X_{Split_{m}},Y_{Split_{m}}-len)\\
C2=(X_{Split_{m}},Y_{Split_{m}}+len)
\end{align*}
\]</span></p>
<h2><span id="dai-ma-bu-fen">代码部分</span><a href="#dai-ma-bu-fen" class="header-anchor">#</a></h2>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>props </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@typeof </span>props &#123;</span></span><br><span class="line"><span class="comment">		start: number[];</span></span><br><span class="line"><span class="comment">		end: number[];</span></span><br><span class="line"><span class="comment">		canvas: CanvasRenderingContext2D;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> drawLine = <span class="function">(<span class="params">props: Common.LineProps</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">const</span> &#123; start, end, <span class="attr">canvas</span>: ctx, color &#125; = props;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> getMidCoord = <span class="function">(<span class="params">c1: <span class="built_in">number</span>, c2: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (c1 === c2) &#123;</span><br><span class="line">			<span class="keyword">return</span> c1;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (c1 + c2) / <span class="number">2</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> [x1, y1] = start;</span><br><span class="line">	<span class="keyword">const</span> [x2, y2] = end;</span><br><span class="line">	<span class="keyword">const</span> [midX, midY] = [getMidCoord(x1, x2), getMidCoord(y1, y2)];</span><br><span class="line">	<span class="keyword">const</span> drawMirror = <span class="function">(<span class="params">y1: <span class="built_in">number</span>, y2: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (y1 &gt; y2) &#123;</span><br><span class="line">			<span class="keyword">return</span> ctx.bezierCurveTo(control2[<span class="number">0</span>], control2[<span class="number">1</span>], control1[<span class="number">0</span>], control1[<span class="number">1</span>], end[<span class="number">0</span>], end[<span class="number">1</span>]);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> ctx.bezierCurveTo(control1[<span class="number">0</span>], control1[<span class="number">1</span>], control2[<span class="number">0</span>], control2[<span class="number">1</span>], end[<span class="number">0</span>], end[<span class="number">1</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">const</span> degCos = <span class="built_in">Math</span>.cos(<span class="built_in">Math</span>.atan((x1 - midX) / (y1 - midY)));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> lineLen = <span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow(y1 - midY, <span class="number">2</span>) + <span class="built_in">Math</span>.pow(x1 - midX, <span class="number">2</span>)) * <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> control1 = [midX, midY - degCos * (lineLen / <span class="number">2</span>)];</span><br><span class="line">	<span class="keyword">const</span> control2 = [midX, midY + degCos * (lineLen / <span class="number">2</span>)];</span><br><span class="line"></span><br><span class="line">	ctx.beginPath();</span><br><span class="line">	ctx.moveTo(start[<span class="number">0</span>], start[<span class="number">1</span>]);</span><br><span class="line">	drawMirror(y1, y2);</span><br><span class="line">	ctx.lineWidth = <span class="number">2</span>;</span><br><span class="line">	ctx.strokeStyle = color ? color : <span class="string">&quot;#000&quot;</span>;</span><br><span class="line">	ctx.stroke();</span><br><span class="line">	ctx.closePath();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</p>
      <div class="post-button"><a class="btn" href="/%E7%BB%98%E5%88%B6%E5%B9%B3%E6%BB%91%E7%9A%84%E4%B8%89%E6%AC%A1%E8%B4%9D%E5%A1%9E%E5%B0%94%E6%9B%B2%E7%BA%BF.html" rel="noopener"><i class="fa fa-angle-double-right fa-fw"></i>Read More</a></div>
    </div>
  </div>
  <div class="lx-entry padding">
    <div>
      <h2 class="title"><a href="/%E9%AB%98%E6%80%A7%E8%83%BD%E5%88%86%E7%BB%84%E5%88%97%E8%A1%A8%E8%AE%BE%E8%AE%A1-2.html">高性能分组列表设计-2</a></h2>
      <span class="lx-post-detail"><i class="fa fa-calendar-o"></i> 2021-07-30 | <i class="fa fa-folder-o"></i> <a class="category-link" href="/categories/project/">project</a></span>
      <p><div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#tong-guo-gai-bian-lie-biao-xiang-wei-zhi-geng-xin-fen-zu-guan-xi">通过改变列表项位置更新分组关系</a></li>
<li><a href="#yao-jie-jue-de-wen-ti">要解决的问题</a></li>
<li><a href="#fen-xi">分析</a></li>
<li><a href="#shi-xian">实现</a></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="tong-guo-gai-bian-lie-biao-xiang-wei-zhi-geng-xin-fen-zu-guan-xi">通过改变列表项位置更新分组关系</span><a href="#tong-guo-gai-bian-lie-biao-xiang-wei-zhi-geng-xin-fen-zu-guan-xi" class="header-anchor">#</a></h2>
<p><img width="300px" src="/images/moveGroup.png"></p>
<h2><span id="yao-jie-jue-de-wen-ti">要解决的问题</span><a href="#yao-jie-jue-de-wen-ti" class="header-anchor">#</a></h2>
<ul>
<li>移动分组时，分组所有的子项都要移动，且保持相对位置和关系不变</li>
<li>批量移动未分组列表项到分组内时，相对位置应不变</li>
<li>已分组列表项移动出分组范围时应，应解除分组关系</li>
</ul>
<h2><span id="fen-xi">分析</span><a href="#fen-xi" class="header-anchor">#</a></h2>
<p>当分组移动时，所有分组的子项都不变，首先需要搜索到分组内所有的子项。然后记录该子项在分组内的相对位置，以及在整体列表中的位置。
这样在移动时，方便进行计算。</p>
<p>整体来讲，这个移动过程中的搜索部分将使用<strong>深度优先搜索</strong>的一种变种。移动后的排序，只需遵守搜索中分组和其子项的相对顺序遍历即可。</p>
<p>分组子项搜索流程如下： <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!groupCache.includes(hasGroup)) &#123;</span><br><span class="line">      <span class="comment">//组件的分组不在查询的分组内。弹出所有的分组缓存</span></span><br><span class="line">      groupCache = [];</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result.push(item); <span class="comment">//组件的分组在分组缓存中</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (hasGroup !== groupCache[groupCache.length - <span class="number">1</span>]) &#123;</span><br><span class="line">        <span class="comment">// 如果组件的分组不在缓存的顶层</span></span><br><span class="line">        <span class="keyword">const</span> hasGroupCacheIndex = groupCache.indexOf(hasGroup);</span><br><span class="line">        groupCache = groupCache.slice(<span class="number">0</span>, hasGroupCacheIndex + <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (compDatas[item].compCode === <span class="string">&#x27;group&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// 组件本身是分组组件</span></span><br><span class="line">        groupCache.push(item);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>列表项排序流程如下： <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * compDatas 所有的列表项&#123;[code]:&#123; config: &#123; [groupCode]:groupCode &#125; &#125; &#125;</span></span><br><span class="line"><span class="comment">  * topLestSelectComps 和第一个要移动的列表项在同级的组件（处理批量移动的情况），数据结构与compDatas一致</span></span><br><span class="line"><span class="comment">  * nearLowBoundsGroup 将要移动列表项所在的分组的下界，数据结构与compDatas一致</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (isToplest) &#123;</span><br><span class="line">    <span class="comment">//如果移动位置在插入区间的顶部，表明组件在最外层</span></span><br><span class="line">    topLestSelectComps.forEach(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">      </span><br><span class="line">      result[item] = &#123; <span class="attr">newGroup</span>: <span class="literal">undefined</span>, <span class="attr">oldGroup</span>: compDatas[item].config.groupCode &#125;;</span><br><span class="line">      <span class="keyword">return</span> (compDatas[item].config.groupCode = <span class="literal">undefined</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (nearLowBoundsGroup !== firstCompPrev) &#123;</span><br><span class="line">    <span class="comment">//如果移动位置的下界的分组code不等于移动组件的code，则解除或更新分组关系</span></span><br><span class="line">    topLestSelectComps.forEach(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (item !== nearLowBoundsGroup) &#123;</span><br><span class="line">        result[item] = &#123; <span class="attr">newGroup</span>: nearLowBoundsGroup, <span class="attr">oldGroup</span>: compDatas[item].config.groupCode &#125;;</span><br><span class="line">        compDatas[item].config.groupCode = nearLowBoundsGroup;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result[item] = &#123; <span class="attr">newGroup</span>: compDatas[item].config.groupCode, <span class="attr">oldGroup</span>: compDatas[item].config.groupCode &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h2><span id="shi-xian">实现</span><a href="#shi-xian" class="header-anchor">#</a></h2>
<details>
<summary>
分组子项查询详细代码
</summary>
<pre>
    <code>

    interface GroupConfigStruct &#123;
      groupItemCode: string[];
    &#125;

    interface groupMapValueStruct &#123;
      //分组内组件相对于分组索引的偏移量
      offsetNumer: number;
      //分组的索引
      currentIndex: number;
    &#125;

    /**
    *根据分组关系排序一维数组
    *@param compCodes 所有组件的code
    *@param compDatas 所有组件的数据
    */
    const sortListItem = (compCodes: string[], compDatas: JDV.State['compDatas']) => &#123;
      const groupCodeCache = new Map<string, groupmapvaluestruct>();
      const result: string[] = [];

      /**
      *递归的回溯当前分组的前驱分组，更新前驱分组的长度偏移量
      *@param groupCode 分组组件的code
      *@param offsetNumber 分组长度的偏移量
      */
      const recursiveBacktracking = (groupCode: string, offsetNumber: number): null => &#123;
        const parentGroupCode = compDatas[groupCode].config.groupCode;
        const belongGroup = groupCodeCache.get(groupCode) as groupMapValueStruct;
        groupCodeCache.set(groupCode, &#123;
          //更新分组缓存，每此插入组件，偏移量+1
          ...belongGroup,
          offsetNumer: belongGroup.offsetNumer + 1,
        &#125;);
        if (parentGroupCode) &#123;
          // 如果分组有父分组，回溯一步
          return recursiveBacktracking(parentGroupCode, offsetNumber + 1);
        &#125; else &#123;
          return null;
        &#125;
      &#125;;
      compCodes.forEach((item, index) => &#123;
        const group = compDatas[item].config.groupCode ? compDatas[item].config.groupCode : null;
        if (compDatas[item].compCode === 'group') &#123;
          //如果组件是分组组件，将code推入分组缓冲内
          groupCodeCache.set(item, &#123; offsetNumer: 0, currentIndex: index &#125;);
        &#125;
        if (group) &#123;
          //在分组内
          if (groupCodeCache.has(group)) &#123;
            // 组件的分组在缓存中
            const belongGroup = groupCodeCache.get(group) as groupMapValueStruct;

            // 分组内组件插入的位置
            const targetIndex = belongGroup.currentIndex + belongGroup.offsetNumer;

            result.splice(targetIndex + 1, 0, item);
            recursiveBacktracking(group, belongGroup.offsetNumer);
          &#125;
        &#125; else &#123;
          result.push(item);
        &#125;
      &#125;);
      return result;
    &#125;;

    export default sortListItem;
    </string,></code>
  </pre>
</details>
<details>
<summary>
分组移动后排序详细代码
</summary>
<pre>
    <code>
    /**
 * 组件排序时处理分组的逻辑。
 * @param compCodes 所有组件的code
 * @param compDatas 所有组件的数据
 * @param code 当前组件code
 * @param destination 目标位置
 * @returns result &#123;Result&#125; 返回组件排序后的分组关系，用于分组关系变化后，处理分组的尺寸。
 */
export const groupResort = (
  compCodes: string[],
  selectedCompCodes: string[],
  compDatas: JDV.State['compDatas'],
  destination: number
): Result => &#123;
  const isToplest = destination === 0;
  const isBottomlest = destination + 1 === compCodes.length - 1;
  const lowBounds = isBottomlest ? compCodes.length - 1 : destination + 1;
  const interval = compCodes.slice(0, lowBounds); //插入区间
  const intervalLastComp = compDatas[compCodes[lowBounds]];
  const nearLowBoundsGroup = interval.find((item) => intervalLastComp && item === intervalLastComp.config.groupCode); //插入区间最下面的分组段
  const firstCompPrev = compDatas[selectedCompCodes[0]] && compDatas[selectedCompCodes[0]].config.groupCode; // 第一个选中组件的分组
  const topLestSelectComps = selectedCompCodes.filter((item) => compDatas[item].config.groupCode === firstCompPrev); // 和第一个选中在同级的所有选中组件
  const result: Result = &#123;&#125;;

  if (isToplest) &#123;
    //如果移动位置在插入区间的顶部，表明组件在最外层
    topLestSelectComps.forEach((item) => &#123;
      result[item] = &#123; newGroup: undefined, oldGroup: compDatas[item].config.groupCode &#125;;
      return (compDatas[item].config.groupCode = undefined);
    &#125;);

    return result;
  &#125;
  if (nearLowBoundsGroup !== firstCompPrev) &#123;
    //如果移动位置的下界的分组code不等于移动组件的code，则解除或更新分组关系
    topLestSelectComps.forEach((item) => &#123;
      if (item !== nearLowBoundsGroup) &#123;
        result[item] = &#123; newGroup: nearLowBoundsGroup, oldGroup: compDatas[item].config.groupCode &#125;;
        compDatas[item].config.groupCode = nearLowBoundsGroup;
      &#125; else &#123;
        result[item] = &#123; newGroup: compDatas[item].config.groupCode, oldGroup: compDatas[item].config.groupCode &#125;;
      &#125;
    &#125;);
    return result;
  &#125;
  return result;
&#125;;

    </code>
  </pre>
</details>
</p>
      <div class="post-button"><a class="btn" href="/%E9%AB%98%E6%80%A7%E8%83%BD%E5%88%86%E7%BB%84%E5%88%97%E8%A1%A8%E8%AE%BE%E8%AE%A1-2.html" rel="noopener"><i class="fa fa-angle-double-right fa-fw"></i>Read More</a></div>
    </div>
  </div>


<div id="pagination">
  <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"></a>
</div>

<footer>
  <div>
  Copyright &copy; 2022.<a href="/">Ashes Born's Blog</a><br>Powered by <a href="https://hexo.io" target="_blank">Hexo</a> | Theme <a href="https://lx.js.org" target="_blank">Lx</a><br>
  </div>
</footer>

  </div>
</div>
</div>

<button class="hamburger hamburger--arrow-r" type="button">
    <div class="hamburger-box">
      <div class="hamburger-inner"></div>
    </div>
</button> 
<div class="menu visibility">
  <div class="menu-head">
    <span class="layer">
      <div class="col">
        <div class="row for-pic">
          <div class="profile-pic">
            <a href="/"><img src="/images/avatar.jpeg" alt="Ashes Born"/></a>
          </div>
        </div>
        <div class="row for-name">
          <p>Ashes Born</p>
          <span class="tagline">切图仔 / 兴趣使然的数学学习者 @ cutaway man / Interest driven mathematics learners</span>
        </div>
      </div>
    </span>
  </div>
  <nav class="menu-container">
  <ul class="menu-items">
    <li><a href="/"><i class="fa fa-home fa-fw"></i>Home</a></li>
    <li><a href="/archives/"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
    <li class="has-sub"><span class="dropdown-heading">
      <i class="fa fa-th-list fa-fw"></i>Categories</span>
        <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/error/">error</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/interesting/">interesting</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/project/">project</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/typescript/">typescript</a></li></ul>
    </li>
    <li class="has-sub"><span class="dropdown-heading">
      <i class="fa fa-bookmark fa-fw"></i>Pages</span>
        <ul>
          <li><a href="/guestbook/">Guestbook</a></li>
        </ul>
    </li>
    <li class="has-sub"><span class="dropdown-heading">
      <i class="fa fa-link fa-fw"></i>Friends</span>
        <ul>
          <li> <a href="https://lx.js.org" target="_blank">Theme-Lx</a></li>
        <li> <a href="https://brightzoe.top" target="_blank">brightzoe-blog</a></li>
        <li> <a href="https://blog.miaya.art/" target="_blank">Kanno-blog</a></li>
        </ul>
    </li>
  </ul>
  </nav>
</div>

<div class="gototop js-top">
  <a href="#" class="js-gotop"><i class="fa fa-arrow-up"></i></a>
</div>
<script src="//cdn.jsdelivr.net/npm/theme-lx@0.3.9/source/js/jquery.easing.min.js"></script>
<script>
(function () {
	"use strict";
	var goToTop = function() {
		$(".js-gotop").on("click", function(event){
			event.preventDefault();
			$("html, body").animate({
				scrollTop: $("html").offset().top
			}, 500, "easeInOutExpo");
			return false;
		});
		$(window).scroll(function(){
			var $win = $(window);
			if ($win.scrollTop() > 200) {
				$(".js-top").addClass("active");
			} else {
				$(".js-top").removeClass("active");
			}
		});
	};
	$(function(){
		goToTop();
	});
}());
</script>


</body>
</html>
