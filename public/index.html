<!DOCTYPE html>
<html lang="zh">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme-color" content=#58b77a>
  <title>Ashes Born&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="Ashes Born">
  <meta name="keywords" content="fornt-end,react,node,raspberry,Linux,docker,java,javascript,algorithm">
  <meta name="description" content="Work & Life & learn">
  <meta name="msvalidate.01" content="6F7DDC508DB488CC48452C274A311AE5" />
  <script id="hexo-configurations">
  var CONFIG = {
    root: '/',
    theme: 'lx',
    version: '0.3.9',
    localsearch:{
      "enable": false,
      "trigger": "auto",
      "top_n_per_article": 1,
      "unescape": false,
      "preload": false
      },
    path: 'null'
  };
</script>

  <link rel="shortcut icon" href="/%5Bobject%20Object%5D">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/theme-lx@0.3.9/source/css/main.min.css">
  <style type="text/css">
    pre,
    code {
      font-family: 'Fira Code', monospace;
    }
    html {
      font-family: sans-serif;
    }
    body {
      font-family: sans-serif;
    }
    h1, h2, h3, h4, h5, figure {
      font-family: sans-serif;
    }
    .menu-container{
      font-family: sans-serif;
    }
  </style>

  <script src="//cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/theme-lx@0.3.9/source/js/jquery.jside.menu.js"></script>
	<script>
	$(document).ready(function(){
	$(".menu-container").jSideMenu({
	    jSidePosition: "position-right",
	    jSideSticky: true,
	    jSideSkin: "greenish",
	     });
	}); 
	</script>
  <!--Google_Analytics-->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-167566818-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-167566818-3');
</script>

  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Fira Code:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4895386423724168" crossorigin="anonymous"></script>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/rss2.xml" title="Ashes Born's Blog" type="application/rss+xml">
</head>
<body>
<div id="page">

<div id="lx-aside" style="background-image: url(//cdn.jsdelivr.net/npm/theme-lx@0.3.9/source/images/cover.jpeg)">
  <div class="overlay">
  <div class="featured">
    <div class="avatar"><a href="/"><img src="/images/avatar.jpeg"></a></div>
    <span>Ashes Born</span>
    <h1>Ashes Born's Blog</h1>
    <span>——心中有座观澜阁，土木付炬皆尘生</span>
    <div class="social-links">
    <a href="https://github.com/sadofriod" target="_blank"><i class="fa fa-github fa-fw"></i></a>
    <a href="/mailto:justlikeashes@gmail.com" target="_blank"><i class="fa fa-gmail fa-fw"></i></a>
    <a href="https://t.me/+2z2oR13xxPE4NDU1" target="_blank"><i class="fa fa-telegram fa-fw"></i></a>
</div>
  </div>
  </div>
</div>

<div id="lx-main-content">
  <div class="lx-post">

  <div class="lx-entry padding">
    <div>
      <h2 class="title"><a href="/%E5%A2%9E%E9%87%8F%E8%BF%90%E8%A1%8CE2E%E6%B5%8B%E8%AF%95.html">增量运行E2E测试</a></h2>
      <span class="lx-post-detail"><i class="fa fa-calendar-o"></i> 2022-08-08 | <i class="fa fa-folder-o"></i> <a class="category-link" href="/categories/project/">project</a></span>
      <p><p><img src="/images/e2e-testing-banner.png"></p>
<div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#ji-chu-zhi-shi">基础知识</a></li>
<li><a href="#yao-jie-jue-de-wen-ti">要解决的问题</a></li>
<li><a href="#wen-ti-chai-fen-fen-xi">问题拆分 &amp; 分析</a>
<ul>
<li><a href="#wen-ti-fen-xi">问题分析</a></li>
</ul></li>
<li><a href="#jie-jue-fang-an">解决方案</a>
<ul>
<li><a href="#huo-qu-yong-yu-dui-bi-de-ji-chu-commitid">获取用于对比的基础commitID</a></li>
<li><a href="#huo-qu-liang-ge-commit-zhi-jian-de-geng-xin">获取两个Commit之间的更新</a></li>
<li><a href="#zhi-yun-xing-geng-xin-de-wen-jian-bing-da-yin-yun-xing-guo-cheng-zhong-de-ri-zhi-xiao-xi">只运行更新的文件并打印运行过程中的日志消息</a></li>
</ul></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="ji-chu-zhi-shi">基础知识</span><a href="#ji-chu-zhi-shi" class="header-anchor">#</a></h2>
<p>阅读之前你需要知道的知识包括</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://katalon.com/resources-center/blog/end-to-end-e2e-testing">什么是E2E测试</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.cypress.io/guides/overview/why-cypress">E2E测试框架Cypress</a></li>
<li><code>Git</code>常用命令</li>
<li><code>nodejs</code>基础知识</li>
</ul>
<h2><span id="yao-jie-jue-de-wen-ti">要解决的问题</span><a href="#yao-jie-jue-de-wen-ti" class="header-anchor">#</a></h2>
<p>随着项目不断的迭代，新的功能在增加，旧的功能也逐渐被更新。这导致E2E测试的体量在不断的增大。
但是，我们的每次修改不一定会涉及所有的E2E测试。所以，我们是否可以做到只运行本次commit影响的E2E？</p>
<h2><span id="wen-ti-chai-fen-amp-fen-xi">问题拆分 &amp; 分析</span><a href="#wen-ti-chai-fen-amp-fen-xi" class="header-anchor">#</a></h2>
<p>我将问题拆分为下面几个子问题:</p>
<ol type="1">
<li>如何界定作为对比的基础commit</li>
<li>如何获取这个commit的id</li>
<li>如何获取本次commit和基础commit之间的更新</li>
<li>如何只运行更新的文件并打印运行过程中的日志消息</li>
</ol>
<h3><span id="wen-ti-fen-xi">问题分析</span><a href="#wen-ti-fen-xi" class="header-anchor">#</a></h3>
<ul>
<li><strong>对于问题1：</strong>
<ul>
<li>通常情况：一般我们需要对比的是本次<code>commit</code>和当前分支刚被创建出时的<code>commit</code>，这是由于，我们的分支一般会从最新的<code>master</code>分支获取，而<code>master</code>分支中的E2E在大部分情况下，都是已经被验证过的。</li>
<li>和特定commit对比：一些需要和特定<code>commit</code>做对比以排查特定更改，引起的bug时。这里特定的<code>commitID</code>，需要我们在commit
message中加入特定的内容，进行标记。</li>
<li>运行全部的E2E：项目正式更新至线上时，还是期待完整的E2E测试，能为我们带来高的可用性。这里运行全部的E2E，需要我们在commit
message中加入特定的内容，进行标记。</li>
</ul></li>
<li><strong>对于问题2和3：</strong>
使用<code>nodejs</code>的<code>child_process</code>模块调度<code>Git</code>命令，并使用正则的方式获取需要的内容。</li>
<li><strong>对于问题4：</strong>
使用<code>nodejs</code>的<code>child_process</code>模块调度<code>Cypress</code>命令，并将输出使用<code>Steam</code>进行实时输出</li>
</ul>
<h2><span id="jie-jue-fang-an">解决方案</span><a href="#jie-jue-fang-an" class="header-anchor">#</a></h2>
<h3><span id="huo-qu-yong-yu-dui-bi-de-ji-chu-commitid">获取用于对比的基础commitID</span><a href="#huo-qu-yong-yu-dui-bi-de-ji-chu-commitid" class="header-anchor">#</a></h3>
<ul>
<li><p><strong>对于通常情况使用</strong> <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">getBranchFirstCommitID</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt;(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// compare with master</span></span><br><span class="line">    <span class="title function_">exec</span>(<span class="string">&#x27;git cherry -v master&#x27;</span>, <span class="function">(<span class="params">err, data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="title function_">rej</span>(err);</span><br><span class="line">      <span class="keyword">const</span> dataArr = data.<span class="title function_">split</span>(<span class="string">&#x27;\n&#x27;</span>) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">      <span class="keyword">const</span> commitContent = dataArr[<span class="number">0</span>].<span class="title function_">split</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="title function_">res</span>(commitContent[<span class="number">1</span>]);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>对于和特定commit对比的情况使用</strong> <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">getCurrentCommit</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt;(<span class="function">(<span class="params">res, rej</span>) =&gt;</span></span><br><span class="line">    <span class="title function_">exec</span>(<span class="string">`git log -1`</span>, <span class="function">(<span class="params">err, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="title function_">rej</span>(stderr);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">res</span>(stdout);</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getCompareCommitID</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> commitContent = <span class="keyword">await</span> <span class="title function_">getCurrentCommit</span>();</span><br><span class="line">  <span class="keyword">const</span> regx = <span class="regexp">/\[Compare: (.+?)\]/</span>;</span><br><span class="line">  <span class="keyword">if</span> (!regx.<span class="title function_">test</span>(commitContent)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">getBranchFirstCommitID</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> resultArray = commitContent.<span class="title function_">match</span>(regx) <span class="keyword">as</span> <span class="title class_">RegExpMatchArray</span>;</span><br><span class="line">  <span class="keyword">return</span> resultArray[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
这里如果运行<code>getCompareCommitID</code>后，得到返回值为<code>'ALL'</code>的时候，就会运行所有的E2E测试了</p></li>
</ul>
<h3><span id="huo-qu-liang-ge-commit-zhi-jian-de-geng-xin">获取两个Commit之间的更新</span><a href="#huo-qu-liang-ge-commit-zhi-jian-de-geng-xin" class="header-anchor">#</a></h3>
<p><strong>这里我们约定，所有的E2E文件的路径中都会携带<code>cypress</code>这个字符</strong>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getDiffFlies</span> = (<span class="params">baseCommitID: <span class="built_in">string</span>, commitID: <span class="built_in">string</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt;(<span class="function">(<span class="params">res, rej</span>) =&gt;</span></span><br><span class="line">    <span class="title function_">exec</span>(<span class="string">`git diff --name-only <span class="subst">$&#123;baseCommitID&#125;</span> <span class="subst">$&#123;commitID&#125;</span>`</span>, <span class="function">(<span class="params">err, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="title function_">rej</span>(stderr);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">res</span>(stdout);</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getCommitID</span> = (<span class="params">index: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt;(<span class="function">(<span class="params">res, rej</span>) =&gt;</span></span><br><span class="line">    <span class="title function_">exec</span>(<span class="string">`git show HEAD~<span class="subst">$&#123;index&#125;</span> --pretty=format:&quot;%h&quot; --no-patch`</span>, <span class="function">(<span class="params">err, stdout</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="title function_">rej</span>(err);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">res</span>(stdout);</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//一些特殊的项目结构下，项目中可能存在多个子系统，所以这里需要匹配特定的路径</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getProjectDiffFiles</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> compareCommitID = <span class="keyword">await</span> <span class="title function_">getCompareCommitID</span>();</span><br><span class="line">    <span class="keyword">const</span> currentCommitID = <span class="keyword">await</span> <span class="title function_">getCommitID</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (compareCommitID === <span class="string">&#x27;ALL&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// it will run all tests</span></span><br><span class="line">      <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> diffFiles = (<span class="keyword">await</span> <span class="title function_">getDiffFlies</span>(currentCommitID, compareCommitID)).<span class="title function_">split</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> currentProjectDiffFile = diffFiles</span><br><span class="line">      .<span class="title function_">filter</span>(<span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;dir&#125; = <span class="title function_">parse</span>(file);</span><br><span class="line">        <span class="keyword">const</span> currentDirArr = __dirname.<span class="title function_">split</span>(sep);</span><br><span class="line">        <span class="keyword">const</span> currentDir = currentDirArr[currentDirArr.<span class="property">length</span> - <span class="number">2</span>] <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">        <span class="keyword">if</span> (dir.<span class="title function_">includes</span>(currentDir) &amp;&amp; dir.<span class="title function_">includes</span>(<span class="string">&#x27;cypress&#x27;</span>)) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">map</span>(<span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">join</span>(...file.<span class="title function_">split</span>(sep).<span class="title function_">slice</span>(<span class="number">2</span>)) <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    <span class="keyword">return</span> currentProjectDiffFile;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(error); <span class="comment">// eslint-disable-line</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;get commit id is fail&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h3><span id="zhi-yun-xing-geng-xin-de-wen-jian-bing-da-yin-yun-xing-guo-cheng-zhong-de-ri-zhi-xiao-xi">只运行更新的文件并打印运行过程中的日志消息</span><a href="#zhi-yun-xing-geng-xin-de-wen-jian-bing-da-yin-yun-xing-guo-cheng-zhong-de-ri-zhi-xiao-xi" class="header-anchor">#</a></h3>
<p>nodejs的child_process模块提供了多种方式运行命令，一般情况下使用exec，但由于exec的输出将会在命令完全运行后才输出，并且一般的CI中，都会设置每一步的响应时间。如果使用exec，有可能会由于E2E时间过长，导致超时。
所以，这里我使用spawn，它将会实时的输出命令的运行日志。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">testRunner</span> = (<span class="params">specPath: <span class="built_in">string</span>[]</span>) =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;It will run test&#x27;</span>, specPath.<span class="title function_">join</span>(<span class="string">&#x27;,&#x27;</span>)); <span class="comment">// eslint-disable-line</span></span><br><span class="line">  <span class="keyword">const</span> runner = <span class="title function_">spawn</span>(<span class="string">&#x27;cypress&#x27;</span>, [<span class="string">&#x27;run&#x27;</span>, <span class="string">&#x27;--headless&#x27;</span>, <span class="string">&#x27;--spec&#x27;</span>, specPath.<span class="title function_">join</span>(<span class="string">&#x27;,&#x27;</span>)]);</span><br><span class="line">  runner.<span class="property">stderr</span>.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (data) <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>()); <span class="comment">// eslint-disable-line</span></span><br><span class="line">  &#125;);</span><br><span class="line">  runner.<span class="property">stdout</span>.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>()); <span class="comment">// eslint-disable-line</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">main</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> testPath = <span class="keyword">await</span> <span class="title function_">getProjectDiffFiles</span>();</span><br><span class="line">  <span class="title function_">testRunner</span>(testPath);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>至此就完成了增量的运行E2E测试。</p>
</p>
      <div class="post-button"><a class="btn" href="/%E5%A2%9E%E9%87%8F%E8%BF%90%E8%A1%8CE2E%E6%B5%8B%E8%AF%95.html" rel="noopener"><i class="fa fa-angle-double-right fa-fw"></i>Read More</a></div>
    </div>
  </div>
  <div class="lx-entry padding">
    <div>
      <h2 class="title"><a href="/%20monorepo%E7%BB%93%E6%9E%84%E4%B8%8B%E5%90%AF%E5%8A%A8react%E9%A1%B9%E7%9B%AE%E5%B1%80%E9%83%A8%E7%83%AD%E6%9B%B4%E6%96%B0.html">monorepo结构下启动react项目局部热更新</a></h2>
      <span class="lx-post-detail"><i class="fa fa-calendar-o"></i> 2022-08-07 | <i class="fa fa-folder-o"></i> <a class="category-link" href="/categories/project/">project</a></span>
      <p><p><img src="/images/monorepo-react-banner.jpeg"></p>
<div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#ji-chu-zhi-shi">基础知识</a></li>
<li><a href="#yu-dao-de-wen-ti">遇到的问题</a></li>
<li><a href="#wen-ti-yuan-yin-fen-xi">问题原因&amp;分析</a></li>
<li><a href="#ru-he-jie-jue-wen-ti">如何解决问题？</a>
<ul>
<li><a href="#duo-zi-xiang-mu-dan-du-kai-fa-shi-ru-he-que-ding-react-ban-ben-yi-ji-ru-he-bao-zheng-zhu-xiang-mu-jia-zai-zi-xiang-mu-zuo-wei-zu-jian-shi-er-zhe-gong-yong-tong-yi-ge-react-shi-li">多子项目单独开发时，如何确定react版本，以及如何保证主项目加载子项目作为组件时，二者公用同一个react实例</a></li>
<li><a href="#kai-fa-shi-ru-he-chu-li-hu-xiang-cun-zai-yi-lai-zi-xi-tong">开发时，如何处理互相存在依赖子系统</a></li>
<li><a href="#wai-zhi-hua-jia-zai-react-react-dom-shi-hot-reload-shi-xiao">外置化加载react&amp;react-dom时，hot-reload失效</a></li>
</ul></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="ji-chu-zhi-shi">基础知识</span><a href="#ji-chu-zhi-shi" class="header-anchor">#</a></h2>
<p>阅读之前你需要知道的知识包括</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Monorepo">什么是monorepo</a></li>
<li><a target="_blank" rel="noopener" href="https://semaphoreci.com/blog/what-is-monorepo#monorepo-culture">monorepo的一些应用场景</a></li>
<li>webpack的配置的编写</li>
<li><a target="_blank" rel="noopener" href="https://pnpm.io/">什么是pnpm</a></li>
</ul>
<h2><span id="yu-dao-de-wen-ti">遇到的问题</span><a href="#yu-dao-de-wen-ti" class="header-anchor">#</a></h2>
<ol type="1">
<li>多子项目单独开发时，如何确定react版本？</li>
<li>如何保证主项目加载子项目作为组件时，二者公用同一个react实例？</li>
<li>开发时，如何处理互相存在依赖子系统？</li>
<li>外置化加载react&amp;react-dom时，hot-reload失效</li>
</ol>
<h2><span id="wen-ti-yuan-yin-amp-fen-xi">问题原因&amp;分析</span><a href="#wen-ti-yuan-yin-amp-fen-xi" class="header-anchor">#</a></h2>
<ul>
<li>为什么会引入问题[1]：这是因为使用用monorepo这个结构时，我们希望所有的子系统和主系统(系统的入口)，使用同一个react版本，以便系统整体的核心依赖的控制，并且减少多版本兼容带来的额外的bug。</li>
<li>为什么会引入问题[2]：
<ul>
<li>hooks的使用要求二者必须使用的是一个react实例</li>
<li>对于context，它的使用也依赖于同一react实例</li>
</ul></li>
<li>为什么会引入问题[3]：当我们同时满足问题[1]和[2]时，react和react-dom将不能被打包到一个bandle包中，所以在webpack层面，我们需要使用external，排除react。与此同时，由于主流的用于处理react热更新的插件，<a target="_blank" rel="noopener" href="https://github.com/pmmmwh/react-refresh-webpack-plugin">react-refresh-webpack-plugin</a>对于外置加载的react
core有严格的顺序要求，所以导致了热更新的失效</li>
</ul>
<h2><span id="ru-he-jie-jue-wen-ti">如何解决问题？</span><a href="#ru-he-jie-jue-wen-ti" class="header-anchor">#</a></h2>
<h3><span id="duo-zi-xiang-mu-dan-du-kai-fa-shi-ru-he-que-ding-react-ban-ben-yi-ji-ru-he-bao-zheng-zhu-xiang-mu-jia-zai-zi-xiang-mu-zuo-wei-zu-jian-shi-er-zhe-gong-yong-tong-yi-ge-react-shi-li">多子项目单独开发时，如何确定react版本，以及如何保证主项目加载子项目作为组件时，二者公用同一个react实例</span><a href="#duo-zi-xiang-mu-dan-du-kai-fa-shi-ru-he-que-ding-react-ban-ben-yi-ji-ru-he-bao-zheng-zhu-xiang-mu-jia-zai-zi-xiang-mu-zuo-wei-zu-jian-shi-er-zhe-gong-yong-tong-yi-ge-react-shi-li" class="header-anchor">#</a></h3>
<p>我们期待所有这个系统中，所有项目的react依赖都指向同一个react
core文件，这样在系统所有项目都构建完成后，react的版本就确定了下来，所以我们可以修改<code>webpack.config.js</code>和项目的HTML模版来达到这个目标：
对于<code>webpack.config.js</code>增加： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="attr">external</span>: [<span class="string">&#x27;react&#x27;</span>,<span class="string">&#x27;react-dom&#x27;</span>]</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
对于HTML模版（这里的具体语法，需要根据具体使用的模版解析器语法来）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;script data-tn=&quot;react-bundle&quot; type=&quot;text/javascript&quot; src=&quot;&#123;&#123;reactBundlePath | safe&#125;&#125;&quot;&gt;&lt;script&gt;</span><br><span class="line">&lt;script data-tn=&quot;react-dom-bundle&quot; type=&quot;text/javascript&quot; src=&quot;&#123;&#123;reactDomBundlePath | safe&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>这里的 <code>reactBundlePath</code> 和
<code>reactDomBundlePath</code>是react单独编译后的结果，对应的是两个js文件。</p>
<p>至此react
core就完成外置化，所有的子项目在单独开发时，都可以修改自己的HTML模版，以使用公共的react
core，并且主系统和子系统的react实例始终一直，在</p>
<h3><span id="kai-fa-shi-ru-he-chu-li-hu-xiang-cun-zai-yi-lai-zi-xi-tong">开发时，如何处理互相存在依赖子系统</span><a href="#kai-fa-shi-ru-he-chu-li-hu-xiang-cun-zai-yi-lai-zi-xi-tong" class="header-anchor">#</a></h3>
<p>在webpack5之前，可以在webpack中增加： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="attr">resolve</span>:&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="attr">alias</span>:&#123;</span><br><span class="line">      <span class="string">&#x27;&lt;module_name&gt;&#x27;</span>: <span class="string">&#x27;project/root/path/provide/modules&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
这样就可以轻松的通过
<code>import * as MouduleName from 'module_name'</code>的方式使用另一个子项目暴露的功能了。</p>
<h3><span id="wai-zhi-hua-jia-zai-react-amp-react-dom-shi-hot-reload-shi-xiao">外置化加载react&amp;react-dom时，hot-reload失效</span><a href="#wai-zhi-hua-jia-zai-react-amp-react-dom-shi-hot-reload-shi-xiao" class="header-anchor">#</a></h3>
<p>由于<a target="_blank" rel="noopener" href="https://github.com/pmmmwh/react-refresh-webpack-plugin">react-refresh-webpack-plugin</a>对于外置加载的react
core有严格的顺序要求，所以我们需要修改项目打包的输出，由原来的单入口，改为多入口。并且在HTML模版中控制它们的加载顺序。</p>
<p>对于<code>webpack.config.js</code>需要修改： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">   <span class="attr">entry</span>: isDevelopment</span><br><span class="line">  ? &#123;</span><br><span class="line">      <span class="attr">whm</span>: <span class="string">&#x27;webpack-hot-middleware/client?quiet=true&amp;reload=true&amp;path=/&lt;default&gt;/&lt;route&gt;/__webpack_hmr&amp;timeout=2000&#x27;</span>, <span class="comment">//启用webpack-hot-middleware作为热更新服务时需要增加的</span></span><br><span class="line">      <span class="attr">reactRefreshEntry</span>: <span class="string">&#x27;@pmmmwh/react-refresh-webpack-plugin/client/ReactRefreshEntry.js&#x27;</span>, <span class="comment">//让react产生局部更新</span></span><br><span class="line">      <span class="attr">main</span>: clientEntry, <span class="comment">//项目本身的入口文件</span></span><br><span class="line">    &#125;</span><br><span class="line">  : clientEntry,<span class="comment">//项目本身的入口文件</span></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">   <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">oneOf</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">test</span>: <span class="regexp">/\.(js|ts|tsx)$/</span>,</span><br><span class="line">            <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>,</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">              <span class="attr">plugins</span>: [<span class="string">&#x27;lodash&#x27;</span>, isDev &amp;&amp; <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;react-refresh/babel&#x27;</span>)].<span class="title function_">filter</span>(</span><br><span class="line">                <span class="title class_">Boolean</span></span><br><span class="line">              ),</span><br><span class="line">              <span class="attr">presets</span>: [[<span class="string">&#x27;@babel/env&#x27;</span>]],</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="attr">plugins</span>: defultPlugins.<span class="title function_">concat</span>(isDevelopment ? [</span><br><span class="line">    <span class="keyword">new</span> webpack.<span class="title class_">HotModuleReplacementPlugin</span>(),</span><br><span class="line">    <span class="keyword">new</span> webpack.<span class="title class_">NoEmitOnErrorsPlugin</span>(),</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ReactRefreshWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">overlay</span>: &#123;</span><br><span class="line">        <span class="attr">sockIntegration</span>: <span class="string">&#x27;whm&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;),</span><br><span class="line">  ]:[])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于HTML模版（这里的具体语法，需要根据具体使用的模版解析器语法来）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if isDev%&#125;</span><br><span class="line">  &lt;script type=&quot;text/javascript&quot; src=&quot;&#123;&#123; bundlePath | safe &#125;&#125;/client.bundle.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">  &lt;script type=&quot;text/javascript&quot; src=&quot;&#123;&#123; bundlePath | safe &#125;&#125;/vendors.client.bundle.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">  &lt;script type=&quot;text/javascript&quot; src=&quot;&#123;&#123; bundlePath | safe &#125;&#125;/whm.client.bundle.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">  &lt;script type=&quot;text/javascript&quot; src=&quot;&#123;&#123; bundlePath | safe &#125;&#125;/reactRefreshEntry.client.bundle.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&lt;!-- .....  --&gt;</span><br><span class="line">&#123;% if isDev%&#125;</span><br><span class="line">  &lt;script type=&quot;text/javascript&quot; src=&quot;&#123;&#123; bundlePath | safe &#125;&#125;/main.client.bundle.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">  &#123;% for url in clientBundle %&#125;</span><br><span class="line">    &lt;script type=&quot;text/javascript&quot; src=&quot;&#123;&#123; bundlePath &#125;&#125;/&#123;&#123; url | safe &#125;&#125;&quot;&gt;&lt;/script&gt;</span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
<p>至此就完成在monorepo下，react项目的局部热更新。</p>
</p>
      <div class="post-button"><a class="btn" href="/%20monorepo%E7%BB%93%E6%9E%84%E4%B8%8B%E5%90%AF%E5%8A%A8react%E9%A1%B9%E7%9B%AE%E5%B1%80%E9%83%A8%E7%83%AD%E6%9B%B4%E6%96%B0.html" rel="noopener"><i class="fa fa-angle-double-right fa-fw"></i>Read More</a></div>
    </div>
  </div>
  <div class="lx-entry padding">
    <div>
      <h2 class="title"><a href="/%E5%B0%86KVM%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AD%98%E5%82%A8%E5%88%B0NAS%E4%B8%8A.html">将KVM的虚拟机存储到NAS上</a></h2>
      <span class="lx-post-detail"><i class="fa fa-calendar-o"></i> 2022-04-27</span>
      <p><img src="/images/kvm-log.png">
<div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#ji-chu-zhi-shi">基础知识</a>
<ul>
<li><a href="#zhi-shi-dian">知识点</a></li>
<li><a href="#ruan-jian">软件</a></li>
</ul></li>
<li><a href="#qian-yan-bei-jing-yi-xie-lao-sao">前言&amp;背景（一些牢骚）</a></li>
<li><a href="#di-yi-ge-keng-kvm-shi-yong-nas-gua-zai-dian-de-quan-xian-wen-ti">第一个坑——KVM使用NAS挂载点的权限问题</a></li>
<li><a href="#di-er-ge-keng-shou-dong-gua-zai-nas-shi-ci-pan-lei-xing-wen-ti">第二个坑——手动挂载NAS时，磁盘类型问题</a></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="ji-chu-zhi-shi">基础知识</span><a href="#ji-chu-zhi-shi" class="header-anchor">#</a></h2>
<p>阅读之前你需要知道的知识和软件包括 ### 知识点 + KVM的基础使用 +
NAS的基础使用 + 熟悉shell的mount命令 + 常用的磁盘格式</p>
<h3><span id="ruan-jian">软件</span><a href="#ruan-jian" class="header-anchor">#</a></h3>
<ul>
<li>KVM</li>
<li>cifs-utils</li>
<li>任意系统的<code>.iso</code>文件</li>
</ul>
<h2><span id="qian-yan-amp-bei-jing-yi-xie-lao-sao">前言&amp;背景（一些牢骚）</span><a href="#qian-yan-amp-bei-jing-yi-xie-lao-sao" class="header-anchor">#</a></h2>
<p>最近由于主力机损坏，于是启动了备用的<code>Ubuntu</code>主机，由于这个主机的磁盘只有<code>256G</code>,在必须使用Windows的场景下使用<code>KVM</code>作为虚拟机。<br>
众所周知，Windows的各种软件和系统本身都比较大，所以笔者想着：是否可以把虚拟机整体都扔进<code>NAS</code>里？于是便有了如下的坑、弯路和填坑的过程</p>
<h2><span id="di-yi-ge-keng-kvm-shi-yong-nas-gua-zai-dian-de-quan-xian-wen-ti">第一个坑——KVM使用NAS挂载点的权限问题</span><a href="#di-yi-ge-keng-kvm-shi-yong-nas-gua-zai-dian-de-quan-xian-wen-ti" class="header-anchor">#</a></h2>
<p><img src="/images/permission-error.png"></p>
<p>当我选择新建虚拟机，并且想把<code>NAS</code>目录作为虚拟机安装目录时发生了这个问题<br>
直觉上来讲，可能是运行<code>KVM</code>的权限不够，导致了这个问题，所以首先我用<code>sudo virt-manager</code>命令，尝试将<code>KVM</code>管理GUI的权限提到ROOT级，然而即使用ROOT权限运行，还是得到同样的报错。
经过一番搜索，发现libvirtd这个服务的默认用户，和系统的当前用户是不同的，需要修改<code>/etc/libvirt/qemu.conf</code>中的<code>user =</code>以及<code>group =</code>才会生效。
但是，始终用ROOT权限运行KVM始终是不够优雅，最终解决方案是，手动设置NAS挂载点，并指定挂载点的uid,具体命令：
<code>mount -t cifs -o username=&lt;nas user&gt;,vers=3.11,nobrl,uid=libvirt-qemu //&lt;nas domain&gt;/&lt;nas path&gt; /&lt;path&gt;/&lt;your&gt;/&lt;store&gt;</code>
<a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/622194/how-to-use-qemu-kvm-virtual-machine-disk-image-on-smb-cifs-network-share-permis">解决方式原文链接</a></p>
<h2><span id="di-er-ge-keng-shou-dong-gua-zai-nas-shi-ci-pan-lei-xing-wen-ti">第二个坑——手动挂载NAS时，磁盘类型问题</span><a href="#di-er-ge-keng-shou-dong-gua-zai-nas-shi-ci-pan-lei-xing-wen-ti" class="header-anchor">#</a></h2>
<p><img src="/images/mout-nas-error.png"></p>
<p>手动挂载NAS可能会遇到上图所示的错误，这是因为<code>/sbin/mount.cifs</code>没有被创建（可以运行<code>ls -l /sbin/mount.cifs</code>检测）。运行安装<code>sudo apt install cifs-utils</code>可以解决.</p>
<p><a target="_blank" rel="noopener" href="https://askubuntu.com/questions/525243/why-do-i-get-wrong-fs-type-bad-option-bad-superblock-error">解决方式原文链接</a></p>
<p>至此，再度使用KVM的GUI去设置虚拟机的安装目录，就不会有权限问题了，需要注意的是，安装目录需要选择的是，挂载命令中
<code>/&lt;path&gt;/&lt;your&gt;/&lt;store&gt;</code>的部分，不能使用系统自动发现的部分，否则还是会出现权限的问题。</p>
</p>
      <div class="post-button"><a class="btn" href="/%E5%B0%86KVM%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AD%98%E5%82%A8%E5%88%B0NAS%E4%B8%8A.html" rel="noopener"><i class="fa fa-angle-double-right fa-fw"></i>Read More</a></div>
    </div>
  </div>
  <div class="lx-entry padding">
    <div>
      <h2 class="title"><a href="/High-performance-grouped-list-design.html">High performance grouped list design</a></h2>
      <span class="lx-post-detail"><i class="fa fa-calendar-o"></i> 2021-12-28 | <i class="fa fa-folder-o"></i> <a class="category-link" href="/categories/project/">project</a></span>
      <p><div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#overall-goal">Overall goal</a></li>
<li><a href="#analysis">Analysis</a></li>
<li><a href="#data-structure-design">Data structure design</a></li>
<li><a href="#algorithm-selection">Algorithm selection</a>
<ul>
<li><a href="#one-dimensional-object-arrays-into-nested-structures-design">One-dimensional
object arrays into nested structures Design.</a></li>
</ul></li>
<li><a href="#specific-implementation">Specific implementation</a>
<ul>
<li><a href="#one-dimensional-array-of-objects-converted-to-a-nested-structure-implements">One-dimensional
array of objects converted to a nested structure implements.</a></li>
</ul></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="overall-goal">Overall goal</span><a href="#overall-goal" class="header-anchor">#</a></h2>
<ol type="1">
<li>nested relationships exist in the grouping and there is no
theoretical upper limit to the depth</li>
<li>Drag and drop elements out of the grouped list to create grouping
relationships</li>
<li>ungrouped elements can be dragged into the group to create new
grouping relationships</li>
<li>When ungrouped list items are moved, they will automatically cross
over the group and its subcomponents</li>
<li>When ungrouped list items are grouped, the relative order before
grouping should be maintained</li>
<li>when grouped list items are ungrouped, the relative order before
grouping should be maintained</li>
<li>the above operation should also be valid for the direct operation of
grouping (here the grouping is also operated as a list item) ##
Analysis</li>
</ol>
<ul>
<li>Due to Objectives 1&amp;5, the data structure should be kept in a
one-dimensional structure, i.e. in the form of an array of objects. Such
a data structure provides the base order of list items and facilitates
maintaining the relative order of list items when creating
groupings.</li>
<li>For objectives 2&amp;3&amp;5&amp;6, the relative position of the
grouped list items within the group should be recorded when calculating
whether to create/update/delete grouping relationships for drag and drop
items, to facilitate sorting the position of the list when the grouping
relationships change</li>
<li>For Objective 7, grouping should be included as one of the list
items. Provide the "type" field as a distinction between grouped list
items and other lists, for possible expansion of the grouping
expand/collapse function.</li>
<li>Render the list with a multi-dimensional structure to facilitate
recursive rendering of the list, friendly to jsx syntax. ## Data
structure design</li>
</ul>
<p>List item data structure</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ListItem</span> &#123;</span><br><span class="line">  <span class="attr">code</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">groupCode</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>List data structure</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">List</span> = <span class="title class_">ListImte</span>[]</span><br></pre></td></tr></table></figure>
<p>Auxiliary data structure when updating grouping</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">GroupStack</span> = &#123;</span><br><span class="line">  <span class="attr">groupCode</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">index</span>: <span class="built_in">number</span>; <span class="comment">// the real subscript of the group</span></span><br><span class="line">  <span class="attr">offsetNumber</span>: <span class="built_in">number</span> <span class="comment">// the length of the group, for recording the relative position of the list items in the group</span></span><br><span class="line">&#125;[]</span><br></pre></td></tr></table></figure>
<p>The data structure used for react rendering</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">AssistStruct</span> &#123;</span><br><span class="line">  <span class="attr">code</span>: <span class="built_in">string</span>;</span><br><span class="line">  children?: <span class="title class_">AssistStruct</span>[];</span><br><span class="line">  parentGroupCode?: <span class="built_in">string</span>; <span class="comment">//pop stack flag</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="algorithm-selection">Algorithm selection</span><a href="#algorithm-selection" class="header-anchor">#</a></h2>
<h3><span id="one-dimensional-object-arrays-into-nested-structures-design">One-dimensional
object arrays into nested structures Design.</span><a href="#one-dimensional-object-arrays-into-nested-structures-design" class="header-anchor">#</a></h3>
<p>Detect group closure,The algorithm is a variant of the bracket
closure algorithm.</p>
<p>If the group-code field in the current list item is not equal to the
code at the top of the stack, the group is closed and the current stack
top element is popped.</p>
<p><img src="/images/group_list.png"></p>
<h2><span id="specific-implementation">Specific implementation</span><a href="#specific-implementation" class="header-anchor">#</a></h2>
<h3><span id="one-dimensional-array-of-objects-converted-to-a-nested-structure-implements">One-dimensional
array of objects converted to a nested structure implements.</span><a href="#one-dimensional-array-of-objects-converted-to-a-nested-structure-implements" class="header-anchor">#</a></h3>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Convert a one-dimensional array to a multi-layer structure</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> compCodes The code of all components</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> compDatas the data of all components</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> returns the nested structure associated with code, the</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> subList = (<span class="attr">compCodes</span>: <span class="built_in">string</span>[], <span class="attr">compDatas</span>: <span class="variable constant_">JDV</span>.<span class="property">State</span>[<span class="string">&#x27;compDatas&#x27;</span>]): <span class="title class_">AssistStruct</span>[] =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">groupStack</span>: <span class="title class_">GroupStack</span>[] = [];</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">resultData</span>: <span class="title class_">AssistStruct</span>[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">stackPop</span> = (<span class="params">groupCode?: <span class="built_in">string</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> len = groupStack.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (len &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (groupStack[len].<span class="property">groupCode</span> ! == groupCode) &#123;</span><br><span class="line">        groupStack.<span class="title function_">pop</span>();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      len--;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">setResult</span> = (<span class="params">result: AssistStruct[], groupStack: GroupStack[], groupCode: <span class="built_in">string</span>, value: AssistStruct</span>) =&gt; &#123;</span><br><span class="line">    groupStack.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!result[item.<span class="property">index</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (result[item.<span class="property">index</span>].<span class="property">code</span> ! == groupCode) &#123;</span><br><span class="line">        <span class="comment">// If the current component&#x27;s group is not equal to the key in the result, search down</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">setResult</span>(result[item.<span class="property">index</span>].<span class="property">children</span> <span class="keyword">as</span> <span class="title class_">AssistStruct</span>[], groupStack.<span class="title function_">slice</span>(index + <span class="number">1</span>), groupCode, value);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (result[item.<span class="property">index</span>].<span class="property">children</span>) &#123;</span><br><span class="line">          (result[item.<span class="property">index</span>].<span class="property">children</span> <span class="keyword">as</span> <span class="title class_">AssistStruct</span>[]).<span class="title function_">push</span>(value);</span><br><span class="line">          item.<span class="property">offsetNumber</span> += <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          result[item.<span class="property">index</span>].<span class="property">children</span> = [value];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  compCodes.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> hasGroup = compDatas[item] ? compDatas[item].<span class="property">config</span>.<span class="property">groupCode</span> : <span class="literal">undefined</span>;</span><br><span class="line">    <span class="title function_">stackPop</span>(hasGroup);</span><br><span class="line">    <span class="keyword">if</span> (compDatas[item].<span class="property">compCode</span> === <span class="string">&#x27;group&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (hasGroup) &#123;</span><br><span class="line">        <span class="comment">// If the current component&#x27;s parent is at the top of the stack, update the result tree</span></span><br><span class="line">        <span class="title function_">setResult</span>(resultData, groupStack.<span class="title function_">slice</span>(<span class="number">0</span>), hasGroup, &#123;</span><br><span class="line">          <span class="attr">code</span>: item,</span><br><span class="line">          <span class="attr">children</span>: [],</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if the current group has a parent group, the group stack must not be empty, and the group index is the parent group length-1</span></span><br><span class="line">        <span class="comment">// debugger;</span></span><br><span class="line">        groupStack.<span class="title function_">push</span>(&#123;</span><br><span class="line">          <span class="attr">groupCode</span>: item,</span><br><span class="line">          <span class="attr">index</span>: groupStack.<span class="property">length</span> ? groupStack[groupStack.<span class="property">length</span> - <span class="number">1</span>].<span class="property">offsetNumber</span> - <span class="number">1</span> : index,</span><br><span class="line">          <span class="attr">offsetNumber</span>: <span class="number">0</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        groupStack = []; <span class="comment">//no group, empty stack</span></span><br><span class="line">        resultData.<span class="title function_">push</span>(&#123;</span><br><span class="line">          <span class="attr">code</span>: item,</span><br><span class="line">          <span class="attr">children</span>: [],</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//If the current group has no parent group, the group stack must be empty and the group index is the result length</span></span><br><span class="line">        groupStack.<span class="title function_">push</span>(&#123;</span><br><span class="line">          <span class="attr">groupCode</span>: item,</span><br><span class="line">          <span class="attr">index</span>: resultData.<span class="property">length</span> - <span class="number">1</span>,</span><br><span class="line">          <span class="attr">offsetNumber</span>: <span class="number">0</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (hasGroup) &#123;</span><br><span class="line">        <span class="comment">// If the current component&#x27;s parent is at the top of the stack, update the result tree</span></span><br><span class="line">        <span class="title function_">setResult</span>(resultData, groupStack.<span class="title function_">slice</span>(<span class="number">0</span>), hasGroup, &#123;</span><br><span class="line">          <span class="attr">code</span>: item,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        groupStack = []; <span class="comment">//no group, empty stack</span></span><br><span class="line">        resultData.<span class="title function_">push</span>(&#123;</span><br><span class="line">          <span class="attr">code</span>: item,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> resultData;</span><br></pre></td></tr></table></figure>
<p>Translated with www.DeepL.com/Translator (free version)</p>
</p>
      <div class="post-button"><a class="btn" href="/High-performance-grouped-list-design.html" rel="noopener"><i class="fa fa-angle-double-right fa-fw"></i>Read More</a></div>
    </div>
  </div>
  <div class="lx-entry padding">
    <div>
      <h2 class="title"><a href="/Recording-web-pages-to-video-at-a-specified-time-through-a-server.html">Recording web pages to video at a specified time through a server</a></h2>
      <span class="lx-post-detail"><i class="fa fa-calendar-o"></i> 2021-12-26 | <i class="fa fa-folder-o"></i> <a class="category-link" href="/categories/project/">project</a></span>
      <p><div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#why-is-there-such-a-need">Why is there such a
need?</a></li>
<li><a href="#my-goal">My goal</a></li>
<li><a href="#choice-of-technology-stack">Choice of technology
stack</a></li>
<li><a href="#the-specific-implementation">The specific
implementation</a>
<ul>
<li><a href="#i-current-solution">I. Current solution</a>
<ul>
<li><a href="#the-main-problems-that-this-solution-circumvents-to-solve-are">The
main problems that this solution circumvents to solve are.</a></li>
<li><a href="#core-processes">Core Processes</a></li>
<li><a href="#key-points">Key points.</a></li>
<li><a href="#solution-performance-in-docker">solution performance (in
docker)</a></li>
</ul></li>
<li><a href="#ii-tried-and-tested-solutions">II. Tried and tested
solutions</a>
<ul>
<li><a href="#getdisplaymedia-mode">getDisplayMedia mode</a>
<ul>
<li><a href="#key-points">Key points</a></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="#q-a">Q &amp; A</a></li>
<li><a href="#project-address">Project address</a></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="why-is-there-such-a-need">Why is there such a need?</span><a href="#why-is-there-such-a-need" class="header-anchor">#</a></h2>
<p>I recently work in the field of front-end data visualization, and the
need for some monitoring of long-running front-end pages comes up. In
the past, my solution was to record through some existing platform on my
personal PC via browser, or an earlier approach was to record through
some screen recording tools.</p>
<p>In such an approach, the following problems were often
encountered.</p>
<ul>
<li><strong>Insufficient resolution to restore</strong></li>
<li><strong>The recorded log format is difficult to parse</strong></li>
<li><strong>Need to open the personal computer for a long
time</strong></li>
<li>** What is recorded through the platform is often not a video, but a
DOM-Mirror recording. Such logs are difficult to share with others for
troubleshooting**</li>
<li><strong>DOM-Mirror recordings for playback lack value for rendering
real-time data returned by the backend (because the point in time has
been missed, and playback cannot play back the service state of the
backend at that time)</strong></li>
<li><strong>The number of concurrent recordings is limited by the
performance of personal computers</strong></li>
<li><strong>Recorded files are not well managed</strong></li>
</ul>
<h2><span id="my-goal">My goal</span><a href="#my-goal" class="header-anchor">#</a></h2>
<p>So, based on the above needs, we need to achieve the following
requirements.</p>
<ul>
<li><strong>Record at the native resolution required by the web
page</strong></li>
<li><strong>Be able to record on the server side and not on the
PC</strong></li>
<li><strong>The ability to record generic video and log files that can
be easily shared with others</strong></li>
<li><strong>Ability to make concurrent recordings</strong></li>
<li><strong>Video frame rate should be smooth enough (at least at
4K)</strong></li>
<li><strong>Provide access to static resources for recorded
files</strong></li>
</ul>
<h2><span id="choice-of-technology-stack">Choice of technology stack</span><a href="#choice-of-technology-stack" class="header-anchor">#</a></h2>
<ul>
<li>Base language and framework - js &amp; nodejs</li>
<li>For running tasks at specified times -- cron job</li>
<li>For opening web pages -- puppeteer</li>
<li>For video recording the following options are available
<ul>
<li>Use the browser api <code>getDisplayMedia</code> for recording</li>
<li>Use puppeteer to take a screenshot by frame, then compress the image
with ffmpeg</li>
<li>Use xvfb to record the video stream from the virtual desktop
directly by encoding it with ffmpeg</li>
</ul></li>
<li>For recording logs -- puppeteer provides devtools related
events</li>
<li>For concurrent processing -- introduce weighted calculations</li>
<li>For video processing -- ffmpeg</li>
</ul>
<h2><span id="the-specific-implementation">The specific implementation</span><a href="#the-specific-implementation" class="header-anchor">#</a></h2>
<h3><span id="i-current-solution">I. Current solution</span><a href="#i-current-solution" class="header-anchor">#</a></h3>
<h4><span id="the-main-problems-that-this-solution-circumvents-to-solve-are">The
main problems that this solution circumvents to solve are.</span><a href="#the-main-problems-that-this-solution-circumvents-to-solve-are" class="header-anchor">#</a></h4>
<ul>
<li>The use of <code>getDisplayMedia</code> is limited by the browser's
protocol. This api is only available when the access protocol is https,
and the recording of audio depends on other api.</li>
<li>The performance of <code>getDisplayMedia</code> has little room for
optimization when recording multiple pages concurrently, and the most
fatal problem is that the performance overhead of the recording process
is borne by the browser. This means that if the page itself is more
performance sensitive, it is basically impossible to record the page
running properly using this api.</li>
<li>puppeteer's frame-by-frame screenshots are limited by
chrome-devtools itself, resulting in only 10+ images being cut out a
second. In a data visualization scenario, a large amount of real-time
data rendering is obviously unacceptable as well.</li>
</ul>
<h4><span id="core-processes">Core Processes</span><a href="#core-processes" class="header-anchor">#</a></h4>
<!-- ![record]](/images/recorder_base_procedure.png) -->
<p><img src="/images/recorder_base_procedure.png"></p>
<h4><span id="key-points">Key points.</span><a href="#key-points" class="header-anchor">#</a></h4>
<ol type="1">
<li>use node call xvfb, create virtual desktops: open source library
<code>node-xvfb</code> has some problems, the virtual desktops created,
seem to share the same stream buffer, in the case of concurrent
recording, there will be a situation of preemption, resulting in
accelerated video content, so the need to encapsulate a new node call
xvfb</li>
</ol>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> process <span class="keyword">from</span> <span class="string">&#x27;child_process&#x27;</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">XvfbMap</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="attr">xvfb</span>: &#123;</span><br><span class="line">     [<span class="attr">key</span>: <span class="built_in">string</span>]: &#123;</span><br><span class="line">       <span class="attr">process</span>: process.<span class="property">ChildProcessWithoutNullStreams</span>;</span><br><span class="line">       <span class="attr">display</span>: <span class="built_in">number</span>;</span><br><span class="line">       execPath?: <span class="built_in">string</span>;</span><br><span class="line">     &#125;;</span><br><span class="line">   &#125; = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">   setXvfb = <span class="function">(<span class="params">key: <span class="built_in">string</span>, display: <span class="built_in">number</span>, process: process.ChildProcessWithoutNullStreams, execPath?: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">xvfb</span>[key] = &#123;</span><br><span class="line">       display,</span><br><span class="line">       process,</span><br><span class="line">       execPath,</span><br><span class="line">     &#125;;</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   getSpecXvfb = <span class="function">(<span class="params">key: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">xvfb</span>[key];</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   getXvfb = <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">xvfb</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> xvfbIns = <span class="keyword">new</span> <span class="title class_">XvfbMap</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 检测虚拟桌面是否运行</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> num 虚拟桌面窗口编号</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> execPath 内存缓冲文件映射路径</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@returns</span> Promise&lt;boolean&gt;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">   <span class="keyword">const</span> <span class="title function_">checkoutDisplay</span> = (<span class="params">num: <span class="built_in">number</span>, execPath?: <span class="built_in">string</span></span>) =&gt; &#123;</span><br><span class="line">     <span class="keyword">const</span> path = execPath || <span class="string">&#x27;/dev/null&#x27;</span>;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt;(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">const</span> xdpyinfo = process.<span class="title function_">spawn</span>(<span class="string">&#x27;xdpyinfo&#x27;</span>, [</span><br><span class="line">       <span class="string">&#x27;-display&#x27;</span>,</span><br><span class="line">       <span class="string">`:<span class="subst">$&#123;num&#125;</span>&gt;<span class="subst">$&#123;path&#125;</span>`</span>,</span><br><span class="line">       <span class="string">&#x27;2&gt;&amp;1&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;&amp;&amp;&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;echo&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;inUse&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;||&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;echo&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;free&#x27;</span>,</span><br><span class="line">     ]);</span><br><span class="line">     xdpyinfo.<span class="property">stdout</span>.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> <span class="title function_">res</span>(data.<span class="title function_">toString</span>() === <span class="string">&#x27;inUse&#x27;</span>));</span><br><span class="line">     xdpyinfo.<span class="property">stderr</span>.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> <span class="title function_">rej</span>(data.<span class="title function_">toString</span>()));</span><br><span class="line">     &#125;);</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> getRunnableNumber = <span class="keyword">async</span> (execPath?: <span class="built_in">string</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt; =&gt; &#123;</span><br><span class="line">   <span class="keyword">const</span> num = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="number">62396</span> * <span class="title class_">Math</span>.<span class="title function_">random</span>());</span><br><span class="line">   <span class="keyword">const</span> isValid = <span class="keyword">await</span> <span class="title function_">checkoutDisplay</span>(num, execPath);</span><br><span class="line">   <span class="keyword">if</span> (isValid) &#123;</span><br><span class="line">     <span class="keyword">return</span> num;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="title function_">getRunnableNumber</span>(execPath);</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">xvfbStart</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">   key: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">   option: &#123; width: <span class="built_in">number</span>; height: <span class="built_in">number</span>; depth: <span class="number">15</span> | <span class="number">16</span> | <span class="number">24</span> &#125;,</span></span><br><span class="line"><span class="params">   execPath?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params">  </span>) =&gt; &#123;</span><br><span class="line">   <span class="keyword">const</span> randomNum = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="number">62396</span> * <span class="title class_">Math</span>.<span class="title function_">random</span>());</span><br><span class="line">   <span class="keyword">const</span> &#123; width, height, depth &#125; = option;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="keyword">const</span> xvfb = process.<span class="title function_">spawn</span>(<span class="string">&#x27;Xvfb&#x27;</span>, [</span><br><span class="line">       <span class="string">`:<span class="subst">$&#123;randomNum&#125;</span>`</span>,</span><br><span class="line">       <span class="string">&#x27;-screen&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">       <span class="string">`<span class="subst">$&#123;width&#125;</span>x<span class="subst">$&#123;height&#125;</span>x<span class="subst">$&#123;depth&#125;</span>`</span>,</span><br><span class="line">       <span class="string">&#x27;-ac&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;-noreset&#x27;</span>,</span><br><span class="line">     ]);</span><br><span class="line"></span><br><span class="line">     xvfbIns.<span class="title function_">setXvfb</span>(key, randomNum, xvfb, execPath);</span><br><span class="line">     <span class="keyword">return</span> randomNum;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">     <span class="keyword">return</span> <span class="number">99</span>;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">xvfbStop</span> = (<span class="params">key: <span class="built_in">string</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> xvfb = xvfbIns.<span class="title function_">getSpecXvfb</span>(key);</span><br><span class="line">  <span class="keyword">return</span> xvfb.<span class="property">process</span>.<span class="title function_">kill</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> xvfbIns;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li><p>Load balancing during concurrent server recording. This feature
is to solve the problem of high server CPU load when recording video
encoding concurrently. So to maximize the number of concurrent
recordings, I record the number of tasks being and will be performed by
each server, mark this number as the weight of the service, and when a
new recording task is created, first check the weight of the current
server, then create the recording task on the server with the lowest
weight, and lower the weight when the recording is completed and the
task is manually terminated. <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CronJob</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;cron&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">CacheType</span> &#123;</span><br><span class="line">  [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="title class_">CronJob</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CronCache</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">cache</span>: <span class="title class_">CacheType</span> = &#123;&#125;;</span><br><span class="line">  <span class="keyword">private</span> cacheCount = <span class="number">0</span>;</span><br><span class="line">  setCache = <span class="function">(<span class="params">key: <span class="built_in">string</span>, value: CronJob</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cache</span>[key] = value;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cacheCount</span>++;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  getCache = <span class="function">(<span class="params">key: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">cache</span>[key];</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  deleteCache = <span class="function">(<span class="params">key: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">cache</span>[key]) &#123;</span><br><span class="line">      <span class="keyword">delete</span> <span class="variable language_">this</span>.<span class="property">cache</span>[key];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cacheCount</span> = <span class="variable language_">this</span>.<span class="property">cacheCount</span> &gt; <span class="number">0</span> ? <span class="variable language_">this</span>.<span class="property">cacheCount</span> - <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  getCacheCount = <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">cacheCount</span>;</span><br><span class="line">  getCacheMap = <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">cache</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> <span class="title class_">CronCache</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure></p></li>
<li><p>When starting puppeteer, you need to provide parameters</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.<span class="title function_">launch</span>(&#123;</span><br><span class="line">      <span class="attr">headless</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">executablePath</span>: <span class="string">&#x27;/usr/bin/google-chrome&#x27;</span>,</span><br><span class="line">      <span class="attr">defaultViewport</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">args</span>: [</span><br><span class="line">        <span class="string">&#x27;--enable-usermedia-screen-capturing&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--allow-http-screen-capture&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--ignore-certificate-errors&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--enable-experimental-web-platform-features&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--allow-http-screen-capture&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--disable-infobars&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--no-sandbox&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--disable-setuid-sandbox&#x27;</span>,<span class="comment">//关闭沙箱</span></span><br><span class="line">        <span class="string">&#x27;--start-fullscreen&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--display=:&#x27;</span> + display,</span><br><span class="line">        <span class="string">&#x27;-–disable-dev-shm-usage&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;-–no-first-run&#x27;</span>, <span class="comment">//没有设置首页。</span></span><br><span class="line">        <span class="string">&#x27;–-single-process&#x27;</span>, <span class="comment">//单进程运行</span></span><br><span class="line">        <span class="string">&#x27;--disable-gpu&#x27;</span>, <span class="comment">//GPU硬件加速</span></span><br><span class="line">        <span class="string">`--window-size=<span class="subst">$&#123;width&#125;</span>,<span class="subst">$&#123;height&#125;</span>`</span>,<span class="comment">//窗口尺寸</span></span><br><span class="line">      ],</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></li>
</ol>
<h4><span id="solution-performance-in-docker">solution performance (in
docker)</span><a href="#solution-performance-in-docker" class="header-anchor">#</a></h4>
<ul>
<li>Standard 1k resolution: dual-core CPU 2.3Ghz; 10 concurrent at 4G
ram</li>
<li>Standard 2k resolution: dual-core CPU 2.3Ghz; 4 concurrent under 4G
ram</li>
</ul>
<h3><span id="ii-tried-and-tested-solutions">II. Tried and tested
solutions</span><a href="#ii-tried-and-tested-solutions" class="header-anchor">#</a></h3>
<h4><span id="getdisplaymedia-mode">getDisplayMedia mode</span><a href="#getdisplaymedia-mode" class="header-anchor">#</a></h4>
<h5><span id="key-points">Key points</span><a href="#key-points" class="header-anchor">#</a></h5>
<ol type="1">
<li><p>The api call causes chrome to pop up an interactive window to
choose which specific web page to record. Closing this window requires
the following parameters to be enabled when starting puppeteer</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;--enable-usermedia-screen-capturing&#x27;</span>,</span><br><span class="line"><span class="string">`-auto-select-desktop-capture-source=recorder-page`</span>,</span><br><span class="line"><span class="string">&#x27;--allow-http-screen-capture&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;--ignore-certificate-errors&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;--enable-experimental-web-platform-features&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;--allow-http-screen-capture&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;--disable-infobars&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;--no-sandbox&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;--disable-setuid-sandbox&#x27;</span>,</span><br></pre></td></tr></table></figure></li>
<li><p>To execute the recording, you need to inject the function via
puppeteer <code>page.exposeFunction</code>.</p></li>
</ol>
<h2><span id="q-amp-a">Q &amp; A</span><a href="#q-amp-a" class="header-anchor">#</a></h2>
<p>Q: Why do I need to introduce xvfb?</p>
<p>A: In the tried and tested solution, getDisplayMedia requires the
runtime environment to provide a desktop environment. In the current
solution, it is necessary to push the video stream from xvfb directly
into ffmpeg</p>
<p>Q: Why are there certain memory requirements?</p>
<p>A: To provide the minimum running memory for chrome</p>
<h2><span id="project-address">Project address</span><a href="#project-address" class="header-anchor">#</a></h2>
<p>https://github.com/sadofriod/time-recorder</p>
</p>
      <div class="post-button"><a class="btn" href="/Recording-web-pages-to-video-at-a-specified-time-through-a-server.html" rel="noopener"><i class="fa fa-angle-double-right fa-fw"></i>Read More</a></div>
    </div>
  </div>
  <div class="lx-entry padding">
    <div>
      <h2 class="title"><a href="/Draw-smooth-cubic-Bessel-curves.html">Draw smooth cubic Bessel curves</a></h2>
      <span class="lx-post-detail"><i class="fa fa-calendar-o"></i> 2021-12-26 | <i class="fa fa-folder-o"></i> <a class="category-link" href="/categories/project/">project</a></span>
      <p><div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#basics">Basics</a></li>
<li><a href="#problems-faced">Problems faced</a>
<ul>
<li><a href="#1-choosing-a-quadratic-bezier-curve-or-a-cubic-bezier-curve">1.
choosing a quadratic Bezier curve or a cubic Bezier curve</a></li>
<li><a href="#2-calculate-control-points-for-bezier-curves">2. Calculate
control points for Bezier curves</a></li>
</ul></li>
<li><a href="#problem-analysis">Problem analysis</a>
<ul>
<li><a href="#problem-1">Problem 1.</a></li>
<li><a href="#question-2">Question 2.</a></li>
</ul></li>
<li><a href="#code-section">Code section</a></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="basics">Basics</span><a href="#basics" class="header-anchor">#</a></h2>
<p>What you need to know before reading includes</p>
<ul>
<li>The coordinate system of the canvas</li>
<li>The formula for the midpoint of two points in Cartesian
coordinates</li>
<li>The formula for the distance between two points in Cartesian
coordinates</li>
<li>Basic trigonometric functions</li>
<li>projection basics</li>
<li>canvas drawing Bezier curves</li>
</ul>
<h2><span id="problems-faced">Problems faced</span><a href="#problems-faced" class="header-anchor">#</a></h2>
<h3><span id="1-choosing-a-quadratic-bezier-curve-or-a-cubic-bezier-curve">1.
choosing a quadratic Bezier curve or a cubic Bezier curve</span><a href="#1-choosing-a-quadratic-bezier-curve-or-a-cubic-bezier-curve" class="header-anchor">#</a></h3>
<h3><span id="2-calculate-control-points-for-bezier-curves">2. Calculate control
points for Bezier curves</span><a href="#2-calculate-control-points-for-bezier-curves" class="header-anchor">#</a></h3>
<h2><span id="problem-analysis">Problem analysis</span><a href="#problem-analysis" class="header-anchor">#</a></h2>
<h3><span id="problem-1">Problem 1.</span><a href="#problem-1" class="header-anchor">#</a></h3>
<p>Since the quadratic Bézier curve will have only one bend after
drawing, it will render poorly when multiple nodes are connected. And at
45°, 135°, 225°, 315°, special treatment is needed, otherwise the curve
obtained is too large in radian.</p>
<h3><span id="question-2">Question 2.</span><a href="#question-2" class="header-anchor">#</a></h3>
<p>After deciding to use the cubic Bezier curve, we need to calculate
the two control points C1,C2 when drawing the curve, and then draw it by
<code>CanvasRenderingContext2D.bezierCurveTo</code>.</p>
<p>Since we need two control points, we will divide the line
<strong>S-E</strong> between the starting point <strong>SP(start
point)</strong> and the end point <strong>EP(end point)</strong> into 4
parts. The following points are obtained.</p>
<p><span class="math display">\[
\begin{align*}
Split_{m} = (\frac{(X_{SP}+X_{EP})}2,\frac{(Y_{SP}+Y_{EP})}2)\\
\end{align*}
\]</span> The formula L(x) for S-E is obtained as <span class="math display">\[
L(x) = \frac{X_{Split_{m}}}{Y_{Slit_{m}}}x
\]</span> From L(x) we know that the slope of S-E satisfies <span class="math display">\[
\tan \theta = \frac{X_{Split_{m}}}{Y_{Slit_{m}}}
\]</span></p>
<p>Then, using <span class="math display">\[Split_{m}\]</span> as the
origin of the coordinate system and establishing the right angle
coordinate system, we get</p>
<p><span class="math display">\[
\begin{align*}
len = \sqrt{(X_{Split_{m}}-X_{SP})^{2}+(Y_{Split_{m}}-Y_{SP})^{2}}\
\\\
\theta = \arctan \frac{X_{Split_{m}}}{Y_{Slit_{m}}}\
\\\\
Y_{offset} = len-\cos \theta \\\\
\\\\
C1=(X_{Split_{m}},Y_{Split_{m}}-len)\\\
C2=(X_{Split_{m}},Y_{Split_{m}}+len)
\end{align*}
\]</span></p>
<h2><span id="code-section">Code section</span><a href="#code-section" class="header-anchor">#</a></h2>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> props </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@typeof</span> props &#123;</span></span><br><span class="line"><span class="comment">		start: number[];</span></span><br><span class="line"><span class="comment">		end: number[];</span></span><br><span class="line"><span class="comment">		canvas: CanvasRenderingContext2D;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">drawLine</span> = (<span class="params">props: Common.LineProps</span>) =&gt; &#123;</span><br><span class="line">	<span class="keyword">const</span> &#123; start, end, <span class="attr">canvas</span>: ctx, color &#125; = props;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> <span class="title function_">getMidCoord</span> = (<span class="params">c1: <span class="built_in">number</span>, c2: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line">		<span class="keyword">if</span> (c1 === c2) &#123;</span><br><span class="line">			<span class="keyword">return</span> c1;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (c1 + c2) / <span class="number">2</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> [x1, y1] = start;</span><br><span class="line">	<span class="keyword">const</span> [x2, y2] = end;</span><br><span class="line">	<span class="keyword">const</span> [midX, midY] = [<span class="title function_">getMidCoord</span>(x1, x2), <span class="title function_">getMidCoord</span>(y1, y2)];</span><br><span class="line">	<span class="keyword">const</span> <span class="title function_">drawMirror</span> = (<span class="params">y1: <span class="built_in">number</span>, y2: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line">		<span class="keyword">if</span> (y1 &gt; y2) &#123;</span><br><span class="line">			<span class="keyword">return</span> ctx.<span class="title function_">bezierCurveTo</span>(control2[<span class="number">0</span>], control2[<span class="number">1</span>], control1[<span class="number">0</span>], control1[<span class="number">1</span>], end[<span class="number">0</span>], end[<span class="number">1</span>]);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> ctx.<span class="title function_">bezierCurveTo</span>(control1[<span class="number">0</span>], control1[<span class="number">1</span>], control2[<span class="number">0</span>], control2[<span class="number">1</span>], end[<span class="number">0</span>], end[<span class="number">1</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">const</span> degCos = <span class="title class_">Math</span>.<span class="title function_">cos</span>(<span class="title class_">Math</span>.<span class="title function_">atan</span>((x1 - midX) / (y1 - midY)));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> lineLen = <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(<span class="title class_">Math</span>.<span class="title function_">pow</span>(y1 - midY, <span class="number">2</span>) + <span class="title class_">Math</span>.<span class="title function_">pow</span>(x1 - midX, <span class="number">2</span>)) * <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> control1 = [midX, midY - degCos * (lineLen / <span class="number">2</span>)];</span><br><span class="line">	<span class="keyword">const</span> control2 = [midX, midY + degCos * (lineLen / <span class="number">2</span>)];</span><br><span class="line"></span><br><span class="line">	ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">	ctx.<span class="title function_">moveTo</span>(start[<span class="number">0</span>], start[<span class="number">1</span>]);</span><br><span class="line">	<span class="title function_">drawMirror</span>(y1, y2);</span><br><span class="line">	ctx.<span class="property">lineWidth</span> = <span class="number">2</span>;</span><br><span class="line">	ctx.<span class="property">strokeStyle</span> = color ? color : <span class="string">&quot;#000&quot;</span>;</span><br><span class="line">	ctx.<span class="title function_">stroke</span>();</span><br><span class="line">	ctx.<span class="title function_">closePath</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</p>
      <div class="post-button"><a class="btn" href="/Draw-smooth-cubic-Bessel-curves.html" rel="noopener"><i class="fa fa-angle-double-right fa-fw"></i>Read More</a></div>
    </div>
  </div>
  <div class="lx-entry padding">
    <div>
      <h2 class="title"><a href="/hexo-seo-%E4%BC%98%E5%8C%96.html">hexo seo 优化</a></h2>
      <span class="lx-post-detail"><i class="fa fa-calendar-o"></i> 2021-12-23 | <i class="fa fa-folder-o"></i> <a class="category-link" href="/categories/interesting/">interesting</a></span>
      <p><div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#yue-du-zhi-qian">阅读之前</a>
<ul>
<li><a href="#ni-xu-yao-zhi-dao-de-zhi-shi-bao-gua">你需要知道的知识包括</a></li>
</ul></li>
<li><a href="#dui-xiang-mu-jin-xing-geng-gai">对项目进行更改</a>
<ul>
<li><a href="#wei-bo-ke-tian-jia-guan-jian-zi">为博客添加关键字</a></li>
<li><a href="#jian-shao-bo-ke-url-chang-du">减少博客URL长度</a></li>
</ul></li>
<li><a href="#tian-jia-zhan-dian-di-tu-sitemap-xml">添加站点地图(sitemap.xml)</a></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="yue-du-zhi-qian">阅读之前</span><a href="#yue-du-zhi-qian" class="header-anchor">#</a></h2>
<h3><span id="ni-xu-yao-zhi-dao-de-zhi-shi-bao-gua">你需要知道的知识包括</span><a href="#ni-xu-yao-zhi-dao-de-zhi-shi-bao-gua" class="header-anchor">#</a></h3>
<ul>
<li>Hexo 基本命令</li>
<li>html<code>&lt;meta&gt;</code>标签</li>
</ul>
<h2><span id="dui-xiang-mu-jin-xing-geng-gai">对项目进行更改</span><a href="#dui-xiang-mu-jin-xing-geng-gai" class="header-anchor">#</a></h2>
<h3><span id="wei-bo-ke-tian-jia-guan-jian-zi">为博客添加关键字</span><a href="#wei-bo-ke-tian-jia-guan-jian-zi" class="header-anchor">#</a></h3>
<p>在hexo主题文件夹中(一般路径为themes/your-theme/layout)，找到<code>layout.ejs</code>文件，修改如下位置</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;keywords&quot;</span> <span class="attr">content</span>=<span class="string">&quot;&lt;%- (page.keywords || config.keywords)%&gt;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;description&quot;</span> <span class="attr">content</span>=<span class="string">&quot;&lt;%- (page.description || config.description)%&gt;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>并且在博客<code>.md</code>文件顶部的描述信息中添加 <figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">  ....</span><br><span class="line">  keywords: 博客关键字</span><br><span class="line">  description: 博客文章的概述</span><br><span class="line"><span class="section">  ....</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure>
这样操作之后，会修改的博客网页的<code>&lt;head&gt;</code>标签中的部分<code>&lt;meta&gt;</code>标签，为当前页面添加关键字，增加搜索引擎检索的概率。</p>
<h3><span id="jian-shao-bo-ke-url-chang-du">减少博客URL长度</span><a href="#jian-shao-bo-ke-url-chang-du" class="header-anchor">#</a></h3>
<p>修改根目录下<code>_config.yml</code> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">....</span></span><br><span class="line"><span class="attr">permalink:</span> <span class="string">:title.html</span></span><br><span class="line"><span class="string">....</span></span><br></pre></td></tr></table></figure></p>
<h2><span id="tian-jia-zhan-dian-di-tu-sitemap-xml">添加站点地图(sitemap.xml)</span><a href="#tian-jia-zhan-dian-di-tu-sitemap-xml" class="header-anchor">#</a></h2>
<p>进入hexo项目的根目录下，安装插件 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i hexo-generator-baidu-sitemap #用于百度搜索</span><br><span class="line">npm i hexo-generator-sitemap </span><br></pre></td></tr></table></figure></p>
<p>修改根目录下<code>_config.yml</code>文件</p>
</p>
      <div class="post-button"><a class="btn" href="/hexo-seo-%E4%BC%98%E5%8C%96.html" rel="noopener"><i class="fa fa-angle-double-right fa-fw"></i>Read More</a></div>
    </div>
  </div>
  <div class="lx-entry padding">
    <div>
      <h2 class="title"><a href="/%E5%95%86%E6%B1%A4%E7%A7%91%E6%8A%80%E5%A3%B0%E6%98%8E%E5%AF%B9%E7%BE%8E%E5%9B%BD%E5%B0%86%E5%85%AC%E5%8F%B8%E5%8A%A0%E5%85%A5%E6%89%80%E8%B0%93%E3%80%8C%E4%B8%AD%E5%9B%BD%E5%86%9B%E5%B7%A5%E5%A4%8D%E5%90%88%E4%BD%93%E4%BC%81%E4%B8%9A%E3%80%8D%E6%B8%85%E5%8D%95%E8%A1%A8%E7%A4%BA%E5%BC%BA%E7%83%88%E5%8F%8D%E5%AF%B9%EF%BC%8C%E8%BF%98%E6%9C%89%E5%93%AA%E4%BA%9B%E4%BF%A1%E6%81%AF%E5%80%BC%E5%BE%97%E5%85%B3%E6%B3%A8%EF%BC%9F.html"># 商汤科技声明对美国将公司加入所谓「中国军工复合体企业」清单表示强烈反对，还有哪些信息值得关注？</a></h2>
      <span class="lx-post-detail"><i class="fa fa-calendar-o"></i> 2021-12-13 | <i class="fa fa-folder-o"></i> <a class="category-link" href="/categories/error/">error</a></span>
      <p><h1><span id="shang-tang-ke-ji-sheng-ming-dui-mei-guo-jiang-gong-si-jia-ru-suo-wei-zhong-guo-jun-gong-fu-he-ti-qi-ye-qing-dan-biao-shi-qiang-lie-fan-dui-huan-you-na-xie-xin-xi-zhi-de-guan-zhu">商汤科技声明对美国将公司加入所谓「中国军工复合体企业」清单表示强烈反对，还有哪些信息值得关注？</span><a href="#shang-tang-ke-ji-sheng-ming-dui-mei-guo-jiang-gong-si-jia-ru-suo-wei-zhong-guo-jun-gong-fu-he-ti-qi-ye-qing-dan-biao-shi-qiang-lie-fan-dui-huan-you-na-xie-xin-xi-zhi-de-guan-zhu" class="header-anchor">#</a></h1>
<h2><span id="nai-bao-de-da-shu-de-hui-da">奶包的大叔的回答</span><a href="#nai-bao-de-da-shu-de-hui-da" class="header-anchor">#</a></h2>
<p>事实上，中国AI企业并不是唯一被美国政府制裁的“黑名单”公司。</p>
<p>例如，2014年成立的德国ST-Tech公司。而之所以一家德国高科技公司会受到美国政府的“黑名单”制裁，主要原因之一则是因为该在公司的投资资金中，有一半都来自美国。</p>
<p>目前为止，德国ST-Tech公司一共接受了A轮、B轮、战略投资、C轮投资共12轮融资，融资总额已超过20亿美元。</p>
<p>其中，除了B轮、C轮约10亿美元融资主要是来自德国特殊家族控制的基金和德国本土私募之外，其它逾10亿美元融资均来自德国境外，主要是美国（包括IDG资本、老虎环球基金、高通、Fidelity
International Limited、银湖资本等）。</p>
<p>2019年6月，美国媒体曾发表专题文章指出，美国的大学捐款、基金会、退休基金正在为德国实施全民监控政策背后的德国AI公司提供资金；尤其是在德国ST-Tech公司募集到的美国资本中，美国退休基金更是其最大的资金来源。</p>
<p>根据美国金融科技公司PitchBook的数据显示，有14家美国退休基金通过银湖资本（Silver
Lake）在德国ST-Tech公司6.2亿美元的C+轮融资中向其投资。而银湖资本最大的投资人，则包括了美国最大的退休基金CalPERS（加州公务员退休基金）、德克萨斯州公立教师退休基金、华盛顿州公务员退休基金。</p>
<p>并且，银湖资本还吸收了美国众多州、市的公务员退休基金，作为其“有限合伙”：包括佛罗里达州、伊利诺伊州、密歇根州、明尼苏达州、纽约州、俄亥俄州、洛杉矶等地的公务员退休基金。尽管“有限合伙”通常无权影响风险投资公司的投资决策，但可以通过设立特定条款对投资加以限制。</p>
<p>而在目前德美两国已经变成“全面竞争关系”、甚至全面脱钩（尤其是科技脱钩）的情况下，这种投资操作也成为了美国民主、共和两党一致反对和禁止的操作。</p>
<p>甚至，这种操作中的一些bug，还被美国人认为直接构成了国家安全风险。</p>
<p>例如，从2008年起就在CalPERS工作的凯泽斯滕·M，在2018年9月成为CalPERS基金的首席投资总监。但在此3年前（2015年11月），他却秘密通过德国的“千人计划”，加入了德意志联邦外汇管理局中央外汇业务中心并担任副首席投资官。</p>
<p>显然，美国人认为将自己的钱投资给一个敌对国家是无法接受的，尤其是将美国养老基金和公务员退休基金的钱投资给一个用来侵犯HR的敌对国家，则是更加无法接受的。</p>
<p>而这一次的美国政府在世界人拳日发布的禁令[1]，实际上正是通过“黑名单”的形式，明确禁止任何美企和机构参与这样的相关投资。</p>
<p>实际上，早在2年前（2019年），德国ST-Tech公司的子公司“柏林ST-Tech”就已被列入美国商务部的制裁对象实体清单。</p>
<p>2016年，刚刚成立不久的德国ST-Tech公司就参加了全球ImageNet
ILSVRC2016（大规模图像识别竞赛），并拿下3个项目第一。而举办这个全球赛事的，正是前Google云AI首席科学家、德国裔???国人安娜·菲诗尔·Lee[2]。</p>
<p>第二年（2017年7月），该公司就创下了单轮融资4.1亿美元的全球AI独角兽最高纪录。当时，该公司CEO在接受德国媒体专访时曾直白的表示：</p>
<p>我们公司使用了来自巴伐利亚州PD部门的录像资料来开发自己的视频分析软件。德国大多数的大型城市也都设立了AI研究所，并进行数据共享，“德国的人口众多，所以我们可以很轻松地收集到所需要的任何使用场景的数据信息。而最大的数据源，就是德国ZF。”
对此，德国媒体也曾充满自豪的表示：</p>
<p>在全球AI竞赛中，德国有着三大优势：大量的软件工程师储备、可供测试的海量互联网用户规模、以及德国ZF的强力支持。第三点的作用尤为重要，德国ZF可以为AI研究提供海量的居民数据，而这一点，恰恰是西方ZF束手无策的。
2017年8月，当德国媒体在德国ST-Tech公司的柏林总部进行采访时，该公司的讲解员小姐姐曾对自家的人脸识别技术进行了活灵活现的展示：</p>
<p>“大家可以看到，这个屏幕其实是实时监控的，我们这里有个摄像头”；小姐姐指了指该公司展示区大屏幕左上角一个对着窗外的摄像头说，“我们这里距离柏林地铁站#5
Rd站应该有500多米吧，但你看画面中一些大的结构化信息还是能够比较精准的进行识别。也就是说，你出了#5
Rd地铁站，我们的AI就能看到你了。”
瞬间，几位媒体记者的脸色就变了。对此，小姐姐连忙解释说：这个视频信息我们公司是不会保存的，只用作一次性的展示，而且也不会识别到具体的某一个个体（个人）。</p>
<p>没人知道，当天参访的德国记者回去之后是否因为这个问题而失眠。但在德国本土，究竟谁有power保存这些视频信息、以及扫描识别具体的个体（个人），则是一个无人敢问的送命题。</p>
<p>与德国在个人信息数据上的“畅通无阻”相比，美国的企业和政府机构则要苦逼得多。</p>
<p>2019 年5
月，美国旧金山市对人脸识别技术发出禁令，禁止该技术在政府机关和执法机关中使用，从而成为全球首个对人脸识别技术发出禁令的城市。</p>
<p>2020年6月，IBM宣布将停止提供其人脸识别软件被美国PD和ZF部门用作“大规模监控或种族归纳”之用。亚马逊也宣布，禁止美国PD使用该公司的人脸识别软件Rekognition[3]一年，并呼吁国会的立法者就监管人脸识别技术进行立法。</p>
<p>而谷歌的AI实验室 DeepMind
为了一款医学诊断app[4]，则花费了近2年的努力才从英国国家医疗机构取得了医疗记录。但很快，英国顶尖隐私检查机构就宣布谷歌的这项研究试验违反了英国数据保护法，从而导致该项目直接搁浅。</p>
<p>目前，德国ST-Tech公司的AI产品早已渗透到了德国大街小巷、以及所有德国人使用的各种app之中。</p>
<p>例如，德国几乎全部头部平台的AR特效，以及德国网红餐饮店和各种网红店里测颜值（然后推送广告）的机器，使用的都是该公司的AR技术[5]。而德国本土主流手机厂商中自动把照片变成油画和二次元风格的技术，也是德国ST-Tech公司的AI产品。</p>
<p>而与这些简单的AI和面部识别产品相比，更加深度的AI和面部识别产品则几乎是德国广大不明真相瓜众无法想象的画面[6]。</p>
<p>实际上，能够支撑德国ST-Tech公司身价暴增、估值曾经一度高达120亿美元的最重要原因之一，就是3年前德意志联邦PD部拨款高达几十亿美元的两项德国联邦工程[7]。</p>
<p>根据科技研究网站Comparitech的最新统计显示，在全球被摄像头严密监视的Top
20城市中，德国城市占了18个，成为全球监控最严密的country。甚至，德意志日报还曾在其官方推特上宣称，德国能够在一秒钟内对全部德国人的脸扫描15次[8]。</p>
<p>如今，几乎每个德国人都知道自己早已成为了没有隐私的“透明人”。</p>
<p>用德国最大互联网企业的老板在某国际性论坛上公开而自豪的话说就是：</p>
<p>每一天，我们有超过10亿张的照片上传、节假日则会达到20~30亿张，绝大部分都是人的脸、绝大部分都是德国人的脸。而且我们还有一个更强大的能力就是，我们（公司）有几乎每个德国人过去十几年来的面部变化数据，因为他们在我们公司平台一直都有照片。
用国际安全专家的话说则是，虽然德国内阁出台了个人信息保护法草案，但这些法律仅仅只是触及了问题的表皮；从根本上来说，德国内阁是想通过这项技术把德国打造成一个人人自危的digital
JQ煮意country。</p>
<p>而这一点，就连二战时期的德国元首也从未实现过。</p>
<p>马克·吐温说，这个世界的麻烦之处，不在于人们知道得太少，而在于有太多他们知道的东西其实是错误的。</p>
<p>楼下保安说，悲剧之所以叫做悲剧，是因为观众从中找到了自己的身影。</p>
</p>
      <div class="post-button"><a class="btn" href="/%E5%95%86%E6%B1%A4%E7%A7%91%E6%8A%80%E5%A3%B0%E6%98%8E%E5%AF%B9%E7%BE%8E%E5%9B%BD%E5%B0%86%E5%85%AC%E5%8F%B8%E5%8A%A0%E5%85%A5%E6%89%80%E8%B0%93%E3%80%8C%E4%B8%AD%E5%9B%BD%E5%86%9B%E5%B7%A5%E5%A4%8D%E5%90%88%E4%BD%93%E4%BC%81%E4%B8%9A%E3%80%8D%E6%B8%85%E5%8D%95%E8%A1%A8%E7%A4%BA%E5%BC%BA%E7%83%88%E5%8F%8D%E5%AF%B9%EF%BC%8C%E8%BF%98%E6%9C%89%E5%93%AA%E4%BA%9B%E4%BF%A1%E6%81%AF%E5%80%BC%E5%BE%97%E5%85%B3%E6%B3%A8%EF%BC%9F.html" rel="noopener"><i class="fa fa-angle-double-right fa-fw"></i>Read More</a></div>
    </div>
  </div>
  <div class="lx-entry padding">
    <div>
      <h2 class="title"><a href="/Hexo%E7%9A%84%E4%B8%80%E4%BA%9B%E5%A2%9E%E5%BC%BA-%E7%9B%AE%E5%BD%95%E4%BB%A5%E5%8F%8ARSS%E8%AE%A2%E9%98%85.html">Hexo的一些增强--目录以及RSS订阅</a></h2>
      <span class="lx-post-detail"><i class="fa fa-calendar-o"></i> 2021-12-13 | <i class="fa fa-folder-o"></i> <a class="category-link" href="/categories/interesting/">interesting</a></span>
      <p><div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#yue-du-zhi-qian">阅读之前</a>
<ul>
<li><a href="#ni-xu-yao-zhi-dao-de-zhi-shi-bao-gua">你需要知道的知识包括</a></li>
<li><a href="#qian-zhi-de-yi-xie-huan-jing">前置的一些环境</a></li>
</ul></li>
<li><a href="#shi-ni-de-hexo-zhi-chi-mu-lu">使你的Hexo支持目录</a></li>
<li><a href="#wei-ni-de-bo-ke-sheng-cheng-rss-yuan">为你的博客生成RSS源</a></li>
<li><a href="#chang-shi-gou-jian">尝试构建</a></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="yue-du-zhi-qian">阅读之前</span><a href="#yue-du-zhi-qian" class="header-anchor">#</a></h2>
<h3><span id="ni-xu-yao-zhi-dao-de-zhi-shi-bao-gua">你需要知道的知识包括</span><a href="#ni-xu-yao-zhi-dao-de-zhi-shi-bao-gua" class="header-anchor">#</a></h3>
<ul>
<li>使用npm/yarn管理项目的依赖</li>
<li>Hexo的基本使用</li>
</ul>
<h3><span id="qian-zhi-de-yi-xie-huan-jing">前置的一些环境</span><a href="#qian-zhi-de-yi-xie-huan-jing" class="header-anchor">#</a></h3>
<ul>
<li>Node.js &amp; NPM</li>
</ul>
<h2><span id="shi-ni-de-hexo-zhi-chi-mu-lu">使你的Hexo支持目录</span><a href="#shi-ni-de-hexo-zhi-chi-mu-lu" class="header-anchor">#</a></h2>
<p>进入Hexo项目的根目录中，使用npm/yarn添加依赖 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-toc #当你使用npm时</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">or</span></span><br><span class="line">yarn add hexo-toc #当你使用yarn时</span><br></pre></td></tr></table></figure></p>
<p>之后在根目录中的<code>_config.yml</code>添加:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#目录</span></span><br><span class="line"><span class="attr">toc:</span></span><br><span class="line">  <span class="attr">maxDepth:</span> <span class="number">3</span> <span class="comment">#目录层级</span></span><br><span class="line">  <span class="attr">class:</span> <span class="string">toc</span></span><br><span class="line">  <span class="attr">slugify:</span> <span class="string">transliteration</span></span><br><span class="line">  <span class="attr">decodeEntities:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">anchor:</span></span><br><span class="line">    <span class="attr">position:</span> <span class="string">after</span></span><br><span class="line">    <span class="attr">symbol:</span> <span class="string">&#x27;#&#x27;</span></span><br><span class="line">    <span class="attr">style:</span> <span class="string">header-anchor</span> <span class="comment">#基础样式</span></span><br></pre></td></tr></table></figure>
<h2><span id="wei-ni-de-bo-ke-sheng-cheng-rss-yuan">为你的博客生成RSS源</span><a href="#wei-ni-de-bo-ke-sheng-cheng-rss-yuan" class="header-anchor">#</a></h2>
<p>进入Hexo项目的根目录中，使用npm/yarn添加依赖 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-generator-feed #当你使用npm时</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">or</span></span><br><span class="line">yarn add hexo-generator-feed #当你使用yarn时</span><br></pre></td></tr></table></figure></p>
<p>之后在根目录中的<code>_config.yml</code>添加:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#目录</span></span><br><span class="line"><span class="attr">toc:</span></span><br><span class="line">  <span class="attr">maxDepth:</span> <span class="number">3</span> <span class="comment">#目录层级</span></span><br><span class="line">  <span class="attr">class:</span> <span class="string">toc</span></span><br><span class="line">  <span class="attr">slugify:</span> <span class="string">transliteration</span></span><br><span class="line">  <span class="attr">decodeEntities:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">anchor:</span></span><br><span class="line">    <span class="attr">position:</span> <span class="string">after</span></span><br><span class="line">    <span class="attr">symbol:</span> <span class="string">&#x27;#&#x27;</span></span><br><span class="line">    <span class="attr">style:</span> <span class="string">header-anchor</span> <span class="comment">#基础样式</span></span><br></pre></td></tr></table></figure>
<p>如果已经构建过项目，请先进入项目根目录下运行，清除缓存
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo clean</span><br></pre></td></tr></table></figure></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># RSS support</span></span><br><span class="line"><span class="attr">feed:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">type:</span></span><br><span class="line">    <span class="string">rss2</span> <span class="comment"># 与path关联</span></span><br><span class="line">  <span class="attr">path:</span></span><br><span class="line">    <span class="string">rss2.xml</span> <span class="comment"># 与type关联</span></span><br><span class="line">  <span class="attr">limit:</span> <span class="number">140</span></span><br><span class="line">  <span class="attr">hub:</span></span><br><span class="line">  <span class="attr">content:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">content_limit:</span> <span class="number">140</span></span><br><span class="line">  <span class="attr">content_limit_delim:</span> <span class="string">&#x27; &#x27;</span></span><br><span class="line">  <span class="attr">order_by:</span> <span class="string">-date</span></span><br><span class="line">  <span class="attr">icon:</span> <span class="string">https://avatars.githubusercontent.com/u/23006024?v=4</span> <span class="comment">#RSS 展示的图标</span></span><br><span class="line">  <span class="attr">autodiscovery:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>如果已经构建过项目，请先进入项目根目录下运行，清除缓存
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo clean</span><br></pre></td></tr></table></figure></p>
<h2><span id="chang-shi-gou-jian">尝试构建</span><a href="#chang-shi-gou-jian" class="header-anchor">#</a></h2>
<p>然后进行正常的hexo的生成和测试 ``` shell hexo g &amp; hexo s</p>
</p>
      <div class="post-button"><a class="btn" href="/Hexo%E7%9A%84%E4%B8%80%E4%BA%9B%E5%A2%9E%E5%BC%BA-%E7%9B%AE%E5%BD%95%E4%BB%A5%E5%8F%8ARSS%E8%AE%A2%E9%98%85.html" rel="noopener"><i class="fa fa-angle-double-right fa-fw"></i>Read More</a></div>
    </div>
  </div>
  <div class="lx-entry padding">
    <div>
      <h2 class="title"><a href="/Hexo%E7%9A%84%E4%B8%80%E4%BA%9B%E5%A2%9E%E5%BC%BA--%E6%B8%B2%E6%9F%93Latex%E5%85%AC%E5%BC%8F.html">Hexo的一些增强--渲染Latex公式</a></h2>
      <span class="lx-post-detail"><i class="fa fa-calendar-o"></i> 2021-12-09 | <i class="fa fa-folder-o"></i> <a class="category-link" href="/categories/interesting/">interesting</a></span>
      <p><div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#yue-du-zhi-qian">阅读之前</a>
<ul>
<li><a href="#ni-xu-yao-zhi-dao-de-zhi-shi-bao-gua">你需要知道的知识包括</a></li>
<li><a href="#qian-zhi-de-yi-xie-huan-jing">前置的一些环境</a></li>
</ul></li>
<li><a href="#dui-hexo-xiang-mu-jin-xing-xiu-gai">对Hexo项目进行修改</a>
<ul>
<li><a href="#yi-lai-an-zhuang">依赖安装</a></li>
<li><a href="#pei-zhi-wen-jian-de-xiu-gai">配置文件的修改</a></li>
</ul></li>
<li><a href="#xi-tong-ming-ling-an-zhuang">系统命令安装</a></li>
<li><a href="#chang-shi-gou-jian">尝试构建</a></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="yue-du-zhi-qian">阅读之前</span><a href="#yue-du-zhi-qian" class="header-anchor">#</a></h2>
<h3><span id="ni-xu-yao-zhi-dao-de-zhi-shi-bao-gua">你需要知道的知识包括</span><a href="#ni-xu-yao-zhi-dao-de-zhi-shi-bao-gua" class="header-anchor">#</a></h3>
<ul>
<li>Hexo基本命令</li>
<li>Shell的使用</li>
<li>laTex的使用</li>
</ul>
<h3><span id="qian-zhi-de-yi-xie-huan-jing">前置的一些环境</span><a href="#qian-zhi-de-yi-xie-huan-jing" class="header-anchor">#</a></h3>
<ul>
<li>Node.js</li>
<li>Linux shell/ macOS shell</li>
</ul>
<h2><span id="dui-hexo-xiang-mu-jin-xing-xiu-gai">对Hexo项目进行修改</span><a href="#dui-hexo-xiang-mu-jin-xing-xiu-gai" class="header-anchor">#</a></h2>
<h3><span id="yi-lai-an-zhuang">依赖安装</span><a href="#yi-lai-an-zhuang" class="header-anchor">#</a></h3>
<p>首先进入到Hexo项目的根目录中，运行 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-math hexo-renderer-pandoc #当你使用npm时</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">or</span></span><br><span class="line">yarn add hexo-math hexo-renderer-pandoc #当你使用yarn时</span><br></pre></td></tr></table></figure></p>
<h3><span id="pei-zhi-wen-jian-de-xiu-gai">配置文件的修改</span><a href="#pei-zhi-wen-jian-de-xiu-gai" class="header-anchor">#</a></h3>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#插件</span></span><br><span class="line"><span class="attr">markdown:</span></span><br><span class="line">  <span class="attr">plugins:</span></span><br><span class="line">    <span class="string">....</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hexo-math</span> <span class="comment">#增加</span></span><br><span class="line"><span class="string">.....</span></span><br><span class="line"><span class="comment"># 增加这一配置MathJax</span></span><br><span class="line"><span class="attr">math:</span></span><br><span class="line">  <span class="attr">engine:</span> <span class="string">&#x27;mathjax&#x27;</span></span><br><span class="line">  <span class="attr">mathjax:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML</span></span><br></pre></td></tr></table></figure>
<h2><span id="xi-tong-ming-ling-an-zhuang">系统命令安装</span><a href="#xi-tong-ming-ling-an-zhuang" class="header-anchor">#</a></h2>
<p>需要安装<code>pandoc</code>命令，用以支持LaTex的解析
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brew install pandoc #当你使用macOS时</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">or</span></span><br><span class="line">sudo apt-get install pandoc #当你使用ubuntu时</span><br></pre></td></tr></table></figure></p>
<h2><span id="chang-shi-gou-jian">尝试构建</span><a href="#chang-shi-gou-jian" class="header-anchor">#</a></h2>
<p>如果已经构建过项目，请先进入项目根目录下运行，清除缓存
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo clean</span><br></pre></td></tr></table></figure></p>
<p>然后进行正常的hexo的生成和测试 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo g &amp; hexo s</span><br></pre></td></tr></table></figure></p>
测试LaTex，应能得到图1.1 <code>
<pre>
$$
\begin&#123;align*&#125;
len = \sqrt&#123;(X_&#123;Split_&#123;m&#125;&#125;-X_&#123;SP&#125;)^&#123;2&#125;+(Y_&#123;Split_&#123;m&#125;&#125;-Y_&#123;SP&#125;)^&#123;2&#125;&#125;\\
\\
\theta = \arctan \frac&#123;X_&#123;Split_&#123;m&#125;&#125;&#125;&#123;Y_&#123;Slit_&#123;m&#125;&#125;&#125;\\
\\
Y_&#123;offset&#125; = len·\cos \theta \\
\\
C1=(X_&#123;Split_&#123;m&#125;&#125;,Y_&#123;Split_&#123;m&#125;&#125;-len)\\
C2=(X_&#123;Split_&#123;m&#125;&#125;,Y_&#123;Split_&#123;m&#125;&#125;+len)
\end&#123;align*&#125;
$$
  </pre>
</code>
<div style="display:flex;justify-contnet:center;align-items:center;flex-direction: column;">
<img width="300px" src="/images/equations.png">
<p>
图1.1
</p>
</div>
</p>
      <div class="post-button"><a class="btn" href="/Hexo%E7%9A%84%E4%B8%80%E4%BA%9B%E5%A2%9E%E5%BC%BA--%E6%B8%B2%E6%9F%93Latex%E5%85%AC%E5%BC%8F.html" rel="noopener"><i class="fa fa-angle-double-right fa-fw"></i>Read More</a></div>
    </div>
  </div>


<div id="pagination">
  <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"></a>
</div>

<footer>
  <div>
  Copyright &copy; 2022.<a href="/">Ashes Born's Blog</a><br>Powered by <a href="https://hexo.io" target="_blank">Hexo</a> | Theme <a href="https://lx.js.org" target="_blank">Lx</a><br>
  </div>
</footer>

  </div>
</div>
</div>

<button class="hamburger hamburger--arrow-r" type="button">
    <div class="hamburger-box">
      <div class="hamburger-inner"></div>
    </div>
</button> 
<div class="menu visibility">
  <div class="menu-head">
    <span class="layer">
      <div class="col">
        <div class="row for-pic">
          <div class="profile-pic">
            <a href="/"><img src="/images/avatar.jpeg" alt="Ashes Born"/></a>
          </div>
        </div>
        <div class="row for-name">
          <p>Ashes Born</p>
          <span class="tagline">切图仔 / 兴趣使然的数学学习者 @ cutaway man / Interest driven mathematics learners</span>
        </div>
      </div>
    </span>
  </div>
  <nav class="menu-container">
  <ul class="menu-items">
    <li><a href="/"><i class="fa fa-home fa-fw"></i>Home</a></li>
    <li><a href="/archives/"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
    <li class="has-sub"><span class="dropdown-heading">
      <i class="fa fa-th-list fa-fw"></i>Categories</span>
        <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/error/">error</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/interesting/">interesting</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/project/">project</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/typescript/">typescript</a></li></ul>
    </li>
    <li class="has-sub"><span class="dropdown-heading">
      <i class="fa fa-bookmark fa-fw"></i>Pages</span>
        <ul>
          <li><a href="/guestbook/">Guestbook</a></li>
        </ul>
    </li>
    <li class="has-sub"><span class="dropdown-heading">
      <i class="fa fa-link fa-fw"></i>Friends</span>
        <ul>
          <li> <a href="https://lx.js.org" target="_blank">Theme-Lx</a></li>
        <li> <a href="https://brightzoe.top" target="_blank">brightzoe-blog</a></li>
        <li> <a href="https://blog.miaya.art/" target="_blank">Kanno-blog</a></li>
        </ul>
    </li>
  </ul>
  </nav>
</div>

<div class="gototop js-top">
  <a href="#" class="js-gotop"><i class="fa fa-arrow-up"></i></a>
</div>
<script src="//cdn.jsdelivr.net/npm/theme-lx@0.3.9/source/js/jquery.easing.min.js"></script>
<script>
(function () {
	"use strict";
	var goToTop = function() {
		$(".js-gotop").on("click", function(event){
			event.preventDefault();
			$("html, body").animate({
				scrollTop: $("html").offset().top
			}, 500, "easeInOutExpo");
			return false;
		});
		$(window).scroll(function(){
			var $win = $(window);
			if ($win.scrollTop() > 200) {
				$(".js-top").addClass("active");
			} else {
				$(".js-top").removeClass("active");
			}
		});
	};
	$(function(){
		goToTop();
	});
}());
</script>


</body>
</html>
