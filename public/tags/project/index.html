<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>Tag: project - Ashes Born&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Ashes Born&#039;s Blog"><meta name="msapplication-TileImage" content="https://cdn.midjourney.com/ffa4484a-2f5a-4c71-96b8-7749aef5dfd3/0_0_384_N.webp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Ashes Born&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Work &amp;amp; Life &amp;amp; learn"><meta property="og:type" content="blog"><meta property="og:title" content="Ashes Born&#039;s Blog"><meta property="og:url" content="http://sadofriod.github.io/"><meta property="og:site_name" content="Ashes Born&#039;s Blog"><meta property="og:description" content="Work &amp;amp; Life &amp;amp; learn"><meta property="og:locale" content="zh EN"><meta property="og:image" content="http://sadofriod.github.io/img/og_image.png"><meta property="article:author" content="Ashes Born"><meta property="article:tag" content="fornt-end,react,node,raspberry,Linux,docker,java,javascript,algorithm"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://sadofriod.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://sadofriod.github.io"},"headline":"Ashes Born's Blog","image":["http://sadofriod.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Ashes Born"},"publisher":{"@type":"Organization","name":"Ashes Born's Blog","logo":{"@type":"ImageObject","url":"https://cdn.midjourney.com/ffa4484a-2f5a-4c71-96b8-7749aef5dfd3/0_0_384_N.webp"}},"description":"Work &amp; Life &amp; learn"}</script><link rel="icon" href="https://cdn.midjourney.com/ffa4484a-2f5a-4c71-96b8-7749aef5dfd3/0_0_384_N.webp"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-167566818-3" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-167566818-3');</script><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/rss2.xml" title="Ashes Born's Blog" type="application/rss+xml">
</head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://cdn.midjourney.com/ffa4484a-2f5a-4c71-96b8-7749aef5dfd3/0_0_384_N.webp" alt="Ashes Born&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">Tags</a></li><li class="is-active"><a href="#" aria-current="page">project</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-01-11T13:53:18.000Z" title="1/11/2023, 9:53:18 PM">2023-01-11</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-09-10T14:10:41.229Z" title="9/10/2023, 10:10:41 PM">2023-09-10</time></span><span class="level-item"><a class="link-muted" href="/categories/project/">project</a></span><span class="level-item">27 minutes read (About 4057 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/%E4%BB%8ECRA%E5%B0%86react%E9%A1%B9%E7%9B%AE%E8%BF%81%E7%A7%BB%E6%88%90%E5%BE%AE%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE-1.html">从CRA将react项目迁移成微前端项目-1</a></p><div class="content"><h1><span id="cong-cra-jiang-react-xiang-mu-qian-yi-cheng-wei-qian-duan-xiang-mu-mu-lu-jie-gou-de-que-ding-he-gou-jian-fang-shi-de-geng-gai">从CRA将react项目迁移成微前端项目 —— 目录结构的确定和构建方式的更改</span><a href="#cong-cra-jiang-react-xiang-mu-qian-yi-cheng-wei-qian-duan-xiang-mu-mu-lu-jie-gou-de-que-ding-he-gou-jian-fang-shi-de-geng-gai" class="header-anchor">#</a></h1>
<div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#ji-chu-zhi-shi">基础知识</a></li>
<li><a href="#wei-shi-me-xu-yao-qian-yi-zhi-wei-qian-duan">为什么需要迁移至微前端？</a></li>
<li><a href="#chai-fen-qian-gong-neng-fen-xi">拆分前功能分析</a></li>
<li><a href="#ji-yu-monorepo-chong-jian-mu-lu-jie-gou">基于monorepo重建目录结构</a>
<ul>
<li><a href="#wei-shi-me-xuan-ze-monorepo">为什么选择monorepo？</a></li>
<li><a href="#chou-chi-de-yuan-ze">抽离的原则</a></li>
<li><a href="#wei-mei-ge-zi-xiang-mu-tian-jia-zi-ji-de-package-json-he-tsconfig-json">为每个子项目添加自己的 package.json 和 tsconfig.json</a></li>
<li><a href="#chong-jian-hou-de-mu-lu-jie-gou">重建后的目录结构</a></li>
</ul></li>
<li><a href="#ru-he-gou-jian-chou-chi-hou-de-xiang-mu">如何构建抽离后的项目</a>
<ul>
<li><a href="#gou-jian-mo-shi-de-xuan-ze-dan-du-da-bao-or-tong-yi-da-bao">构建模式的选择 —— 单独打包 or 统一打包</a></li>
<li><a href="#zai-zhu-xiang-mu-zhong-yin-yong-chou-chi-de-xiang-mu">在主项目中引用抽离的项目</a></li>
<li><a href="#ru-he-zai-dev-huan-jing-wei-chi-chou-chi-hou-de-module-ju-bu-re-geng-xin">如何在dev环境维持抽离后的module局部热更新</a>
<ul>
<li><a href="#kong-zhi-suo-you-xiang-mu-zhong-react-de-ban-ben-dan-yi-shi-li-kong-zhi"><strong>控制所有项目中react的版本&amp;单一实例控制</strong></a></li>
<li><a href="#duo-xiang-mu-context-gong-xiang"><strong>多项目context共享</strong></a></li>
</ul></li>
<li><a href="#ti-gong-alias-gong-neng">提供alias功能</a></li>
<li><a href="#zheng-ti-xiang-mu-typecheck">整体项目typecheck</a></li>
</ul></li>
<li><a href="#hou-xu-ji-hua">后续计划</a>
<ul>
<li><a href="#dev-huan-jing-ti-gong-gou-jian-te-ding-modules-de-ming-ling">dev环境提供构建特定modules的命令</a></li>
<li><a href="#shi-xian-bu-fen-zu-jian-de-zai-xian-re-geng-xin">实现部分组件的在线热更新</a></li>
<li><a href="#yun-xu-zu-jian-zai-yun-xing-shi-tong-shi-cun-zai-duo-ban-ben">允许组件在运行时同时存在多版本</a></li>
</ul></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="ji-chu-zhi-shi">基础知识</span><a href="#ji-chu-zhi-shi" class="header-anchor">#</a></h2>
<p>阅读之前你需要知道的知识包括</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Monorepo">什么是monorepo</a></li>
<li><a target="_blank" rel="noopener" href="https://pnpm.io/">什么是pnpm</a></li>
<li><a target="_blank" rel="noopener" href="https://webpack.js.org/">什么是webpack</a></li>
<li><a target="_blank" rel="noopener" href="https://create-react-app.dev/">什么是create-react-app</a></li>
<li><a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/babel-with-typescript.html">使用babel编译TS项目</a></li>
<li><a target="_blank" rel="noopener" href="https://reactjs.org/warnings/invalid-hook-call-warning.html">错误的调用react hook</a></li>
<li><a target="_blank" rel="noopener" href="https://pnpm.io/workspaces">pnpm workspace</a></li>
</ul>
<h2><span id="wei-shi-me-xu-yao-qian-yi-zhi-wei-qian-duan">为什么需要迁移至微前端？</span><a href="#wei-shi-me-xu-yao-qian-yi-zhi-wei-qian-duan" class="header-anchor">#</a></h2>
<p>随着项目不断迭代，原有的项目体积在不断增大。伴随而来的是功能和依赖数量的快速增长。这使得整体项目将越来越难以维护。 并且如果在一个基础旧的功能上进行更新，我们又希望能做到最小代价的开发、测试和构建的话，那么将原有的单体架构拆分成更小的单元，这将是势在必行的。 本篇文章将会以<a target="_blank" rel="noopener" href="https://github.com/Juggle-Data-View/editor">这个项目</a>的迁移为例，讲解整个迁移过程中的思考和实现。</p>
<h2><span id="chai-fen-qian-gong-neng-fen-xi">拆分前功能分析</span><a href="#chai-fen-qian-gong-neng-fen-xi" class="header-anchor">#</a></h2>
<details open>
<summary style="cursor: pointer;color: red"> 现有目录结构(点击收起/展开) </summary>
<pre>
├── src
│   ├── assets
│   │   ├── fonts
│   │   ├── lib # 需要改动开源包
│   │   │   ├── redux-undo
│   │   │   └── ruler
│   │   └── style
│   │       └── datePicker
│   ├── components
│   │   ├── base 
│   │   ├── common # 系统中的通用组件，包括alert，dialog等
│   │   ├── comps # 系统中的展示数据的组件
│   │   │   ├── codeFragment
│   │   │   ├── commonTitle
│   │   │   ├── datasource
│   │   │   ├── echarts
│   │   │   ├── group
│   │   │   └── _template_
│   │   ├── form # 系统中的表单组件
│   │   └── recursion # 系统中的表单组件生成器
│   │       ├── echarts
│   │       └── widget
│   ├── configurableComponents # 配置化的组件，通用的表单和系统UI主题
│   │   ├── form
│   │   └── theme
│   │       └── overrides
│   ├── helpers # 工具函数，数据解析、后端交互
│   ├── page # 页面结构
│   │   ├── canvas
│   │   └── editor
│   │       ├── Header
│   │       ├── LeftPanel
│   │       ├── RightPanel
│   │       └── User
│   ├── service # 数据模型及处理
│   ├── store # 前端状态管理及本地数据持久化
│   │   ├── DB
│   │   ├── features
│   │   │   └── appSlice
│   │   └── reducers
│   ├── __test__ # 单元测试
│   │   ├── components
│   │   │   └── recursion
│   │   └── utils
│   │       └── MockData
│   ├── @types # 公共类型及包类型overwrite
│   └── utils # 工具函数
  </pre>
</details>
<p>从目录中看，需要抽离的功能包含：</p>
<ul>
<li>部分工具函数
<ul>
<li>一部分同时提供给多个，或只提供给抽离后的项目使用。</li>
</ul></li>
<li>系统中的展示数据的组件
<ul>
<li>期待这些组件可以拥有自己的版本控制</li>
<li>并且可以在线热更新</li>
</ul></li>
<li>系统中的表单组件生成器
<ul>
<li>这里的类型需要提供给数据展示组件</li>
<li>抽离后的项目可能使用，比如鉴权模块</li>
</ul></li>
<li>部分系统中的通用组件
<ul>
<li>alert这类组件会在所有组件被引用</li>
<li>原有通用组件功能增加，需要关注的问题减少</li>
</ul></li>
<li>配置化的组件</li>
</ul>
<h2><span id="ji-yu-monorepo-chong-jian-mu-lu-jie-gou">基于monorepo重建目录结构</span><a href="#ji-yu-monorepo-chong-jian-mu-lu-jie-gou" class="header-anchor">#</a></h2>
<h3><span id="wei-shi-me-xuan-ze-monorepo">为什么选择monorepo？</span><a href="#wei-shi-me-xuan-ze-monorepo" class="header-anchor">#</a></h3>
<p>从以下角度出发：</p>
<ul>
<li>为拆分后的功能提供独立的版本控制和依赖管理。</li>
<li>使得CI可以按照目录维度进行独立的构建，减少构建的时间。</li>
<li>独立构建后产生功能维度的预发版本，可以更加充分的进行测试。</li>
<li>可以简单为抽离后的项目提供统一版本的公共依赖</li>
<li>可以结合 pnpm workspace 减少的坏境创建的link，对本地全局环境的污染</li>
</ul>
<h3><span id="chou-chi-de-yuan-ze">抽离的原则</span><a href="#chou-chi-de-yuan-ze" class="header-anchor">#</a></h3>
<p>这里以系统中Notice组件为例。</p>
<p>Notice组件，顾名思义，这是用来处理系统中所有弹出式通知的组件。只要用户的操作行为，在业务上被定义为需要告知给用户的，都会使用它对消息内容进行展示。它被系统大部分功能依赖，例如现有目录中的：</p>
<ul>
<li><p>表单组件生成器</p></li>
<li><p>数据模型及处理</p></li>
<li><p>前端状态管理</p></li>
<li><p>部分工具函数</p>
<p>如果对该组件进行抽离，可以预见的是会产生大量的文件修改和测试部分重写。即使花费如此高昂的代价，也要对这类组件进行抽离，对这种行为，我一般遵循这几个原则：</p></li>
</ul>
<ol type="1">
<li>该功能需要被其他抽离的组件调用。</li>
<li>该功能未来可能会产生可预见较为频繁的修改。</li>
<li>需要提供在线的热更新。</li>
</ol>
<p>这里着重说一2和3。</p>
<p><strong>2</strong>中提到的 <em>功能可预见较为频繁的修改</em> 我们可以从notice组件的迭代得到答案。</p>
<p>例如，目前系统提供的notice只是提供了单纯的消息展示，并且它的消失时机是几个可选择的常量。如果说后续出现一个消失时机来自不同组件的hook或其他事件的需求。这些碎片化的需求，可能就会使得notice频繁进行发版。</p>
<p>进行拆分之后，我们不必因为某个小功能，对整体系统重新构建。而只需要构建单个功能。</p>
<p>同时结合 <strong>3</strong>之后，我们对此类功能，抛弃传统的webpack将所有依赖打包成同一个bundle(这里先不讨论 async import)，无论是使用<code>script + ESM</code>还是<code>cjs + new Function</code>的模式，我们都能在不进行大规模系统构建的前提下，完成对某个功能更新</p>
<h3><span id="wei-mei-ge-zi-xiang-mu-tian-jia-zi-ji-de-package-json-he-tsconfig-json">为每个子项目添加自己的 package.json 和 tsconfig.json</span><a href="#wei-mei-ge-zi-xiang-mu-tian-jia-zi-ji-de-package-json-he-tsconfig-json" class="header-anchor">#</a></h3>
<p>这是为了让抽离后的项目获得下面的特性：</p>
<ul>
<li>独立的配置管理，如 alias path</li>
<li>独立的依赖，如A组件依赖了a包，但是系统中其他组件没有依赖</li>
<li>独立的版本控制，这里是指 package.json中的version字段</li>
</ul>
<h3><span id="chong-jian-hou-de-mu-lu-jie-gou">重建后的目录结构</span><a href="#chong-jian-hou-de-mu-lu-jie-gou" class="header-anchor">#</a></h3>
<details>
<summary> 整体项目目录结构 </summary>
<pre>
.
├── common # 通用组件
│   ├── codeEditor
│   ├── dynamicImport
│   ├── notice
│   ├── recursion
│   └── theme
├── core # 项目主入口
│   ├── config
│   ├── public
│   ├── scripts
│   └── src
├── dataComp # 需要热更新和运行时存在多版本的组件
│   ├── codeFragment
│   ├── commonTitle
│   ├── datasource
│   ├── echarts
│   └── group
└── workspace
    └── devServer # 本地开发命令集
    </pre>
</details>
<details>
<summary> common下项目的一般结构 </summary>
<pre>
├── package.json
├── pnpm-lock.yaml
├── README.md
├── src
│   ├── index.tsx
│   └── lib.d.ts
└── tsconfig.json    
    </pre>
</details>
<details>
<summary> dataComp下项目的一般结构 </summary>
<pre>
├── package.json
├── pnpm-lock.yaml
├── src
├── tsconfig.json
└── webpack.config.js # 可能用到的独特的配置，将会被merge到运行的webpackconfig中
    </pre>
</details>
<h2><span id="ru-he-gou-jian-chou-chi-hou-de-xiang-mu">如何构建抽离后的项目</span><a href="#ru-he-gou-jian-chou-chi-hou-de-xiang-mu" class="header-anchor">#</a></h2>
<p>当目录重构后，我们需要对原有的构建流程进行改造。由于项目原本是通过<code>create-react-app</code>这个命令创建的，但是后续的修改，不可避免的会对webpack的配置产生大量的修改，所以第一步我们需要运行 <code>eject</code>命令，使得我们可以续改项目的构建配置。 ### 构建模式的选择 —— 单独打包 or 统一打包 运行eject后，我们需要确定对于抽离后的项目，是选择每个项目都配置单独的构建流程，还是使用一个通用的构建方式。</p>
<p>这里出于下面点考虑，我选择了使用通用构建方式：</p>
<ul>
<li><p>开发成本低，不必为每个抽离后的项目，开发单独的webpack配置</p></li>
<li><p>原本是从单体项目中抽离的，所以构建流程大体一致</p></li>
<li><p>更容易控制依赖的版本</p>
<p>同时，我将 <code>/core</code>目录称之为<strong>主项目</strong>，它将提供所有项目的构建配置。</p></li>
</ul>
<h3><span id="zai-zhu-xiang-mu-zhong-yin-yong-chou-chi-de-xiang-mu">在主项目中引用抽离的项目</span><a href="#zai-zhu-xiang-mu-zhong-yin-yong-chou-chi-de-xiang-mu" class="header-anchor">#</a></h3>
<ul>
<li>dev环境的package(重建后目录中<code>common</code>部分)：使用<code>pnpm link</code>创建抽离项目的软连接并引入</li>
<li>dev环境的component(重建后目录中<code>dataComp</code>部分)：调用主项目的webpack进行构建后，通过本地的dev服务发送静态资源文件(bundle.js)，在主项目中使用 <code>new Function</code> 的方式引入</li>
<li>prod环境的package：在主项目中运行 <code>pnpm install</code>, 以module的方式引入。</li>
<li>prod环境的component: CI中在每个项目目录中运行构建命令，通过nginx的location，以目录名称为路由地址，提供静态资源文件(bundle.js)，在主项目中使用 <code>new Function</code> 的方式引入</li>
</ul>
<h3><span id="ru-he-zai-dev-huan-jing-wei-chi-chou-chi-hou-de-module-ju-bu-re-geng-xin">如何在dev环境维持抽离后的module局部热更新</span><a href="#ru-he-zai-dev-huan-jing-wei-chi-chou-chi-hou-de-module-ju-bu-re-geng-xin" class="header-anchor">#</a></h3>
<p>确定构建模式后，为了提供良好的开发体验。我们仍然期望，抽离后的代码在开发环境出现更新时，项目仍能提供局部热更新的能力。</p>
<p>为了实现这个需求，我们需要：</p>
<ol type="1">
<li>扩展主项目webpack的构建范围。</li>
<li>使用<code>link</code>命令，创建一个基于软连接的本地依赖。</li>
</ol>
<p>实现<strong>1</strong>，需要完成向webpack添加： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@returns</span> &#123;<span class="type">string[]</span>&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">resolveAppsRoot</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> commonPath = path.<span class="title function_">resolve</span>(<span class="string">&#x27;../common&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> deps = fs.<span class="title function_">readdirSync</span>(path.<span class="title function_">resolve</span>(<span class="string">&#x27;../common&#x27;</span>));</span><br><span class="line">  <span class="keyword">return</span> deps.<span class="title function_">map</span>(<span class="function">(<span class="params">pathVal</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> path.<span class="title function_">join</span>(commonPath, pathVal);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> &#123;<span class="type">string[]</span>&#125; <span class="variable">mainModulesPath</span></span></span><br><span class="line"><span class="comment">* <span class="doctag">@returns</span> &#123;<span class="type">string[]</span>&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getValidCompilerModulesPath</span> = (<span class="params">mainModulesPath</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> appsRoot = <span class="title function_">resolveAppsRoot</span>();</span><br><span class="line">  <span class="keyword">return</span> mainModulesPath.<span class="title function_">concat</span>(</span><br><span class="line">    appsRoot.<span class="title function_">reduce</span>(<span class="function">(<span class="params">curr, rootPath</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> [...curr, path.<span class="title function_">join</span>(rootPath, <span class="string">&#x27;src&#x27;</span>), path.<span class="title function_">join</span>(rootPath, <span class="string">&#x27;node_modules&#x27;</span>)];</span><br><span class="line">    &#125;, [])</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">appSrc</span></span></span><br><span class="line"><span class="comment">* <span class="doctag">@returns</span> &#123;<span class="type">string[]</span>&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">resolveAppsSrc</span> = (<span class="params">appSrc</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> commonPath = path.<span class="title function_">resolve</span>(<span class="string">&#x27;../common&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> deps = fs.<span class="title function_">readdirSync</span>(path.<span class="title function_">resolve</span>(<span class="string">&#x27;../common&#x27;</span>));</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    appSrc,</span><br><span class="line">    ...deps.<span class="title function_">map</span>(<span class="function">(<span class="params">pathVal</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> path.<span class="title function_">join</span>(commonPath, pathVal, <span class="string">&#x27;src&#x27;</span>);</span><br><span class="line">    &#125;),</span><br><span class="line">  ];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// webpack config modify</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="attr">resolve</span>: &#123;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">      <span class="attr">modules</span>: <span class="title function_">getValidCompilerModulesPath</span>(</span><br><span class="line">        [<span class="string">&#x27;node_modules&#x27;</span>, paths.<span class="property">appNodeModules</span>].<span class="title function_">concat</span>(modules.<span class="property">additionalModulePaths</span> || [])</span><br><span class="line">      ),</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="attr">module</span>:&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.(js|mjs|jsx|ts|tsx)$/</span>,</span><br><span class="line">        <span class="attr">include</span>: isEnvDevelopment ? <span class="title function_">resolveAppsSrc</span>(pathsappSrc) : paths.<span class="property">appSrc</span>,</span><br><span class="line">        <span class="attr">loader</span>: <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;babel-loader&#x27;</span>),</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 这里解释一下这些改动的意义：</p>
<ul>
<li><code>module.rules</code> 的修改, 扩展了webpack的构建范围，可以使用主项目中的babel（支持typescript），编译抽离后的项目。</li>
<li><code>resolve.modules</code> 的修改，是让主项目webpack可以解析抽离后项目的独立依赖。</li>
<li><code>resolveAppsSrc</code> 函数处理抽离后项目的需要编译的路径</li>
<li><code>getValidCompilerModulesPath</code> 数处理抽离后项目的依赖需要编译的路径</li>
</ul>
<h4><span id="kong-zhi-suo-you-xiang-mu-zhong-react-de-ban-ben-amp-dan-yi-shi-li-kong-zhi"><strong>控制所有项目中react的版本&amp;单一实例控制</strong></span><a href="#kong-zhi-suo-you-xiang-mu-zhong-react-de-ban-ben-amp-dan-yi-shi-li-kong-zhi" class="header-anchor">#</a></h4>
<p><strong>step1:</strong> 在项目的根目录下创建<code>pnpm-workspace.yaml</code> 和 <code>package.json</code>。</p>
<p><strong>step2:</strong> 然后在根目录运行如下命令： <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm add -w react react-dom</span><br></pre></td></tr></table></figure> <strong>step3:</strong> 在抽离后的项目(如<code>common/recursion</code>)目录中运行</p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm add --save-peer react react-dom</span><br></pre></td></tr></table></figure> <strong>step4:</strong> webpack的修改如下 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="attr">resolve</span>: &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="attr">alias</span>: &#123;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">      <span class="attr">react</span>: path.<span class="title function_">resolve</span>(<span class="string">&#x27;../node_modules/react&#x27;</span>),</span><br><span class="line">      <span class="string">&#x27;react-dom&#x27;</span>: path.<span class="title function_">resolve</span>(<span class="string">&#x27;../node_modules/react-dom&#x27;</span>),</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>逐条解释它们的作用</p>
<ul>
<li>step1: 提供一个 pnpm 的 workspace。使得抽离后的项目中的依赖可以从工作区共享。减少抽离后的项目的整体体积。</li>
<li>step2:将react添加到工作区中</li>
<li>step3:将抽离后项目的react依赖，从生产环境构建时剔除</li>
<li>step4:为抽离后的项目提供了单一实例的react和react-dom，这在固定了react版本的同时，解决了react hook要求项目只能包含一个react实例的问题。但这里没有完全解决，context共享问题，在多个项目共享一个带有<code>useContext</code>的依赖时，会出现<code>undefined</code>的问题</li>
</ul>
<h4><span id="duo-xiang-mu-context-gong-xiang"><strong>多项目context共享</strong></span><a href="#duo-xiang-mu-context-gong-xiang" class="header-anchor">#</a></h4>
<p>以formik为例，需要修改主项目的webpack <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="attr">resolve</span>: &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="attr">alias</span>: &#123;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">      <span class="attr">formik</span>: path.<span class="title function_">resolve</span>(<span class="string">&#x27;../node_modules/formik&#x27;</span>),</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 一些使用新版 CRA 的项目还需要修改<code>ModuleScopePlugin</code>，来放开对于依赖范围的检测</p>
<h3><span id="ti-gong-alias-gong-neng">提供alias功能</span><a href="#ti-gong-alias-gong-neng" class="header-anchor">#</a></h3>
<p>我们在开发中，经常会遇到引用一些公共函数的需求，但是，如果引用的层级太深，难免会出现形如 <code>import moduleFunc from '../../../../../utils/getData'</code>的路径。这样的路径，可读性差，并且如果出现整体目录迁移并且引用该功能的文件非常，会使得这些文件都出现修改。</p>
<p>所以一般我们都会使用形如<code>import moduleFunc from @utils/getData;</code>的方式进行优化。</p>
<p>但如果在抽离后的项目使用这样的特性，需要对主项目的webpack再做一些更改，这是因为由于构建命令的执行目录在主项目下，它们的相对路径，并没有对应到抽离后的项目目录。需要对webpack做出如下修改： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//webpack config</span></span><br><span class="line"> &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="attr">resolve</span>: &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="attr">alias</span>: &#123;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">      ...(<span class="title function_">getValidCompilerPaths</span>(modules.<span class="property">webpackAliases</span>) || &#123;&#125;),</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 获取alias真实的编译路径</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> &#123;<span class="type">Record&lt;string,string&gt;</span>&#125; <span class="variable">alias</span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@returns</span> &#123;<span class="type">Record&lt;string,string&gt;</span>&#125;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">getValidCompilerPaths</span> = (<span class="params">mainAlias</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> appsRoot = <span class="title function_">resolveAppsRoot</span>();</span><br><span class="line">    <span class="keyword">return</span> appsRoot.<span class="title function_">reduce</span>(<span class="function">(<span class="params">curr, next</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> alias = <span class="title function_">handleTSAlias</span>(next);</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...alias,</span><br><span class="line">        ...curr,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;, mainAlias);</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@typedef</span> &#123;<span class="type">object</span>&#125; <span class="variable">Options</span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@property</span> &#123;<span class="type">string</span>&#125; options.baseUrl</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@property</span> &#123;<span class="type">&#123;</span></span></span><br><span class="line"><span class="type"><span class="comment">  *    [key: string]: string[]</span></span></span><br><span class="line"><span class="type"><span class="comment">  *  </span>&#125;&#125; options.paths</span></span><br><span class="line"><span class="comment">  * 获取webpack使用的alias的绝对路径</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> &#123;<span class="type">Options</span>&#125; <span class="variable">options</span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> &#123;<span class="type">&#123;</span></span></span><br><span class="line"><span class="type"><span class="comment">  *  rootPath: string;</span></span></span><br><span class="line"><span class="type"><span class="comment">  * </span>&#125;&#125; extension</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">getWebpackAliases</span>(<span class="params">options = &#123;&#125;, extension = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; baseUrl, <span class="attr">paths</span>: aliasPath &#125; = options;</span><br><span class="line">    <span class="keyword">const</span> &#123; rootPath &#125; = extension;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> appPath = rootPath ? rootPath : paths.<span class="property">appPath</span>;</span><br><span class="line">    <span class="keyword">const</span> appSrc = rootPath ? path.<span class="title function_">join</span>(rootPath, baseUrl) : paths.<span class="property">appSrc</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!baseUrl) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> baseUrlResolved = path.<span class="title function_">resolve</span>(appPath, baseUrl);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (path.<span class="title function_">relative</span>(appPath, baseUrlResolved) === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">src</span>: appSrc,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isEmpty</span>(aliasPath)) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> aliasPathKeys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(aliasPath);</span><br><span class="line">    <span class="keyword">const</span> result = aliasPathKeys.<span class="title function_">reduce</span>(<span class="function">(<span class="params">prev, curr</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> aliasPathArr = aliasPath[curr];</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...prev,</span><br><span class="line">        [curr.<span class="title function_">replace</span>(<span class="string">&#x27;/*&#x27;</span>, <span class="string">&#x27;&#x27;</span>)]: path.<span class="title function_">resolve</span>(appSrc, aliasPathArr[<span class="number">0</span>].<span class="title function_">replace</span>(<span class="string">&#x27;/*&#x27;</span>, <span class="string">&#x27;&#x27;</span>)),</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;, &#123;&#125;);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 获取对应项目的tsconfig</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">rootPath</span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@returns</span> &#123;<span class="type">Record&lt;string, string[]&gt;</span>&#125;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">getTSOption</span> = (<span class="params">rootPath</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> appTsConfig = path.<span class="title function_">join</span>(rootPath, <span class="string">&#x27;tsconfig.json&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> hasTsConfig = fs.<span class="title function_">existsSync</span>(appTsConfig);</span><br><span class="line">    <span class="keyword">if</span> (!hasTsConfig) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;sub-project tsconfig is not exist&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> ts = <span class="built_in">require</span>(resolve.<span class="title function_">sync</span>(<span class="string">&#x27;typescript&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">basedir</span>: paths.<span class="property">appNodeModules</span>,</span><br><span class="line">    &#125;));</span><br><span class="line">    <span class="keyword">const</span> config = ts.<span class="title function_">readConfigFile</span>(appTsConfig, ts.<span class="property">sys</span>.<span class="property">readFile</span>).<span class="property">config</span>;</span><br><span class="line">    <span class="keyword">return</span> config.<span class="property">compilerOptions</span> || &#123;&#125;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 处理TS中声明的alias，使得tsconfig中的alias能与webpack对应上</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">rootPath</span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@returns</span> &#123;<span class="type">string</span>&#125;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleTSAlias</span> = (<span class="params">rootPath</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getWebpackAliases</span>(<span class="title function_">getTSOption</span>(rootPath), &#123; rootPath &#125;);</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure></p>
<h3><span id="zheng-ti-xiang-mu-typecheck">整体项目typecheck</span><a href="#zheng-ti-xiang-mu-typecheck" class="header-anchor">#</a></h3>
<p>在上一个小节中，完成对alias的解析，但是，会出现ts类型错误，如：<code>无法找到模块@utils</code>。这是因为上面我们只解决了，webpack的编译打包流程，但类型检查仍没有提供抽离后的项目和其目录的对应关系。</p>
<p>这里我们需要将类型检测的范围扩展到整体项目范围，并提供对应的文件路径关系 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack config </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="attr">plugins</span>: &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ForkTsCheckerWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">      <span class="attr">typescript</span>: &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="attr">configOverwrite</span>: &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">          <span class="attr">compilerOptions</span>: &#123;</span><br><span class="line">            <span class="attr">references</span>: <span class="title function_">getTypeCheckPaths</span>(),</span><br><span class="line">          &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getTypeCheckPaths</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> appsRoot = <span class="title function_">resolveAppsRoot</span>();</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">formatPaths</span> = (<span class="params">aliasPath, appRoot</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">keys</span>(aliasPath).<span class="title function_">reduce</span>(<span class="function">(<span class="params">curr, next</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> item = aliasPath[next];</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...curr,</span><br><span class="line">        [next]: path.<span class="title function_">join</span>(appRoot, item[<span class="number">0</span>]),</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;, &#123;&#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> result = appsRoot.<span class="title function_">reduce</span>(<span class="function">(<span class="params">curr, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//getTSOption的实现参考上面</span></span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">paths</span>: aliasPath &#125; = <span class="title function_">getTSOption</span>(next);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isEmpty</span>(aliasPath)) &#123;</span><br><span class="line">      <span class="keyword">return</span> curr;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; ...curr, ...<span class="title function_">formatPaths</span>(aliasPath, next) &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;&#125;);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h2><span id="hou-xu-ji-hua">后续计划</span><a href="#hou-xu-ji-hua" class="header-anchor">#</a></h2>
<h3><span id="dev-huan-jing-ti-gong-gou-jian-te-ding-modules-de-ming-ling">dev环境提供构建特定modules的命令</span><a href="#dev-huan-jing-ti-gong-gou-jian-te-ding-modules-de-ming-ling" class="header-anchor">#</a></h3>
<p>上面的一系列改动，解决了抽离后整体项目的构建问题，但目前的构建方式仍然是全量进行构建，预期是通过一个可交互的command，让用户可以选择构建那些抽离后的项目。没被选中的，使用<code>pnpm add &lt;package-names&gt;</code>，从公共仓库安装到主项目中。</p>
<h3><span id="shi-xian-bu-fen-zu-jian-de-zai-xian-re-geng-xin">实现部分组件的在线热更新</span><a href="#shi-xian-bu-fen-zu-jian-de-zai-xian-re-geng-xin" class="header-anchor">#</a></h3>
<p><code>dataComp</code>中的项目均需要提供在线热更新。</p>
<p>dev环境将提供一个dev server提供编译后的<code>bundle.js</code>。</p>
<p>prod环境将使用nginx为不同项目的编译产物提供静态服务。</p>
<p>主项目都将使用 <code>fetch + new Fucntion</code>的方式引入此类组件。</p>
<h3><span id="yun-xu-zu-jian-zai-yun-xing-shi-tong-shi-cun-zai-duo-ban-ben">允许组件在运行时同时存在多版本</span><a href="#yun-xu-zu-jian-zai-yun-xing-shi-tong-shi-cun-zai-duo-ban-ben" class="header-anchor">#</a></h3>
<p><code>dataComp</code>中的项目对于不同的用户，可能同时需要存在不同的版本。这需要在它的URL信息中加入版本信息，用来加载不同版本的编译产物。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-11-30T14:33:43.000Z" title="11/30/2022, 10:33:43 PM">2022-11-30</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-09-10T14:10:41.225Z" title="9/10/2023, 10:10:41 PM">2023-09-10</time></span><span class="level-item"><a class="link-muted" href="/categories/project/">project</a></span><span class="level-item">11 minutes read (About 1581 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/JS%E5%BC%80%E5%8F%91%E4%B8%AD%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%8F%E9%AA%8C.html">JS开发中函数式编程的一些经验</a></p><div class="content"><h1><span id="js-kai-fa-zhong-han-shu-shi-bian-cheng-de-yi-xie-jing-yan">JS开发中函数式编程的一些经验</span><a href="#js-kai-fa-zhong-han-shu-shi-bian-cheng-de-yi-xie-jing-yan" class="header-anchor">#</a></h1>
<div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#ji-chu-zhi-shi">基础知识</a></li>
<li><a href="#jian-shao-fu-zuo-yong">减少副作用</a>
<ul>
<li><a href="#wei-shi-me-yao-jian-shao-fu-zuo-yong">为什么要减少副作用</a></li>
<li><a href="#shi-yong-han-shu-ti-dai-yi-xie-jian-dan-de-fu-zhi">使用函数替代一些简单的赋值</a></li>
<li><a href="#dui-yu-yin-yong-lei-xing-de-xiu-gai">对于引用类型的修改</a></li>
</ul></li>
<li><a href="#gao-jie-guo-cheng-zi-shang-er-xia-de-she-ji">高阶过程，自上而下的设计</a></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="ji-chu-zhi-shi">基础知识</span><a href="#ji-chu-zhi-shi" class="header-anchor">#</a></h2>
<p>阅读之前你需要知道的知识包括</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-hans/%E5%89%AF%E4%BD%9C%E7%94%A8_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)#:~:text=%E5%9C%A8%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6%E4%B8%AD%EF%BC%8C%E5%87%BD%E6%95%B0,%E6%80%A7%E4%B8%8E%E5%8F%AF%E7%A7%BB%E6%A4%8D%E6%80%A7%E3%80%82">什么是副作用</a></p></li>
<li><p><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh/%E9%AB%98%E9%98%B6%E5%87%BD%E6%95%B0">什么是高阶过程</a> ## 减少副作用 以下是wiki对于副作用的定义。 &gt; 在计算机科学中，函数副作用指当调用函数时，除了返回可能的函数值之外，还对主调用函数产生附加的影响。例如修改全局变量（函数外的变量），修改参数，向主调方的终端、管道输出字符或改变外部存储信息等。<br> &gt;在某些情况下函数副作用会给程序设计带来不必要的麻烦，给程序带来十分难以查找的错误，并降低程序的可读性与可移植性。严格的函数式语言要求函数必须无任何副作用，但功能性静态函数本身的目的正是产生某些副作用。在生命科学中，副作用往往带有贬义，但在计算机科学中，副作用有时正是“主要作用”。 ### 为什么要减少副作用 在数学中我们会遇到这样的函数<code>y=x+1</code>，一旦我们确定了<strong>x</strong>的值，那么无论我们在什么时候使用这个函数，得到的<strong>y</strong>的值始终不会发生变化。<br> 即使，更为复杂的数学公式，比如 <span class="math display">\[
\begin{align*}
\frac{n(n-1)}{2n}
\end{align*}
\]</span> 也符合上述规律。 在程序开发中，我们也会定义一些函数，但这里面的一些函数会随着不同时间和上下文调用出现变化。一个简单的例子： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> variable = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> printVariable () =&gt; &#123;</span><br><span class="line">  variable++;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(variable)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">printVariable</span>() <span class="comment">//输出: 2</span></span><br><span class="line"><span class="title function_">printVariable</span>() <span class="comment">//输出: 3</span></span><br></pre></td></tr></table></figure> 一旦这样的函数被大量使用，尤其是作为公共函数在多人开发使用的时候时，会存在一些隐患。用下面的代码来说明这个问题： <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// util.ts</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">User</span> = &#123;</span><br><span class="line">  <span class="attr">root</span>: <span class="string">&#x27;normal&#x27;</span> | <span class="string">&#x27;admin&#x27;</span> | <span class="string">&#x27;guest&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">users</span>:<span class="title class_">User</span>[] = [&#123;</span><br><span class="line">  <span class="attr">root</span>: <span class="string">&#x27;guest&#x27;</span></span><br><span class="line">&#125;,&#123;</span><br><span class="line">  <span class="attr">root</span>: <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">&#125;,&#123;</span><br><span class="line">  <span class="attr">root</span>: <span class="string">&#x27;normal&#x27;</span></span><br><span class="line">&#125;,];</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">converAllUsersTonNormal</span> = (<span class="params"></span>) =&gt;&#123;</span><br><span class="line">  users.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(item.<span class="property">root</span> !== cacheUser.<span class="property">root</span>)&#123;</span><br><span class="line">      item.<span class="property">root</span> === <span class="string">&#x27;normal&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// developerA.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123;users&#125; <span class="keyword">from</span> <span class="string">&#x27;@path/util&#x27;</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isAllUsersNormal</span> = (<span class="params"></span>) =&gt;&#123;</span><br><span class="line">  <span class="keyword">return</span> users.<span class="title function_">every</span>(<span class="function"><span class="params">item</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(user.<span class="property">root</span> !== <span class="string">&#x27;normal&#x27;</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// developerA.ts</span></span><br><span class="line"><span class="title function_">isAllUsersNormal</span>() <span class="comment">// converAllUsersTonNormal没有在任何地方调用,输出 false</span></span><br><span class="line"><span class="title function_">isAllUsersNormal</span>() <span class="comment">// converAllUsersTonNormal被调用过,输出 true</span></span><br></pre></td></tr></table></figure> 显而易见的是，在上面的例子中，如果无法确定两个开发者提供的函数调用次数，那么最终我们得到的结果将是无法确定的。<br> 所以，减少<strong>副作用</strong>就可以减少上述的情况出现，尽可能的降低bug的出现。以下我列举了两个减少副作用的方式。</p></li>
</ul>
<h3><span id="shi-yong-han-shu-ti-dai-yi-xie-jian-dan-de-fu-zhi">使用函数替代一些简单的赋值</span><a href="#shi-yong-han-shu-ti-dai-yi-xie-jian-dan-de-fu-zhi" class="header-anchor">#</a></h3>
<p>比如下面的代码 <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> response = &#123;</span><br><span class="line">  <span class="attr">code</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getResponseMsg</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> result = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span>(respose.<span class="property">code</span> === <span class="number">200</span>)&#123;</span><br><span class="line">    result = <span class="string">&#x27;success&#x27;</span></span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    result = <span class="string">&#x27;error: &#x27;</span></span><br><span class="line">    <span class="keyword">if</span>(respose.<span class="property">code</span> === <span class="number">404</span>)&#123;</span><br><span class="line">      result += <span class="string">&#x27;url not found&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(respose.<span class="property">code</span> === <span class="number">500</span>)&#123;</span><br><span class="line">      result += <span class="string">&#x27;server has error&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    result += <span class="string">&#x27;unknown error&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 用函数替代后</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getResponseMsgFunctional</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span>(respose.<span class="property">code</span> === <span class="number">200</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;success&#x27;</span></span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">getErrorMsg</span> =(<span class="params">msg:<span class="built_in">string</span></span>)=&gt; <span class="string">&#x27;error: &#x27;</span>+ msg;</span><br><span class="line">    <span class="keyword">if</span>(respose.<span class="property">code</span> === <span class="number">404</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">getErrorMsg</span>(<span class="string">&#x27;url not found&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(respose.<span class="property">code</span> === <span class="number">500</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">getErrorMsg</span>(<span class="string">&#x27;server has error&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getErrorMsg</span>(<span class="string">&#x27;unknown error&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 这里可以看到 <code>getResponseMsgFunctional</code>在 <code>code !== 200</code>时的处理，用<code>getErrorMsg</code>替换了原本，对<code>result</code>重新赋值的操作。再消除了副作用的同时，也增强了代码的可拓展性和内聚程度，因为一旦之后的有新的需求，可能对<code>errorMsg</code>的前缀产生影响， 那么后续的更改，可以完全在<code>getErrorMsg</code>中进行。</p>
<h3><span id="dui-yu-yin-yong-lei-xing-de-xiu-gai">对于引用类型的修改</span><a href="#dui-yu-yin-yong-lei-xing-de-xiu-gai" class="header-anchor">#</a></h3>
<p>在JS中，引用类型的修改从来都是非常容易出现BUG的操作之一。比如，一个引用类型的变量暴露给多个开发者使用。 这里推荐用函数替代对于引用的直接修改。比较成熟的方案如<a target="_blank" rel="noopener" href="https://redux.js.org/">redux</a>。<br> 虽然我们用诸如redux的方案解决了直接修改引用类型，带来的不确定性问题。但同时，这样的设计也存在一些性能问题。<br> 主流的前端框架中，如果一个组件的props是一个引用类型，那么确定该组件是否需要更新，一般都是进行引用的直接对比。这时，如果一个深层redux对象被共享给了多个组件，那么某一层的更新，可能会引起其他组件的不必要更新。为了解决这个问题，我们可能需要做很多额外的 工作，来确定该组件是否真的需要更新。</p>
<h2><span id="gao-jie-guo-cheng-zi-shang-er-xia-de-she-ji">高阶过程，自上而下的设计</span><a href="#gao-jie-guo-cheng-zi-shang-er-xia-de-she-ji" class="header-anchor">#</a></h2>
<p>在开发过程中，我们不可避免的会遇到一些非常复杂的需求。可能是需要重构一个关联了很多其他模块的函数，可能是深度遍历一个复杂对象并根据每层对象的一些属性调用一些其他的函数。 遇到这些复杂的情况，我们可以用高阶过程去解决这类问题。 一个简单的例子，用递归便利数组。 <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">arrayIterator</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  arr: <span class="built_in">any</span>[],</span></span><br><span class="line"><span class="params">  condition: (...arg?: <span class="built_in">any</span>[])=&gt; <span class="built_in">boolean</span>, </span></span><br><span class="line"><span class="params">  action: (...arg?: <span class="built_in">any</span>[])=&gt;<span class="built_in">void</span>,</span></span><br><span class="line"><span class="params"></span>) =&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_">condition</span>())&#123;</span><br><span class="line">      <span class="title function_">action</span>()</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">arrayIterator</span>(arr.<span class="title function_">slice</span>(<span class="number">1</span>),condition,action)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 事实上我们可以这样看待上面的代码 <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">dataOperation</span> = (<span class="params">data: <span class="built_in">any</span></span>) =&gt;&#123;</span><br><span class="line">  <span class="comment">// do something for generate `newData`</span></span><br><span class="line">  <span class="keyword">return</span> newData</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">arrayIterator</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  data: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  condition: (...arg?: <span class="built_in">any</span>[])=&gt; <span class="built_in">boolean</span>, </span></span><br><span class="line"><span class="params">  recursionAction?: (...arg?: <span class="built_in">any</span>[])=&gt;<span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  recursionEndAction?: (...arg?: <span class="built_in">any</span>[])=&gt;<span class="built_in">any</span>,</span></span><br><span class="line"><span class="params"></span>) =&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_">condition</span>())&#123;</span><br><span class="line">      <span class="title function_">recursionAction</span>()</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">arrayIterator</span>(<span class="title function_">dataOperation</span>(data),condition,action)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">recursionEndAction</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 这意味着，大部分递归都可以用这样的方式进行拆分。拆分后的递归将拥有很强的拓展性。而且维护每个部分的心智负担将降低，修改某个部分只需要关注函数内部逻辑，而不用整体的考虑。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-08-08T11:51:42.000Z" title="8/8/2022, 7:51:42 PM">2022-08-08</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-09-10T14:10:41.230Z" title="9/10/2023, 10:10:41 PM">2023-09-10</time></span><span class="level-item"><a class="link-muted" href="/categories/project/">project</a></span><span class="level-item">7 minutes read (About 1116 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/%E5%A2%9E%E9%87%8F%E8%BF%90%E8%A1%8CE2E%E6%B5%8B%E8%AF%95.html">增量运行E2E测试</a></p><div class="content"><p><img src="/images/e2e-testing-banner.png"></p>
<div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#ji-chu-zhi-shi">基础知识</a></li>
<li><a href="#yao-jie-jue-de-wen-ti">要解决的问题</a></li>
<li><a href="#wen-ti-chai-fen-fen-xi">问题拆分 &amp; 分析</a>
<ul>
<li><a href="#wen-ti-fen-xi">问题分析</a></li>
</ul></li>
<li><a href="#jie-jue-fang-an">解决方案</a>
<ul>
<li><a href="#huo-qu-yong-yu-dui-bi-de-ji-chu-commitid">获取用于对比的基础commitID</a></li>
<li><a href="#huo-qu-liang-ge-commit-zhi-jian-de-geng-xin">获取两个Commit之间的更新</a></li>
<li><a href="#zhi-yun-xing-geng-xin-de-wen-jian-bing-da-yin-yun-xing-guo-cheng-zhong-de-ri-zhi-xiao-xi">只运行更新的文件并打印运行过程中的日志消息</a></li>
</ul></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="ji-chu-zhi-shi">基础知识</span><a href="#ji-chu-zhi-shi" class="header-anchor">#</a></h2>
<p>阅读之前你需要知道的知识包括</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://katalon.com/resources-center/blog/end-to-end-e2e-testing">什么是E2E测试</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.cypress.io/guides/overview/why-cypress">E2E测试框架Cypress</a></li>
<li><code>Git</code>常用命令</li>
<li><code>nodejs</code>基础知识</li>
</ul>
<h2><span id="yao-jie-jue-de-wen-ti">要解决的问题</span><a href="#yao-jie-jue-de-wen-ti" class="header-anchor">#</a></h2>
<p>随着项目不断的迭代，新的功能在增加，旧的功能也逐渐被更新。这导致E2E测试的体量在不断的增大。 但是，我们的每次修改不一定会涉及所有的E2E测试。所以，我们是否可以做到只运行本次commit影响的E2E？</p>
<h2><span id="wen-ti-chai-fen-amp-fen-xi">问题拆分 &amp; 分析</span><a href="#wen-ti-chai-fen-amp-fen-xi" class="header-anchor">#</a></h2>
<p>我将问题拆分为下面几个子问题:</p>
<ol type="1">
<li>如何界定作为对比的基础commit</li>
<li>如何获取这个commit的id</li>
<li>如何获取本次commit和基础commit之间的更新</li>
<li>如何只运行更新的文件并打印运行过程中的日志消息</li>
</ol>
<h3><span id="wen-ti-fen-xi">问题分析</span><a href="#wen-ti-fen-xi" class="header-anchor">#</a></h3>
<ul>
<li><strong>对于问题1：</strong>
<ul>
<li>通常情况：一般我们需要对比的是本次<code>commit</code>和当前分支刚被创建出时的<code>commit</code>，这是由于，我们的分支一般会从最新的<code>master</code>分支获取，而<code>master</code>分支中的E2E在大部分情况下，都是已经被验证过的。</li>
<li>和特定commit对比：一些需要和特定<code>commit</code>做对比以排查特定更改，引起的bug时。这里特定的<code>commitID</code>，需要我们在commit message中加入特定的内容，进行标记。</li>
<li>运行全部的E2E：项目正式更新至线上时，还是期待完整的E2E测试，能为我们带来高的可用性。这里运行全部的E2E，需要我们在commit message中加入特定的内容，进行标记。</li>
</ul></li>
<li><strong>对于问题2和3：</strong> 使用<code>nodejs</code>的<code>child_process</code>模块调度<code>Git</code>命令，并使用正则的方式获取需要的内容。</li>
<li><strong>对于问题4：</strong> 使用<code>nodejs</code>的<code>child_process</code>模块调度<code>Cypress</code>命令，并将输出使用<code>Steam</code>进行实时输出</li>
</ul>
<h2><span id="jie-jue-fang-an">解决方案</span><a href="#jie-jue-fang-an" class="header-anchor">#</a></h2>
<h3><span id="huo-qu-yong-yu-dui-bi-de-ji-chu-commitid">获取用于对比的基础commitID</span><a href="#huo-qu-yong-yu-dui-bi-de-ji-chu-commitid" class="header-anchor">#</a></h3>
<ul>
<li><p><strong>对于通常情况使用</strong> <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">getBranchFirstCommitID</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt;(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// compare with master</span></span><br><span class="line">    <span class="title function_">exec</span>(<span class="string">&#x27;git cherry -v master&#x27;</span>, <span class="function">(<span class="params">err, data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="title function_">rej</span>(err);</span><br><span class="line">      <span class="keyword">const</span> dataArr = data.<span class="title function_">split</span>(<span class="string">&#x27;\n&#x27;</span>) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">      <span class="keyword">const</span> commitContent = dataArr[<span class="number">0</span>].<span class="title function_">split</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="title function_">res</span>(commitContent[<span class="number">1</span>]);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>对于和特定commit对比的情况使用</strong> <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">getCurrentCommit</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt;(<span class="function">(<span class="params">res, rej</span>) =&gt;</span></span><br><span class="line">    <span class="title function_">exec</span>(<span class="string">`git log -1`</span>, <span class="function">(<span class="params">err, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="title function_">rej</span>(stderr);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">res</span>(stdout);</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getCompareCommitID</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> commitContent = <span class="keyword">await</span> <span class="title function_">getCurrentCommit</span>();</span><br><span class="line">  <span class="keyword">const</span> regx = <span class="regexp">/\[Compare: (.+?)\]/</span>;</span><br><span class="line">  <span class="keyword">if</span> (!regx.<span class="title function_">test</span>(commitContent)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">getBranchFirstCommitID</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> resultArray = commitContent.<span class="title function_">match</span>(regx) <span class="keyword">as</span> <span class="title class_">RegExpMatchArray</span>;</span><br><span class="line">  <span class="keyword">return</span> resultArray[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure> 这里如果运行<code>getCompareCommitID</code>后，得到返回值为<code>'ALL'</code>的时候，就会运行所有的E2E测试了</p></li>
</ul>
<h3><span id="huo-qu-liang-ge-commit-zhi-jian-de-geng-xin">获取两个Commit之间的更新</span><a href="#huo-qu-liang-ge-commit-zhi-jian-de-geng-xin" class="header-anchor">#</a></h3>
<p><strong>这里我们约定，所有的E2E文件的路径中都会携带<code>cypress</code>这个字符</strong> <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getDiffFlies</span> = (<span class="params">baseCommitID: <span class="built_in">string</span>, commitID: <span class="built_in">string</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt;(<span class="function">(<span class="params">res, rej</span>) =&gt;</span></span><br><span class="line">    <span class="title function_">exec</span>(<span class="string">`git diff --name-only <span class="subst">$&#123;baseCommitID&#125;</span> <span class="subst">$&#123;commitID&#125;</span>`</span>, <span class="function">(<span class="params">err, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="title function_">rej</span>(stderr);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">res</span>(stdout);</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getCommitID</span> = (<span class="params">index: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt;(<span class="function">(<span class="params">res, rej</span>) =&gt;</span></span><br><span class="line">    <span class="title function_">exec</span>(<span class="string">`git show HEAD~<span class="subst">$&#123;index&#125;</span> --pretty=format:&quot;%h&quot; --no-patch`</span>, <span class="function">(<span class="params">err, stdout</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="title function_">rej</span>(err);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">res</span>(stdout);</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//一些特殊的项目结构下，项目中可能存在多个子系统，所以这里需要匹配特定的路径</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getProjectDiffFiles</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> compareCommitID = <span class="keyword">await</span> <span class="title function_">getCompareCommitID</span>();</span><br><span class="line">    <span class="keyword">const</span> currentCommitID = <span class="keyword">await</span> <span class="title function_">getCommitID</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (compareCommitID === <span class="string">&#x27;ALL&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// it will run all tests</span></span><br><span class="line">      <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> diffFiles = (<span class="keyword">await</span> <span class="title function_">getDiffFlies</span>(currentCommitID, compareCommitID)).<span class="title function_">split</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> currentProjectDiffFile = diffFiles</span><br><span class="line">      .<span class="title function_">filter</span>(<span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;dir&#125; = <span class="title function_">parse</span>(file);</span><br><span class="line">        <span class="keyword">const</span> currentDirArr = __dirname.<span class="title function_">split</span>(sep);</span><br><span class="line">        <span class="keyword">const</span> currentDir = currentDirArr[currentDirArr.<span class="property">length</span> - <span class="number">2</span>] <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">        <span class="keyword">if</span> (dir.<span class="title function_">includes</span>(currentDir) &amp;&amp; dir.<span class="title function_">includes</span>(<span class="string">&#x27;cypress&#x27;</span>)) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">map</span>(<span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">join</span>(...file.<span class="title function_">split</span>(sep).<span class="title function_">slice</span>(<span class="number">2</span>)) <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    <span class="keyword">return</span> currentProjectDiffFile;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(error); <span class="comment">// eslint-disable-line</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;get commit id is fail&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h3><span id="zhi-yun-xing-geng-xin-de-wen-jian-bing-da-yin-yun-xing-guo-cheng-zhong-de-ri-zhi-xiao-xi">只运行更新的文件并打印运行过程中的日志消息</span><a href="#zhi-yun-xing-geng-xin-de-wen-jian-bing-da-yin-yun-xing-guo-cheng-zhong-de-ri-zhi-xiao-xi" class="header-anchor">#</a></h3>
<p>nodejs的child_process模块提供了多种方式运行命令，一般情况下使用exec，但由于exec的输出将会在命令完全运行后才输出，并且一般的CI中，都会设置每一步的响应时间。如果使用exec，有可能会由于E2E时间过长，导致超时。 所以，这里我使用spawn，它将会实时的输出命令的运行日志。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">testRunner</span> = (<span class="params">specPath: <span class="built_in">string</span>[]</span>) =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;It will run test&#x27;</span>, specPath.<span class="title function_">join</span>(<span class="string">&#x27;,&#x27;</span>)); <span class="comment">// eslint-disable-line</span></span><br><span class="line">  <span class="keyword">const</span> runner = <span class="title function_">spawn</span>(<span class="string">&#x27;cypress&#x27;</span>, [<span class="string">&#x27;run&#x27;</span>, <span class="string">&#x27;--headless&#x27;</span>, <span class="string">&#x27;--spec&#x27;</span>, specPath.<span class="title function_">join</span>(<span class="string">&#x27;,&#x27;</span>)]);</span><br><span class="line">  runner.<span class="property">stderr</span>.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (data) <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>()); <span class="comment">// eslint-disable-line</span></span><br><span class="line">  &#125;);</span><br><span class="line">  runner.<span class="property">stdout</span>.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>()); <span class="comment">// eslint-disable-line</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">main</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> testPath = <span class="keyword">await</span> <span class="title function_">getProjectDiffFiles</span>();</span><br><span class="line">  <span class="title function_">testRunner</span>(testPath);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>至此就完成了增量的运行E2E测试。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-08-07T15:00:31.000Z" title="8/7/2022, 11:00:31 PM">2022-08-07</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-09-10T14:10:41.223Z" title="9/10/2023, 10:10:41 PM">2023-09-10</time></span><span class="level-item"><a class="link-muted" href="/categories/project/">project</a></span><span class="level-item">7 minutes read (About 1030 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/%20monorepo%E7%BB%93%E6%9E%84%E4%B8%8B%E5%90%AF%E5%8A%A8react%E9%A1%B9%E7%9B%AE%E5%B1%80%E9%83%A8%E7%83%AD%E6%9B%B4%E6%96%B0.html">monorepo结构下启动react项目局部热更新</a></p><div class="content"><p><img src="/images/monorepo-react-banner.jpeg"></p>
<div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#ji-chu-zhi-shi">基础知识</a></li>
<li><a href="#yu-dao-de-wen-ti">遇到的问题</a></li>
<li><a href="#wen-ti-yuan-yin-fen-xi">问题原因&amp;分析</a></li>
<li><a href="#ru-he-jie-jue-wen-ti">如何解决问题？</a>
<ul>
<li><a href="#duo-zi-xiang-mu-dan-du-kai-fa-shi-ru-he-que-ding-react-ban-ben-yi-ji-ru-he-bao-zheng-zhu-xiang-mu-jia-zai-zi-xiang-mu-zuo-wei-zu-jian-shi-er-zhe-gong-yong-tong-yi-ge-react-shi-li">多子项目单独开发时，如何确定react版本，以及如何保证主项目加载子项目作为组件时，二者公用同一个react实例</a></li>
<li><a href="#kai-fa-shi-ru-he-chu-li-hu-xiang-cun-zai-yi-lai-zi-xi-tong">开发时，如何处理互相存在依赖子系统</a></li>
<li><a href="#wai-zhi-hua-jia-zai-react-react-dom-shi-hot-reload-shi-xiao">外置化加载react&amp;react-dom时，hot-reload失效</a></li>
</ul></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="ji-chu-zhi-shi">基础知识</span><a href="#ji-chu-zhi-shi" class="header-anchor">#</a></h2>
<p>阅读之前你需要知道的知识包括</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Monorepo">什么是monorepo</a></li>
<li><a target="_blank" rel="noopener" href="https://semaphoreci.com/blog/what-is-monorepo#monorepo-culture">monorepo的一些应用场景</a></li>
<li>webpack的配置的编写</li>
<li><a target="_blank" rel="noopener" href="https://pnpm.io/">什么是pnpm</a></li>
</ul>
<h2><span id="yu-dao-de-wen-ti">遇到的问题</span><a href="#yu-dao-de-wen-ti" class="header-anchor">#</a></h2>
<ol type="1">
<li>多子项目单独开发时，如何确定react版本？</li>
<li>如何保证主项目加载子项目作为组件时，二者公用同一个react实例？</li>
<li>开发时，如何处理互相存在依赖子系统？</li>
<li>外置化加载react&amp;react-dom时，hot-reload失效</li>
</ol>
<h2><span id="wen-ti-yuan-yin-amp-fen-xi">问题原因&amp;分析</span><a href="#wen-ti-yuan-yin-amp-fen-xi" class="header-anchor">#</a></h2>
<ul>
<li>为什么会引入问题[1]：这是因为使用用monorepo这个结构时，我们希望所有的子系统和主系统(系统的入口)，使用同一个react版本，以便系统整体的核心依赖的控制，并且减少多版本兼容带来的额外的bug。</li>
<li>为什么会引入问题[2]：
<ul>
<li>hooks的使用要求二者必须使用的是一个react实例</li>
<li>对于context，它的使用也依赖于同一react实例</li>
</ul></li>
<li>为什么会引入问题[3]：当我们同时满足问题[1]和[2]时，react和react-dom将不能被打包到一个bandle包中，所以在webpack层面，我们需要使用external，排除react。与此同时，由于主流的用于处理react热更新的插件，<a target="_blank" rel="noopener" href="https://github.com/pmmmwh/react-refresh-webpack-plugin">react-refresh-webpack-plugin</a>对于外置加载的react core有严格的顺序要求，所以导致了热更新的失效</li>
</ul>
<h2><span id="ru-he-jie-jue-wen-ti">如何解决问题？</span><a href="#ru-he-jie-jue-wen-ti" class="header-anchor">#</a></h2>
<h3><span id="duo-zi-xiang-mu-dan-du-kai-fa-shi-ru-he-que-ding-react-ban-ben-yi-ji-ru-he-bao-zheng-zhu-xiang-mu-jia-zai-zi-xiang-mu-zuo-wei-zu-jian-shi-er-zhe-gong-yong-tong-yi-ge-react-shi-li">多子项目单独开发时，如何确定react版本，以及如何保证主项目加载子项目作为组件时，二者公用同一个react实例</span><a href="#duo-zi-xiang-mu-dan-du-kai-fa-shi-ru-he-que-ding-react-ban-ben-yi-ji-ru-he-bao-zheng-zhu-xiang-mu-jia-zai-zi-xiang-mu-zuo-wei-zu-jian-shi-er-zhe-gong-yong-tong-yi-ge-react-shi-li" class="header-anchor">#</a></h3>
<p>我们期待所有这个系统中，所有项目的react依赖都指向同一个react core文件，这样在系统所有项目都构建完成后，react的版本就确定了下来，所以我们可以修改<code>webpack.config.js</code>和项目的HTML模版来达到这个目标： 对于<code>webpack.config.js</code>增加： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="attr">external</span>: [<span class="string">&#x27;react&#x27;</span>,<span class="string">&#x27;react-dom&#x27;</span>]</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 对于HTML模版（这里的具体语法，需要根据具体使用的模版解析器语法来）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;script data-tn=&quot;react-bundle&quot; type=&quot;text/javascript&quot; src=&quot;&#123;&#123;reactBundlePath | safe&#125;&#125;&quot;&gt;&lt;script&gt;</span><br><span class="line">&lt;script data-tn=&quot;react-dom-bundle&quot; type=&quot;text/javascript&quot; src=&quot;&#123;&#123;reactDomBundlePath | safe&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>这里的 <code>reactBundlePath</code> 和 <code>reactDomBundlePath</code>是react单独编译后的结果，对应的是两个js文件。</p>
<p>至此react core就完成外置化，所有的子项目在单独开发时，都可以修改自己的HTML模版，以使用公共的react core，并且主系统和子系统的react实例始终一直，在</p>
<h3><span id="kai-fa-shi-ru-he-chu-li-hu-xiang-cun-zai-yi-lai-zi-xi-tong">开发时，如何处理互相存在依赖子系统</span><a href="#kai-fa-shi-ru-he-chu-li-hu-xiang-cun-zai-yi-lai-zi-xi-tong" class="header-anchor">#</a></h3>
<p>在webpack5之前，可以在webpack中增加： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="attr">resolve</span>:&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="attr">alias</span>:&#123;</span><br><span class="line">      <span class="string">&#x27;&lt;module_name&gt;&#x27;</span>: <span class="string">&#x27;project/root/path/provide/modules&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 这样就可以轻松的通过 <code>import * as MouduleName from 'module_name'</code>的方式使用另一个子项目暴露的功能了。</p>
<h3><span id="wai-zhi-hua-jia-zai-react-amp-react-dom-shi-hot-reload-shi-xiao">外置化加载react&amp;react-dom时，hot-reload失效</span><a href="#wai-zhi-hua-jia-zai-react-amp-react-dom-shi-hot-reload-shi-xiao" class="header-anchor">#</a></h3>
<p>由于<a target="_blank" rel="noopener" href="https://github.com/pmmmwh/react-refresh-webpack-plugin">react-refresh-webpack-plugin</a>对于外置加载的react core有严格的顺序要求，所以我们需要修改项目打包的输出，由原来的单入口，改为多入口。并且在HTML模版中控制它们的加载顺序。</p>
<p>对于<code>webpack.config.js</code>需要修改： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">   <span class="attr">entry</span>: isDevelopment</span><br><span class="line">  ? &#123;</span><br><span class="line">      <span class="attr">whm</span>: <span class="string">&#x27;webpack-hot-middleware/client?quiet=true&amp;reload=true&amp;path=/&lt;default&gt;/&lt;route&gt;/__webpack_hmr&amp;timeout=2000&#x27;</span>, <span class="comment">//启用webpack-hot-middleware作为热更新服务时需要增加的</span></span><br><span class="line">      <span class="attr">reactRefreshEntry</span>: <span class="string">&#x27;@pmmmwh/react-refresh-webpack-plugin/client/ReactRefreshEntry.js&#x27;</span>, <span class="comment">//让react产生局部更新</span></span><br><span class="line">      <span class="attr">main</span>: clientEntry, <span class="comment">//项目本身的入口文件</span></span><br><span class="line">    &#125;</span><br><span class="line">  : clientEntry,<span class="comment">//项目本身的入口文件</span></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">   <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">oneOf</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">test</span>: <span class="regexp">/\.(js|ts|tsx)$/</span>,</span><br><span class="line">            <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>,</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">              <span class="attr">plugins</span>: [<span class="string">&#x27;lodash&#x27;</span>, isDev &amp;&amp; <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;react-refresh/babel&#x27;</span>)].<span class="title function_">filter</span>(</span><br><span class="line">                <span class="title class_">Boolean</span></span><br><span class="line">              ),</span><br><span class="line">              <span class="attr">presets</span>: [[<span class="string">&#x27;@babel/env&#x27;</span>]],</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="attr">plugins</span>: defultPlugins.<span class="title function_">concat</span>(isDevelopment ? [</span><br><span class="line">    <span class="keyword">new</span> webpack.<span class="title class_">HotModuleReplacementPlugin</span>(),</span><br><span class="line">    <span class="keyword">new</span> webpack.<span class="title class_">NoEmitOnErrorsPlugin</span>(),</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ReactRefreshWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">overlay</span>: &#123;</span><br><span class="line">        <span class="attr">sockIntegration</span>: <span class="string">&#x27;whm&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;),</span><br><span class="line">  ]:[])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于HTML模版（这里的具体语法，需要根据具体使用的模版解析器语法来）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if isDev%&#125;</span><br><span class="line">  &lt;script type=&quot;text/javascript&quot; src=&quot;&#123;&#123; bundlePath | safe &#125;&#125;/client.bundle.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">  &lt;script type=&quot;text/javascript&quot; src=&quot;&#123;&#123; bundlePath | safe &#125;&#125;/vendors.client.bundle.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">  &lt;script type=&quot;text/javascript&quot; src=&quot;&#123;&#123; bundlePath | safe &#125;&#125;/whm.client.bundle.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">  &lt;script type=&quot;text/javascript&quot; src=&quot;&#123;&#123; bundlePath | safe &#125;&#125;/reactRefreshEntry.client.bundle.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&lt;!-- .....  --&gt;</span><br><span class="line">&#123;% if isDev%&#125;</span><br><span class="line">  &lt;script type=&quot;text/javascript&quot; src=&quot;&#123;&#123; bundlePath | safe &#125;&#125;/main.client.bundle.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">  &#123;% for url in clientBundle %&#125;</span><br><span class="line">    &lt;script type=&quot;text/javascript&quot; src=&quot;&#123;&#123; bundlePath &#125;&#125;/&#123;&#123; url | safe &#125;&#125;&quot;&gt;&lt;/script&gt;</span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
<p>至此就完成在monorepo下，react项目的局部热更新。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-12-27T23:26:36.000Z" title="12/28/2021, 7:26:36 AM">2021-12-28</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-09-10T14:10:41.225Z" title="9/10/2023, 10:10:41 PM">2023-09-10</time></span><span class="level-item"><a class="link-muted" href="/categories/project/">project</a></span><span class="level-item">5 minutes read (About 728 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/High-performance-grouped-list-design.html">High performance grouped list design</a></p><div class="content"><div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#overall-goal">Overall goal</a></li>
<li><a href="#analysis">Analysis</a></li>
<li><a href="#data-structure-design">Data structure design</a></li>
<li><a href="#algorithm-selection">Algorithm selection</a>
<ul>
<li><a href="#one-dimensional-object-arrays-into-nested-structures-design">One-dimensional object arrays into nested structures Design.</a></li>
</ul></li>
<li><a href="#specific-implementation">Specific implementation</a>
<ul>
<li><a href="#one-dimensional-array-of-objects-converted-to-a-nested-structure-implements">One-dimensional array of objects converted to a nested structure implements.</a></li>
</ul></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="overall-goal">Overall goal</span><a href="#overall-goal" class="header-anchor">#</a></h2>
<ol type="1">
<li>nested relationships exist in the grouping and there is no theoretical upper limit to the depth</li>
<li>Drag and drop elements out of the grouped list to create grouping relationships</li>
<li>ungrouped elements can be dragged into the group to create new grouping relationships</li>
<li>When ungrouped list items are moved, they will automatically cross over the group and its subcomponents</li>
<li>When ungrouped list items are grouped, the relative order before grouping should be maintained</li>
<li>when grouped list items are ungrouped, the relative order before grouping should be maintained</li>
<li>the above operation should also be valid for the direct operation of grouping (here the grouping is also operated as a list item) ## Analysis</li>
</ol>
<ul>
<li>Due to Objectives 1&amp;5, the data structure should be kept in a one-dimensional structure, i.e. in the form of an array of objects. Such a data structure provides the base order of list items and facilitates maintaining the relative order of list items when creating groupings.</li>
<li>For objectives 2&amp;3&amp;5&amp;6, the relative position of the grouped list items within the group should be recorded when calculating whether to create/update/delete grouping relationships for drag and drop items, to facilitate sorting the position of the list when the grouping relationships change</li>
<li>For Objective 7, grouping should be included as one of the list items. Provide the "type" field as a distinction between grouped list items and other lists, for possible expansion of the grouping expand/collapse function.</li>
<li>Render the list with a multi-dimensional structure to facilitate recursive rendering of the list, friendly to jsx syntax. ## Data structure design</li>
</ul>
<p>List item data structure</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ListItem</span> &#123;</span><br><span class="line">  <span class="attr">code</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">groupCode</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>List data structure</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">List</span> = <span class="title class_">ListImte</span>[]</span><br></pre></td></tr></table></figure>
<p>Auxiliary data structure when updating grouping</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">GroupStack</span> = &#123;</span><br><span class="line">  <span class="attr">groupCode</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">index</span>: <span class="built_in">number</span>; <span class="comment">// the real subscript of the group</span></span><br><span class="line">  <span class="attr">offsetNumber</span>: <span class="built_in">number</span> <span class="comment">// the length of the group, for recording the relative position of the list items in the group</span></span><br><span class="line">&#125;[]</span><br></pre></td></tr></table></figure>
<p>The data structure used for react rendering</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">AssistStruct</span> &#123;</span><br><span class="line">  <span class="attr">code</span>: <span class="built_in">string</span>;</span><br><span class="line">  children?: <span class="title class_">AssistStruct</span>[];</span><br><span class="line">  parentGroupCode?: <span class="built_in">string</span>; <span class="comment">//pop stack flag</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="algorithm-selection">Algorithm selection</span><a href="#algorithm-selection" class="header-anchor">#</a></h2>
<h3><span id="one-dimensional-object-arrays-into-nested-structures-design">One-dimensional object arrays into nested structures Design.</span><a href="#one-dimensional-object-arrays-into-nested-structures-design" class="header-anchor">#</a></h3>
<p>Detect group closure,The algorithm is a variant of the bracket closure algorithm.</p>
<p>If the group-code field in the current list item is not equal to the code at the top of the stack, the group is closed and the current stack top element is popped.</p>
<p><img src="/images/group_list.png"></p>
<h2><span id="specific-implementation">Specific implementation</span><a href="#specific-implementation" class="header-anchor">#</a></h2>
<h3><span id="one-dimensional-array-of-objects-converted-to-a-nested-structure-implements">One-dimensional array of objects converted to a nested structure implements.</span><a href="#one-dimensional-array-of-objects-converted-to-a-nested-structure-implements" class="header-anchor">#</a></h3>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Convert a one-dimensional array to a multi-layer structure</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> compCodes The code of all components</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> compDatas the data of all components</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> returns the nested structure associated with code, the</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> subList = (<span class="attr">compCodes</span>: <span class="built_in">string</span>[], <span class="attr">compDatas</span>: <span class="variable constant_">JDV</span>.<span class="property">State</span>[<span class="string">&#x27;compDatas&#x27;</span>]): <span class="title class_">AssistStruct</span>[] =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">groupStack</span>: <span class="title class_">GroupStack</span>[] = [];</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">resultData</span>: <span class="title class_">AssistStruct</span>[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">stackPop</span> = (<span class="params">groupCode?: <span class="built_in">string</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> len = groupStack.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (len &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (groupStack[len].<span class="property">groupCode</span> ! == groupCode) &#123;</span><br><span class="line">        groupStack.<span class="title function_">pop</span>();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      len--;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">setResult</span> = (<span class="params">result: AssistStruct[], groupStack: GroupStack[], groupCode: <span class="built_in">string</span>, value: AssistStruct</span>) =&gt; &#123;</span><br><span class="line">    groupStack.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!result[item.<span class="property">index</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (result[item.<span class="property">index</span>].<span class="property">code</span> ! == groupCode) &#123;</span><br><span class="line">        <span class="comment">// If the current component&#x27;s group is not equal to the key in the result, search down</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">setResult</span>(result[item.<span class="property">index</span>].<span class="property">children</span> <span class="keyword">as</span> <span class="title class_">AssistStruct</span>[], groupStack.<span class="title function_">slice</span>(index + <span class="number">1</span>), groupCode, value);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (result[item.<span class="property">index</span>].<span class="property">children</span>) &#123;</span><br><span class="line">          (result[item.<span class="property">index</span>].<span class="property">children</span> <span class="keyword">as</span> <span class="title class_">AssistStruct</span>[]).<span class="title function_">push</span>(value);</span><br><span class="line">          item.<span class="property">offsetNumber</span> += <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          result[item.<span class="property">index</span>].<span class="property">children</span> = [value];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  compCodes.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> hasGroup = compDatas[item] ? compDatas[item].<span class="property">config</span>.<span class="property">groupCode</span> : <span class="literal">undefined</span>;</span><br><span class="line">    <span class="title function_">stackPop</span>(hasGroup);</span><br><span class="line">    <span class="keyword">if</span> (compDatas[item].<span class="property">compCode</span> === <span class="string">&#x27;group&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (hasGroup) &#123;</span><br><span class="line">        <span class="comment">// If the current component&#x27;s parent is at the top of the stack, update the result tree</span></span><br><span class="line">        <span class="title function_">setResult</span>(resultData, groupStack.<span class="title function_">slice</span>(<span class="number">0</span>), hasGroup, &#123;</span><br><span class="line">          <span class="attr">code</span>: item,</span><br><span class="line">          <span class="attr">children</span>: [],</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if the current group has a parent group, the group stack must not be empty, and the group index is the parent group length-1</span></span><br><span class="line">        <span class="comment">// debugger;</span></span><br><span class="line">        groupStack.<span class="title function_">push</span>(&#123;</span><br><span class="line">          <span class="attr">groupCode</span>: item,</span><br><span class="line">          <span class="attr">index</span>: groupStack.<span class="property">length</span> ? groupStack[groupStack.<span class="property">length</span> - <span class="number">1</span>].<span class="property">offsetNumber</span> - <span class="number">1</span> : index,</span><br><span class="line">          <span class="attr">offsetNumber</span>: <span class="number">0</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        groupStack = []; <span class="comment">//no group, empty stack</span></span><br><span class="line">        resultData.<span class="title function_">push</span>(&#123;</span><br><span class="line">          <span class="attr">code</span>: item,</span><br><span class="line">          <span class="attr">children</span>: [],</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//If the current group has no parent group, the group stack must be empty and the group index is the result length</span></span><br><span class="line">        groupStack.<span class="title function_">push</span>(&#123;</span><br><span class="line">          <span class="attr">groupCode</span>: item,</span><br><span class="line">          <span class="attr">index</span>: resultData.<span class="property">length</span> - <span class="number">1</span>,</span><br><span class="line">          <span class="attr">offsetNumber</span>: <span class="number">0</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (hasGroup) &#123;</span><br><span class="line">        <span class="comment">// If the current component&#x27;s parent is at the top of the stack, update the result tree</span></span><br><span class="line">        <span class="title function_">setResult</span>(resultData, groupStack.<span class="title function_">slice</span>(<span class="number">0</span>), hasGroup, &#123;</span><br><span class="line">          <span class="attr">code</span>: item,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        groupStack = []; <span class="comment">//no group, empty stack</span></span><br><span class="line">        resultData.<span class="title function_">push</span>(&#123;</span><br><span class="line">          <span class="attr">code</span>: item,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> resultData;</span><br></pre></td></tr></table></figure>
<p>Translated with www.DeepL.com/Translator (free version)</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-12-26T06:53:38.000Z" title="12/26/2021, 2:53:38 PM">2021-12-26</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-09-10T14:10:41.226Z" title="9/10/2023, 10:10:41 PM">2023-09-10</time></span><span class="level-item"><a class="link-muted" href="/categories/project/">project</a></span><span class="level-item">8 minutes read (About 1217 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Recording-web-pages-to-video-at-a-specified-time-through-a-server.html">Recording web pages to video at a specified time through a server</a></p><div class="content"><div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#why-is-there-such-a-need">Why is there such a need?</a></li>
<li><a href="#my-goal">My goal</a></li>
<li><a href="#choice-of-technology-stack">Choice of technology stack</a></li>
<li><a href="#the-specific-implementation">The specific implementation</a>
<ul>
<li><a href="#i-current-solution">I. Current solution</a>
<ul>
<li><a href="#the-main-problems-that-this-solution-circumvents-to-solve-are">The main problems that this solution circumvents to solve are.</a></li>
<li><a href="#core-processes">Core Processes</a></li>
<li><a href="#key-points">Key points.</a></li>
<li><a href="#solution-performance-in-docker">solution performance (in docker)</a></li>
</ul></li>
<li><a href="#ii-tried-and-tested-solutions">II. Tried and tested solutions</a>
<ul>
<li><a href="#getdisplaymedia-mode">getDisplayMedia mode</a>
<ul>
<li><a href="#key-points">Key points</a></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="#q-a">Q &amp; A</a></li>
<li><a href="#project-address">Project address</a></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="why-is-there-such-a-need">Why is there such a need?</span><a href="#why-is-there-such-a-need" class="header-anchor">#</a></h2>
<p>I recently work in the field of front-end data visualization, and the need for some monitoring of long-running front-end pages comes up. In the past, my solution was to record through some existing platform on my personal PC via browser, or an earlier approach was to record through some screen recording tools.</p>
<p>In such an approach, the following problems were often encountered.</p>
<ul>
<li><strong>Insufficient resolution to restore</strong></li>
<li><strong>The recorded log format is difficult to parse</strong></li>
<li><strong>Need to open the personal computer for a long time</strong></li>
<li>** What is recorded through the platform is often not a video, but a DOM-Mirror recording. Such logs are difficult to share with others for troubleshooting**</li>
<li><strong>DOM-Mirror recordings for playback lack value for rendering real-time data returned by the backend (because the point in time has been missed, and playback cannot play back the service state of the backend at that time)</strong></li>
<li><strong>The number of concurrent recordings is limited by the performance of personal computers</strong></li>
<li><strong>Recorded files are not well managed</strong></li>
</ul>
<h2><span id="my-goal">My goal</span><a href="#my-goal" class="header-anchor">#</a></h2>
<p>So, based on the above needs, we need to achieve the following requirements.</p>
<ul>
<li><strong>Record at the native resolution required by the web page</strong></li>
<li><strong>Be able to record on the server side and not on the PC</strong></li>
<li><strong>The ability to record generic video and log files that can be easily shared with others</strong></li>
<li><strong>Ability to make concurrent recordings</strong></li>
<li><strong>Video frame rate should be smooth enough (at least at 4K)</strong></li>
<li><strong>Provide access to static resources for recorded files</strong></li>
</ul>
<h2><span id="choice-of-technology-stack">Choice of technology stack</span><a href="#choice-of-technology-stack" class="header-anchor">#</a></h2>
<ul>
<li>Base language and framework - js &amp; nodejs</li>
<li>For running tasks at specified times -- cron job</li>
<li>For opening web pages -- puppeteer</li>
<li>For video recording the following options are available
<ul>
<li>Use the browser api <code>getDisplayMedia</code> for recording</li>
<li>Use puppeteer to take a screenshot by frame, then compress the image with ffmpeg</li>
<li>Use xvfb to record the video stream from the virtual desktop directly by encoding it with ffmpeg</li>
</ul></li>
<li>For recording logs -- puppeteer provides devtools related events</li>
<li>For concurrent processing -- introduce weighted calculations</li>
<li>For video processing -- ffmpeg</li>
</ul>
<h2><span id="the-specific-implementation">The specific implementation</span><a href="#the-specific-implementation" class="header-anchor">#</a></h2>
<h3><span id="i-current-solution">I. Current solution</span><a href="#i-current-solution" class="header-anchor">#</a></h3>
<h4><span id="the-main-problems-that-this-solution-circumvents-to-solve-are">The main problems that this solution circumvents to solve are.</span><a href="#the-main-problems-that-this-solution-circumvents-to-solve-are" class="header-anchor">#</a></h4>
<ul>
<li>The use of <code>getDisplayMedia</code> is limited by the browser's protocol. This api is only available when the access protocol is https, and the recording of audio depends on other api.</li>
<li>The performance of <code>getDisplayMedia</code> has little room for optimization when recording multiple pages concurrently, and the most fatal problem is that the performance overhead of the recording process is borne by the browser. This means that if the page itself is more performance sensitive, it is basically impossible to record the page running properly using this api.</li>
<li>puppeteer's frame-by-frame screenshots are limited by chrome-devtools itself, resulting in only 10+ images being cut out a second. In a data visualization scenario, a large amount of real-time data rendering is obviously unacceptable as well.</li>
</ul>
<h4><span id="core-processes">Core Processes</span><a href="#core-processes" class="header-anchor">#</a></h4>
<!-- ![record]](/images/recorder_base_procedure.png) -->
<p><img src="/images/recorder_base_procedure.png"></p>
<h4><span id="key-points">Key points.</span><a href="#key-points" class="header-anchor">#</a></h4>
<ol type="1">
<li>use node call xvfb, create virtual desktops: open source library <code>node-xvfb</code> has some problems, the virtual desktops created, seem to share the same stream buffer, in the case of concurrent recording, there will be a situation of preemption, resulting in accelerated video content, so the need to encapsulate a new node call xvfb</li>
</ol>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> process <span class="keyword">from</span> <span class="string">&#x27;child_process&#x27;</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">XvfbMap</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="attr">xvfb</span>: &#123;</span><br><span class="line">     [<span class="attr">key</span>: <span class="built_in">string</span>]: &#123;</span><br><span class="line">       <span class="attr">process</span>: process.<span class="property">ChildProcessWithoutNullStreams</span>;</span><br><span class="line">       <span class="attr">display</span>: <span class="built_in">number</span>;</span><br><span class="line">       execPath?: <span class="built_in">string</span>;</span><br><span class="line">     &#125;;</span><br><span class="line">   &#125; = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">   setXvfb = <span class="function">(<span class="params">key: <span class="built_in">string</span>, display: <span class="built_in">number</span>, process: process.ChildProcessWithoutNullStreams, execPath?: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">xvfb</span>[key] = &#123;</span><br><span class="line">       display,</span><br><span class="line">       process,</span><br><span class="line">       execPath,</span><br><span class="line">     &#125;;</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   getSpecXvfb = <span class="function">(<span class="params">key: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">xvfb</span>[key];</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   getXvfb = <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">xvfb</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> xvfbIns = <span class="keyword">new</span> <span class="title class_">XvfbMap</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 检测虚拟桌面是否运行</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> num 虚拟桌面窗口编号</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> execPath 内存缓冲文件映射路径</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@returns</span> Promise&lt;boolean&gt;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">   <span class="keyword">const</span> <span class="title function_">checkoutDisplay</span> = (<span class="params">num: <span class="built_in">number</span>, execPath?: <span class="built_in">string</span></span>) =&gt; &#123;</span><br><span class="line">     <span class="keyword">const</span> path = execPath || <span class="string">&#x27;/dev/null&#x27;</span>;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt;(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">const</span> xdpyinfo = process.<span class="title function_">spawn</span>(<span class="string">&#x27;xdpyinfo&#x27;</span>, [</span><br><span class="line">       <span class="string">&#x27;-display&#x27;</span>,</span><br><span class="line">       <span class="string">`:<span class="subst">$&#123;num&#125;</span>&gt;<span class="subst">$&#123;path&#125;</span>`</span>,</span><br><span class="line">       <span class="string">&#x27;2&gt;&amp;1&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;&amp;&amp;&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;echo&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;inUse&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;||&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;echo&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;free&#x27;</span>,</span><br><span class="line">     ]);</span><br><span class="line">     xdpyinfo.<span class="property">stdout</span>.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> <span class="title function_">res</span>(data.<span class="title function_">toString</span>() === <span class="string">&#x27;inUse&#x27;</span>));</span><br><span class="line">     xdpyinfo.<span class="property">stderr</span>.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> <span class="title function_">rej</span>(data.<span class="title function_">toString</span>()));</span><br><span class="line">     &#125;);</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> getRunnableNumber = <span class="keyword">async</span> (execPath?: <span class="built_in">string</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt; =&gt; &#123;</span><br><span class="line">   <span class="keyword">const</span> num = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="number">62396</span> * <span class="title class_">Math</span>.<span class="title function_">random</span>());</span><br><span class="line">   <span class="keyword">const</span> isValid = <span class="keyword">await</span> <span class="title function_">checkoutDisplay</span>(num, execPath);</span><br><span class="line">   <span class="keyword">if</span> (isValid) &#123;</span><br><span class="line">     <span class="keyword">return</span> num;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="title function_">getRunnableNumber</span>(execPath);</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">xvfbStart</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">   key: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">   option: &#123; width: <span class="built_in">number</span>; height: <span class="built_in">number</span>; depth: <span class="number">15</span> | <span class="number">16</span> | <span class="number">24</span> &#125;,</span></span><br><span class="line"><span class="params">   execPath?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params">  </span>) =&gt; &#123;</span><br><span class="line">   <span class="keyword">const</span> randomNum = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="number">62396</span> * <span class="title class_">Math</span>.<span class="title function_">random</span>());</span><br><span class="line">   <span class="keyword">const</span> &#123; width, height, depth &#125; = option;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="keyword">const</span> xvfb = process.<span class="title function_">spawn</span>(<span class="string">&#x27;Xvfb&#x27;</span>, [</span><br><span class="line">       <span class="string">`:<span class="subst">$&#123;randomNum&#125;</span>`</span>,</span><br><span class="line">       <span class="string">&#x27;-screen&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">       <span class="string">`<span class="subst">$&#123;width&#125;</span>x<span class="subst">$&#123;height&#125;</span>x<span class="subst">$&#123;depth&#125;</span>`</span>,</span><br><span class="line">       <span class="string">&#x27;-ac&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;-noreset&#x27;</span>,</span><br><span class="line">     ]);</span><br><span class="line"></span><br><span class="line">     xvfbIns.<span class="title function_">setXvfb</span>(key, randomNum, xvfb, execPath);</span><br><span class="line">     <span class="keyword">return</span> randomNum;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">     <span class="keyword">return</span> <span class="number">99</span>;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">xvfbStop</span> = (<span class="params">key: <span class="built_in">string</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> xvfb = xvfbIns.<span class="title function_">getSpecXvfb</span>(key);</span><br><span class="line">  <span class="keyword">return</span> xvfb.<span class="property">process</span>.<span class="title function_">kill</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> xvfbIns;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li><p>Load balancing during concurrent server recording. This feature is to solve the problem of high server CPU load when recording video encoding concurrently. So to maximize the number of concurrent recordings, I record the number of tasks being and will be performed by each server, mark this number as the weight of the service, and when a new recording task is created, first check the weight of the current server, then create the recording task on the server with the lowest weight, and lower the weight when the recording is completed and the task is manually terminated. <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CronJob</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;cron&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">CacheType</span> &#123;</span><br><span class="line">  [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="title class_">CronJob</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CronCache</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">cache</span>: <span class="title class_">CacheType</span> = &#123;&#125;;</span><br><span class="line">  <span class="keyword">private</span> cacheCount = <span class="number">0</span>;</span><br><span class="line">  setCache = <span class="function">(<span class="params">key: <span class="built_in">string</span>, value: CronJob</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cache</span>[key] = value;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cacheCount</span>++;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  getCache = <span class="function">(<span class="params">key: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">cache</span>[key];</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  deleteCache = <span class="function">(<span class="params">key: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">cache</span>[key]) &#123;</span><br><span class="line">      <span class="keyword">delete</span> <span class="variable language_">this</span>.<span class="property">cache</span>[key];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cacheCount</span> = <span class="variable language_">this</span>.<span class="property">cacheCount</span> &gt; <span class="number">0</span> ? <span class="variable language_">this</span>.<span class="property">cacheCount</span> - <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  getCacheCount = <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">cacheCount</span>;</span><br><span class="line">  getCacheMap = <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">cache</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> <span class="title class_">CronCache</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure></p></li>
<li><p>When starting puppeteer, you need to provide parameters</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.<span class="title function_">launch</span>(&#123;</span><br><span class="line">      <span class="attr">headless</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">executablePath</span>: <span class="string">&#x27;/usr/bin/google-chrome&#x27;</span>,</span><br><span class="line">      <span class="attr">defaultViewport</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">args</span>: [</span><br><span class="line">        <span class="string">&#x27;--enable-usermedia-screen-capturing&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--allow-http-screen-capture&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--ignore-certificate-errors&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--enable-experimental-web-platform-features&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--allow-http-screen-capture&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--disable-infobars&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--no-sandbox&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--disable-setuid-sandbox&#x27;</span>,<span class="comment">//关闭沙箱</span></span><br><span class="line">        <span class="string">&#x27;--start-fullscreen&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--display=:&#x27;</span> + display,</span><br><span class="line">        <span class="string">&#x27;-–disable-dev-shm-usage&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;-–no-first-run&#x27;</span>, <span class="comment">//没有设置首页。</span></span><br><span class="line">        <span class="string">&#x27;–-single-process&#x27;</span>, <span class="comment">//单进程运行</span></span><br><span class="line">        <span class="string">&#x27;--disable-gpu&#x27;</span>, <span class="comment">//GPU硬件加速</span></span><br><span class="line">        <span class="string">`--window-size=<span class="subst">$&#123;width&#125;</span>,<span class="subst">$&#123;height&#125;</span>`</span>,<span class="comment">//窗口尺寸</span></span><br><span class="line">      ],</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></li>
</ol>
<h4><span id="solution-performance-in-docker">solution performance (in docker)</span><a href="#solution-performance-in-docker" class="header-anchor">#</a></h4>
<ul>
<li>Standard 1k resolution: dual-core CPU 2.3Ghz; 10 concurrent at 4G ram</li>
<li>Standard 2k resolution: dual-core CPU 2.3Ghz; 4 concurrent under 4G ram</li>
</ul>
<h3><span id="ii-tried-and-tested-solutions">II. Tried and tested solutions</span><a href="#ii-tried-and-tested-solutions" class="header-anchor">#</a></h3>
<h4><span id="getdisplaymedia-mode">getDisplayMedia mode</span><a href="#getdisplaymedia-mode" class="header-anchor">#</a></h4>
<h5><span id="key-points">Key points</span><a href="#key-points" class="header-anchor">#</a></h5>
<ol type="1">
<li><p>The api call causes chrome to pop up an interactive window to choose which specific web page to record. Closing this window requires the following parameters to be enabled when starting puppeteer</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;--enable-usermedia-screen-capturing&#x27;</span>,</span><br><span class="line"><span class="string">`-auto-select-desktop-capture-source=recorder-page`</span>,</span><br><span class="line"><span class="string">&#x27;--allow-http-screen-capture&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;--ignore-certificate-errors&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;--enable-experimental-web-platform-features&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;--allow-http-screen-capture&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;--disable-infobars&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;--no-sandbox&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;--disable-setuid-sandbox&#x27;</span>,</span><br></pre></td></tr></table></figure></li>
<li><p>To execute the recording, you need to inject the function via puppeteer <code>page.exposeFunction</code>.</p></li>
</ol>
<h2><span id="q-amp-a">Q &amp; A</span><a href="#q-amp-a" class="header-anchor">#</a></h2>
<p>Q: Why do I need to introduce xvfb?</p>
<p>A: In the tried and tested solution, getDisplayMedia requires the runtime environment to provide a desktop environment. In the current solution, it is necessary to push the video stream from xvfb directly into ffmpeg</p>
<p>Q: Why are there certain memory requirements?</p>
<p>A: To provide the minimum running memory for chrome</p>
<h2><span id="project-address">Project address</span><a href="#project-address" class="header-anchor">#</a></h2>
<p>https://github.com/sadofriod/time-recorder</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-12-26T06:46:10.000Z" title="12/26/2021, 2:46:10 PM">2021-12-26</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-09-10T14:10:41.223Z" title="9/10/2023, 10:10:41 PM">2023-09-10</time></span><span class="level-item"><a class="link-muted" href="/categories/project/">project</a></span><span class="level-item">3 minutes read (About 432 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Draw-smooth-cubic-Bessel-curves.html">Draw smooth cubic Bessel curves</a></p><div class="content"><div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#basics">Basics</a></li>
<li><a href="#problems-faced">Problems faced</a>
<ul>
<li><a href="#1-choosing-a-quadratic-bezier-curve-or-a-cubic-bezier-curve">1. choosing a quadratic Bezier curve or a cubic Bezier curve</a></li>
<li><a href="#2-calculate-control-points-for-bezier-curves">2. Calculate control points for Bezier curves</a></li>
</ul></li>
<li><a href="#problem-analysis">Problem analysis</a>
<ul>
<li><a href="#problem-1">Problem 1.</a></li>
<li><a href="#question-2">Question 2.</a></li>
</ul></li>
<li><a href="#code-section">Code section</a></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="basics">Basics</span><a href="#basics" class="header-anchor">#</a></h2>
<p>What you need to know before reading includes</p>
<ul>
<li>The coordinate system of the canvas</li>
<li>The formula for the midpoint of two points in Cartesian coordinates</li>
<li>The formula for the distance between two points in Cartesian coordinates</li>
<li>Basic trigonometric functions</li>
<li>projection basics</li>
<li>canvas drawing Bezier curves</li>
</ul>
<h2><span id="problems-faced">Problems faced</span><a href="#problems-faced" class="header-anchor">#</a></h2>
<h3><span id="1-choosing-a-quadratic-bezier-curve-or-a-cubic-bezier-curve">1. choosing a quadratic Bezier curve or a cubic Bezier curve</span><a href="#1-choosing-a-quadratic-bezier-curve-or-a-cubic-bezier-curve" class="header-anchor">#</a></h3>
<h3><span id="2-calculate-control-points-for-bezier-curves">2. Calculate control points for Bezier curves</span><a href="#2-calculate-control-points-for-bezier-curves" class="header-anchor">#</a></h3>
<h2><span id="problem-analysis">Problem analysis</span><a href="#problem-analysis" class="header-anchor">#</a></h2>
<h3><span id="problem-1">Problem 1.</span><a href="#problem-1" class="header-anchor">#</a></h3>
<p>Since the quadratic Bézier curve will have only one bend after drawing, it will render poorly when multiple nodes are connected. And at 45°, 135°, 225°, 315°, special treatment is needed, otherwise the curve obtained is too large in radian.</p>
<h3><span id="question-2">Question 2.</span><a href="#question-2" class="header-anchor">#</a></h3>
<p>After deciding to use the cubic Bezier curve, we need to calculate the two control points C1,C2 when drawing the curve, and then draw it by <code>CanvasRenderingContext2D.bezierCurveTo</code>.</p>
<p>Since we need two control points, we will divide the line <strong>S-E</strong> between the starting point <strong>SP(start point)</strong> and the end point <strong>EP(end point)</strong> into 4 parts. The following points are obtained.</p>
<p><span class="math display">\[
\begin{align*}
Split_{m} = (\frac{(X_{SP}+X_{EP})}2,\frac{(Y_{SP}+Y_{EP})}2)\\
\end{align*}
\]</span> The formula L(x) for S-E is obtained as <span class="math display">\[
L(x) = \frac{X_{Split_{m}}}{Y_{Slit_{m}}}x
\]</span> From L(x) we know that the slope of S-E satisfies <span class="math display">\[
\tan \theta = \frac{X_{Split_{m}}}{Y_{Slit_{m}}}
\]</span></p>
<p>Then, using <span class="math display">\[Split_{m}\]</span> as the origin of the coordinate system and establishing the right angle coordinate system, we get</p>
<p><span class="math display">\[
\begin{align*}
len = \sqrt{(X_{Split_{m}}-X_{SP})^{2}+(Y_{Split_{m}}-Y_{SP})^{2}}\
\\\
\theta = \arctan \frac{X_{Split_{m}}}{Y_{Slit_{m}}}\
\\\\
Y_{offset} = len-\cos \theta \\\\
\\\\
C1=(X_{Split_{m}},Y_{Split_{m}}-len)\\\
C2=(X_{Split_{m}},Y_{Split_{m}}+len)
\end{align*}
\]</span></p>
<h2><span id="code-section">Code section</span><a href="#code-section" class="header-anchor">#</a></h2>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> props </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@typeof</span> props &#123;</span></span><br><span class="line"><span class="comment">		start: number[];</span></span><br><span class="line"><span class="comment">		end: number[];</span></span><br><span class="line"><span class="comment">		canvas: CanvasRenderingContext2D;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">drawLine</span> = (<span class="params">props: Common.LineProps</span>) =&gt; &#123;</span><br><span class="line">	<span class="keyword">const</span> &#123; start, end, <span class="attr">canvas</span>: ctx, color &#125; = props;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> <span class="title function_">getMidCoord</span> = (<span class="params">c1: <span class="built_in">number</span>, c2: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line">		<span class="keyword">if</span> (c1 === c2) &#123;</span><br><span class="line">			<span class="keyword">return</span> c1;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (c1 + c2) / <span class="number">2</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> [x1, y1] = start;</span><br><span class="line">	<span class="keyword">const</span> [x2, y2] = end;</span><br><span class="line">	<span class="keyword">const</span> [midX, midY] = [<span class="title function_">getMidCoord</span>(x1, x2), <span class="title function_">getMidCoord</span>(y1, y2)];</span><br><span class="line">	<span class="keyword">const</span> <span class="title function_">drawMirror</span> = (<span class="params">y1: <span class="built_in">number</span>, y2: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line">		<span class="keyword">if</span> (y1 &gt; y2) &#123;</span><br><span class="line">			<span class="keyword">return</span> ctx.<span class="title function_">bezierCurveTo</span>(control2[<span class="number">0</span>], control2[<span class="number">1</span>], control1[<span class="number">0</span>], control1[<span class="number">1</span>], end[<span class="number">0</span>], end[<span class="number">1</span>]);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> ctx.<span class="title function_">bezierCurveTo</span>(control1[<span class="number">0</span>], control1[<span class="number">1</span>], control2[<span class="number">0</span>], control2[<span class="number">1</span>], end[<span class="number">0</span>], end[<span class="number">1</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">const</span> degCos = <span class="title class_">Math</span>.<span class="title function_">cos</span>(<span class="title class_">Math</span>.<span class="title function_">atan</span>((x1 - midX) / (y1 - midY)));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> lineLen = <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(<span class="title class_">Math</span>.<span class="title function_">pow</span>(y1 - midY, <span class="number">2</span>) + <span class="title class_">Math</span>.<span class="title function_">pow</span>(x1 - midX, <span class="number">2</span>)) * <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> control1 = [midX, midY - degCos * (lineLen / <span class="number">2</span>)];</span><br><span class="line">	<span class="keyword">const</span> control2 = [midX, midY + degCos * (lineLen / <span class="number">2</span>)];</span><br><span class="line"></span><br><span class="line">	ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">	ctx.<span class="title function_">moveTo</span>(start[<span class="number">0</span>], start[<span class="number">1</span>]);</span><br><span class="line">	<span class="title function_">drawMirror</span>(y1, y2);</span><br><span class="line">	ctx.<span class="property">lineWidth</span> = <span class="number">2</span>;</span><br><span class="line">	ctx.<span class="property">strokeStyle</span> = color ? color : <span class="string">&quot;#000&quot;</span>;</span><br><span class="line">	ctx.<span class="title function_">stroke</span>();</span><br><span class="line">	ctx.<span class="title function_">closePath</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-08-21T11:11:33.000Z" title="8/21/2021, 7:11:33 PM">2021-08-21</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-09-10T14:10:41.232Z" title="9/10/2023, 10:10:41 PM">2023-09-10</time></span><span class="level-item"><a class="link-muted" href="/categories/project/">project</a></span><span class="level-item">4 minutes read (About 541 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/%E7%BB%98%E5%88%B6%E5%B9%B3%E6%BB%91%E7%9A%84%E4%B8%89%E6%AC%A1%E8%B4%9D%E5%A1%9E%E5%B0%94%E6%9B%B2%E7%BA%BF.html">绘制平滑的三次贝塞尔曲线</a></p><div class="content"><p><img src="/images/ezgif.com-gif-maker.gif"></p>
<div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#ji-chu-zhi-shi">基础知识</a></li>
<li><a href="#mian-lin-de-wen-ti">面临的问题</a>
<ul>
<li><a href="#1-xuan-ze-er-ci-bei-sai-er-qu-xian-or-san-ci-bei-sai-er-qu-xian">1. 选择二次贝塞尔曲线 or 三次贝塞尔曲线</a></li>
<li><a href="#2-bei-sai-er-qu-xian-kong-zhi-dian-ji-suan">2. 贝塞尔曲线控制点计算</a></li>
</ul></li>
<li><a href="#wen-ti-fen-xi">问题分析</a>
<ul>
<li><a href="#wen-ti-1">问题1：</a></li>
<li><a href="#wen-ti-2">问题2：</a></li>
</ul></li>
<li><a href="#dai-ma-bu-fen">代码部分</a></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="ji-chu-zhi-shi">基础知识</span><a href="#ji-chu-zhi-shi" class="header-anchor">#</a></h2>
<p>阅读之前你需要知道的知识包括</p>
<ul>
<li>canvas的坐标系</li>
<li>直角坐标中两点的中点公式</li>
<li>直角坐标中两点距离公式</li>
<li>基础的三角函数</li>
<li>投影基础知识</li>
<li>canvas绘制贝塞尔曲线</li>
</ul>
<h2><span id="mian-lin-de-wen-ti">面临的问题</span><a href="#mian-lin-de-wen-ti" class="header-anchor">#</a></h2>
<h3><span id="1-xuan-ze-er-ci-bei-sai-er-qu-xian-or-san-ci-bei-sai-er-qu-xian">1. 选择二次贝塞尔曲线 or 三次贝塞尔曲线</span><a href="#1-xuan-ze-er-ci-bei-sai-er-qu-xian-or-san-ci-bei-sai-er-qu-xian" class="header-anchor">#</a></h3>
<h3><span id="2-bei-sai-er-qu-xian-kong-zhi-dian-ji-suan">2. 贝塞尔曲线控制点计算</span><a href="#2-bei-sai-er-qu-xian-kong-zhi-dian-ji-suan" class="header-anchor">#</a></h3>
<h2><span id="wen-ti-fen-xi">问题分析</span><a href="#wen-ti-fen-xi" class="header-anchor">#</a></h2>
<h3><span id="wen-ti-1">问题1：</span><a href="#wen-ti-1" class="header-anchor">#</a></h3>
<p>由于二次贝塞尔曲线绘制后，将只有一处弯曲，在多节点连接时，呈现效果很差。并且在45°，135°，225°，315°时，需要做特殊的处理，否侧得到的曲线的弧度过大。</p>
<h3><span id="wen-ti-2">问题2：</span><a href="#wen-ti-2" class="header-anchor">#</a></h3>
<p>在确定使用三次贝塞尔曲线后，需要通过计算得出曲线绘制时的两个控制点C1,C2。然后通过<code>CanvasRenderingContext2D.bezierCurveTo</code>进行绘制。</p>
<p>由于我们需要两个控制点，所以，我们将会把起点<strong>SP(start point)</strong>和终点<strong>EP(end point)</strong>间的连线<strong>S-E</strong>均分为4份。得到如下点： <span class="math display">\[
\begin{align*}
Split_{m} = (\frac{(X_{SP}+X_{EP})}2,\frac{(Y_{SP}+Y_{EP})}2)\\
\end{align*}
\]</span> 得到S-E的公式L(x)为 <span class="math display">\[
L(x) = \frac{X_{Split_{m}}}{Y_{Slit_{m}}}x
\]</span> 根据L(x)可知S-E的斜率满足 <span class="math display">\[
\tan \theta = \frac{X_{Split_{m}}}{Y_{Slit_{m}}}
\]</span> 然后将<span class="math inline">\(Split_{m}\)</span>作为坐标系的原点，建立直角坐标系，得到 <span class="math display">\[
\begin{align*}
len = \sqrt{(X_{Split_{m}}-X_{SP})^{2}+(Y_{Split_{m}}-Y_{SP})^{2}}\\
\\
\theta = \arctan \frac{X_{Split_{m}}}{Y_{Slit_{m}}}\\
\\
Y_{offset} = len·\cos \theta \\
\\
C1=(X_{Split_{m}},Y_{Split_{m}}-len)\\
C2=(X_{Split_{m}},Y_{Split_{m}}+len)
\end{align*}
\]</span></p>
<h2><span id="dai-ma-bu-fen">代码部分</span><a href="#dai-ma-bu-fen" class="header-anchor">#</a></h2>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> props </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@typeof</span> props &#123;</span></span><br><span class="line"><span class="comment">		start: number[];</span></span><br><span class="line"><span class="comment">		end: number[];</span></span><br><span class="line"><span class="comment">		canvas: CanvasRenderingContext2D;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">drawLine</span> = (<span class="params">props: Common.LineProps</span>) =&gt; &#123;</span><br><span class="line">	<span class="keyword">const</span> &#123; start, end, <span class="attr">canvas</span>: ctx, color &#125; = props;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> <span class="title function_">getMidCoord</span> = (<span class="params">c1: <span class="built_in">number</span>, c2: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line">		<span class="keyword">if</span> (c1 === c2) &#123;</span><br><span class="line">			<span class="keyword">return</span> c1;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (c1 + c2) / <span class="number">2</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> [x1, y1] = start;</span><br><span class="line">	<span class="keyword">const</span> [x2, y2] = end;</span><br><span class="line">	<span class="keyword">const</span> [midX, midY] = [<span class="title function_">getMidCoord</span>(x1, x2), <span class="title function_">getMidCoord</span>(y1, y2)];</span><br><span class="line">	<span class="keyword">const</span> <span class="title function_">drawMirror</span> = (<span class="params">y1: <span class="built_in">number</span>, y2: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line">		<span class="keyword">if</span> (y1 &gt; y2) &#123;</span><br><span class="line">			<span class="keyword">return</span> ctx.<span class="title function_">bezierCurveTo</span>(control2[<span class="number">0</span>], control2[<span class="number">1</span>], control1[<span class="number">0</span>], control1[<span class="number">1</span>], end[<span class="number">0</span>], end[<span class="number">1</span>]);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> ctx.<span class="title function_">bezierCurveTo</span>(control1[<span class="number">0</span>], control1[<span class="number">1</span>], control2[<span class="number">0</span>], control2[<span class="number">1</span>], end[<span class="number">0</span>], end[<span class="number">1</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">const</span> degCos = <span class="title class_">Math</span>.<span class="title function_">cos</span>(<span class="title class_">Math</span>.<span class="title function_">atan</span>((x1 - midX) / (y1 - midY)));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> lineLen = <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(<span class="title class_">Math</span>.<span class="title function_">pow</span>(y1 - midY, <span class="number">2</span>) + <span class="title class_">Math</span>.<span class="title function_">pow</span>(x1 - midX, <span class="number">2</span>)) * <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> control1 = [midX, midY - degCos * (lineLen / <span class="number">2</span>)];</span><br><span class="line">	<span class="keyword">const</span> control2 = [midX, midY + degCos * (lineLen / <span class="number">2</span>)];</span><br><span class="line"></span><br><span class="line">	ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">	ctx.<span class="title function_">moveTo</span>(start[<span class="number">0</span>], start[<span class="number">1</span>]);</span><br><span class="line">	<span class="title function_">drawMirror</span>(y1, y2);</span><br><span class="line">	ctx.<span class="property">lineWidth</span> = <span class="number">2</span>;</span><br><span class="line">	ctx.<span class="property">strokeStyle</span> = color ? color : <span class="string">&quot;#000&quot;</span>;</span><br><span class="line">	ctx.<span class="title function_">stroke</span>();</span><br><span class="line">	ctx.<span class="title function_">closePath</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-07-30T06:14:19.000Z" title="7/30/2021, 2:14:19 PM">2021-07-30</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-09-10T14:10:41.233Z" title="9/10/2023, 10:10:41 PM">2023-09-10</time></span><span class="level-item"><a class="link-muted" href="/categories/project/">project</a></span><span class="level-item">8 minutes read (About 1161 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/%E9%AB%98%E6%80%A7%E8%83%BD%E5%88%86%E7%BB%84%E5%88%97%E8%A1%A8%E8%AE%BE%E8%AE%A1-2.html">高性能分组列表设计-2</a></p><div class="content"><div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#tong-guo-gai-bian-lie-biao-xiang-wei-zhi-geng-xin-fen-zu-guan-xi">通过改变列表项位置更新分组关系</a></li>
<li><a href="#yao-jie-jue-de-wen-ti">要解决的问题</a></li>
<li><a href="#fen-xi">分析</a></li>
<li><a href="#shi-xian">实现</a></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h2><span id="tong-guo-gai-bian-lie-biao-xiang-wei-zhi-geng-xin-fen-zu-guan-xi">通过改变列表项位置更新分组关系</span><a href="#tong-guo-gai-bian-lie-biao-xiang-wei-zhi-geng-xin-fen-zu-guan-xi" class="header-anchor">#</a></h2>
<p><img width="300px" src="/images/moveGroup.png"></p>
<h2><span id="yao-jie-jue-de-wen-ti">要解决的问题</span><a href="#yao-jie-jue-de-wen-ti" class="header-anchor">#</a></h2>
<ul>
<li>移动分组时，分组所有的子项都要移动，且保持相对位置和关系不变</li>
<li>批量移动未分组列表项到分组内时，相对位置应不变</li>
<li>已分组列表项移动出分组范围时应，应解除分组关系</li>
</ul>
<h2><span id="fen-xi">分析</span><a href="#fen-xi" class="header-anchor">#</a></h2>
<p>当分组移动时，所有分组的子项都不变，首先需要搜索到分组内所有的子项。然后记录该子项在分组内的相对位置，以及在整体列表中的位置。 这样在移动时，方便进行计算。</p>
<p>整体来讲，这个移动过程中的搜索部分将使用<strong>深度优先搜索</strong>的一种变种。移动后的排序，只需遵守搜索中分组和其子项的相对顺序遍历即可。</p>
<p>分组子项搜索流程如下： <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!groupCache.<span class="title function_">includes</span>(hasGroup)) &#123;</span><br><span class="line">      <span class="comment">//组件的分组不在查询的分组内。弹出所有的分组缓存</span></span><br><span class="line">      groupCache = [];</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result.<span class="title function_">push</span>(item); <span class="comment">//组件的分组在分组缓存中</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (hasGroup !== groupCache[groupCache.<span class="property">length</span> - <span class="number">1</span>]) &#123;</span><br><span class="line">        <span class="comment">// 如果组件的分组不在缓存的顶层</span></span><br><span class="line">        <span class="keyword">const</span> hasGroupCacheIndex = groupCache.<span class="title function_">indexOf</span>(hasGroup);</span><br><span class="line">        groupCache = groupCache.<span class="title function_">slice</span>(<span class="number">0</span>, hasGroupCacheIndex + <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (compDatas[item].<span class="property">compCode</span> === <span class="string">&#x27;group&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// 组件本身是分组组件</span></span><br><span class="line">        groupCache.<span class="title function_">push</span>(item);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>列表项排序流程如下： <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * compDatas 所有的列表项&#123;[code]:&#123; config: &#123; [groupCode]:groupCode &#125; &#125; &#125;</span></span><br><span class="line"><span class="comment">  * topLestSelectComps 和第一个要移动的列表项在同级的组件（处理批量移动的情况），数据结构与compDatas一致</span></span><br><span class="line"><span class="comment">  * nearLowBoundsGroup 将要移动列表项所在的分组的下界，数据结构与compDatas一致</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (isToplest) &#123;</span><br><span class="line">    <span class="comment">//如果移动位置在插入区间的顶部，表明组件在最外层</span></span><br><span class="line">    topLestSelectComps.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">      </span><br><span class="line">      result[item] = &#123; <span class="attr">newGroup</span>: <span class="literal">undefined</span>, <span class="attr">oldGroup</span>: compDatas[item].<span class="property">config</span>.<span class="property">groupCode</span> &#125;;</span><br><span class="line">      <span class="keyword">return</span> (compDatas[item].<span class="property">config</span>.<span class="property">groupCode</span> = <span class="literal">undefined</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (nearLowBoundsGroup !== firstCompPrev) &#123;</span><br><span class="line">    <span class="comment">//如果移动位置的下界的分组code不等于移动组件的code，则解除或更新分组关系</span></span><br><span class="line">    topLestSelectComps.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (item !== nearLowBoundsGroup) &#123;</span><br><span class="line">        result[item] = &#123; <span class="attr">newGroup</span>: nearLowBoundsGroup, <span class="attr">oldGroup</span>: compDatas[item].<span class="property">config</span>.<span class="property">groupCode</span> &#125;;</span><br><span class="line">        compDatas[item].<span class="property">config</span>.<span class="property">groupCode</span> = nearLowBoundsGroup;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result[item] = &#123; <span class="attr">newGroup</span>: compDatas[item].<span class="property">config</span>.<span class="property">groupCode</span>, <span class="attr">oldGroup</span>: compDatas[item].<span class="property">config</span>.<span class="property">groupCode</span> &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h2><span id="shi-xian">实现</span><a href="#shi-xian" class="header-anchor">#</a></h2>
<details>
<summary>分组子项查询详细代码</summary>
<pre>
    <code>

    interface GroupConfigStruct &#123;
      groupItemCode: string[];
    &#125;

    interface groupMapValueStruct &#123;
      //分组内组件相对于分组索引的偏移量
      offsetNumer: number;
      //分组的索引
      currentIndex: number;
    &#125;

    /**
    *根据分组关系排序一维数组
    *@param compCodes 所有组件的code
    *@param compDatas 所有组件的数据
    */
    const sortListItem = (compCodes: string[], compDatas: JDV.State['compDatas']) => &#123;
      const groupCodeCache = new Map<string, groupmapvaluestruct>();
      const result: string[] = [];

      /**
      *递归的回溯当前分组的前驱分组，更新前驱分组的长度偏移量
      *@param groupCode 分组组件的code
      *@param offsetNumber 分组长度的偏移量
      */
      const recursiveBacktracking = (groupCode: string, offsetNumber: number): null => &#123;
        const parentGroupCode = compDatas[groupCode].config.groupCode;
        const belongGroup = groupCodeCache.get(groupCode) as groupMapValueStruct;
        groupCodeCache.set(groupCode, &#123;
          //更新分组缓存，每此插入组件，偏移量+1
          ...belongGroup,
          offsetNumer: belongGroup.offsetNumer + 1,
        &#125;);
        if (parentGroupCode) &#123;
          // 如果分组有父分组，回溯一步
          return recursiveBacktracking(parentGroupCode, offsetNumber + 1);
        &#125; else &#123;
          return null;
        &#125;
      &#125;;
      compCodes.forEach((item, index) => &#123;
        const group = compDatas[item].config.groupCode ? compDatas[item].config.groupCode : null;
        if (compDatas[item].compCode === 'group') &#123;
          //如果组件是分组组件，将code推入分组缓冲内
          groupCodeCache.set(item, &#123; offsetNumer: 0, currentIndex: index &#125;);
        &#125;
        if (group) &#123;
          //在分组内
          if (groupCodeCache.has(group)) &#123;
            // 组件的分组在缓存中
            const belongGroup = groupCodeCache.get(group) as groupMapValueStruct;

            // 分组内组件插入的位置
            const targetIndex = belongGroup.currentIndex + belongGroup.offsetNumer;

            result.splice(targetIndex + 1, 0, item);
            recursiveBacktracking(group, belongGroup.offsetNumer);
          &#125;
        &#125; else &#123;
          result.push(item);
        &#125;
      &#125;);
      return result;
    &#125;;

    export default sortListItem;
    </string,></code>
  </pre>
</details>
<details>
<summary>分组移动后排序详细代码</summary>
<pre>
    <code>
    /**
 * 组件排序时处理分组的逻辑。
 * @param compCodes 所有组件的code
 * @param compDatas 所有组件的数据
 * @param code 当前组件code
 * @param destination 目标位置
 * @returns result &#123;Result&#125; 返回组件排序后的分组关系，用于分组关系变化后，处理分组的尺寸。
 */
export const groupResort = (
  compCodes: string[],
  selectedCompCodes: string[],
  compDatas: JDV.State['compDatas'],
  destination: number
): Result => &#123;
  const isToplest = destination === 0;
  const isBottomlest = destination + 1 === compCodes.length - 1;
  const lowBounds = isBottomlest ? compCodes.length - 1 : destination + 1;
  const interval = compCodes.slice(0, lowBounds); //插入区间
  const intervalLastComp = compDatas[compCodes[lowBounds]];
  const nearLowBoundsGroup = interval.find((item) => intervalLastComp && item === intervalLastComp.config.groupCode); //插入区间最下面的分组段
  const firstCompPrev = compDatas[selectedCompCodes[0]] && compDatas[selectedCompCodes[0]].config.groupCode; // 第一个选中组件的分组
  const topLestSelectComps = selectedCompCodes.filter((item) => compDatas[item].config.groupCode === firstCompPrev); // 和第一个选中在同级的所有选中组件
  const result: Result = &#123;&#125;;

  if (isToplest) &#123;
    //如果移动位置在插入区间的顶部，表明组件在最外层
    topLestSelectComps.forEach((item) => &#123;
      result[item] = &#123; newGroup: undefined, oldGroup: compDatas[item].config.groupCode &#125;;
      return (compDatas[item].config.groupCode = undefined);
    &#125;);

    return result;
  &#125;
  if (nearLowBoundsGroup !== firstCompPrev) &#123;
    //如果移动位置的下界的分组code不等于移动组件的code，则解除或更新分组关系
    topLestSelectComps.forEach((item) => &#123;
      if (item !== nearLowBoundsGroup) &#123;
        result[item] = &#123; newGroup: nearLowBoundsGroup, oldGroup: compDatas[item].config.groupCode &#125;;
        compDatas[item].config.groupCode = nearLowBoundsGroup;
      &#125; else &#123;
        result[item] = &#123; newGroup: compDatas[item].config.groupCode, oldGroup: compDatas[item].config.groupCode &#125;;
      &#125;
    &#125;);
    return result;
  &#125;
  return result;
&#125;;

    </code>
  </pre>
</details>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-07-28T10:27:27.000Z" title="7/28/2021, 6:27:27 PM">2021-07-28</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-09-10T14:10:41.233Z" title="9/10/2023, 10:10:41 PM">2023-09-10</time></span><span class="level-item"><a class="link-muted" href="/categories/project/">project</a></span><span class="level-item">7 minutes read (About 980 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/%E9%AB%98%E6%80%A7%E8%83%BD%E5%88%86%E7%BB%84%E5%88%97%E8%A1%A8%E8%AE%BE%E8%AE%A1-1.html">高性能分组列表设计(1)</a></p><div class="content"><div class="tocStart">

</div>
<!-- toc -->
<ul>
<li><a href="#gao-xing-neng-fen-zu-lie-biao-she-ji">高性能分组列表设计</a>
<ul>
<li><a href="#zheng-ti-mu-biao">整体目标</a></li>
<li><a href="#fen-xi">分析</a></li>
<li><a href="#shu-ju-jie-gou-she-ji">数据结构设计</a></li>
<li><a href="#suan-fa-xuan-ze">算法选择</a>
<ul>
<li><a href="#yi-wei-dui-xiang-shu-zu-zhuan-huan-cheng-qian-tao-jie-gou-she-ji">一维对象数组转换成嵌套结构设计：</a></li>
</ul></li>
<li><a href="#ju-ti-shi-xian">具体实现</a>
<ul>
<li><a href="#yi-wei-dui-xiang-shu-zu-zhuan-huan-cheng-qian-tao-jie-gou-shi-xian">一维对象数组转换成嵌套结构实现：</a></li>
</ul></li>
</ul></li>
</ul>
<!-- tocstop -->
<div class="tocEnd">

</div>
<h1><span id="gao-xing-neng-fen-zu-lie-biao-she-ji">高性能分组列表设计</span><a href="#gao-xing-neng-fen-zu-lie-biao-she-ji" class="header-anchor">#</a></h1>
<h2><span id="zheng-ti-mu-biao">整体目标</span><a href="#zheng-ti-mu-biao" class="header-anchor">#</a></h2>
<ol type="1">
<li>分组存在嵌套关系，且深度无理论上限</li>
<li>可以通过拖拽，将已分组元素拖出，接触分组关系</li>
<li>可以通过拖拽，将未分组元素拖入分组内，建立新的分组关系</li>
<li>未分组列表项移动时，会自动越过分组及其子组件</li>
<li>未分组列表项进行分组时，应保持分组前的相对顺序</li>
<li>已分组列表项，在解除分组时，应保持分组前的相对顺序</li>
<li>以上操作对直接操作分组时，也应有效（这里将分组也作为一个列表项进行操作） ## 分析</li>
</ol>
<ul>
<li>由于目标1&amp;5，数据结构应保持一维结构，即对象数组的形式。这样的数据结构，提供了列表项的基础顺序，方便在创建分组时保持列表项的相对顺序。</li>
<li>对于目标2&amp;3&amp;5&amp;6，在计算拖拽项是否建立/更新/删除分组关系时，应记录已分组列表项在组内的相对位置，方便在分组关系变化时，对列表的位置进行排序</li>
<li>对于目标7，应把分组也作为列表项之一。提供“type”字段作为分组列表项和其他列表的区别，为后续可能拓展分组的展开/收起功能</li>
<li>渲染列表时会使用一个多维结构的数据，方便递归的对列表进行渲染，对于jsx语法友好。 ## 数据结构设计</li>
</ul>
<p>列表项数据结构</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ListItem</span> &#123;</span><br><span class="line">  <span class="attr">code</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">groupCode</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>列表数据结构</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">List</span> = <span class="title class_">ListImte</span>[]</span><br></pre></td></tr></table></figure>
<p>更新分组时的辅助数据结构</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">GroupStack</span> = &#123;</span><br><span class="line">  <span class="attr">groupCode</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">index</span>: <span class="built_in">number</span>; <span class="comment">// 分组真实的下标</span></span><br><span class="line">  <span class="attr">offsetNumber</span>: <span class="built_in">number</span> <span class="comment">// 分组的长度，方便记录分组内列表项的相对位置</span></span><br><span class="line">&#125;[]</span><br></pre></td></tr></table></figure>
<p>用于react渲染的数据结构</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">AssistStruct</span> &#123;</span><br><span class="line">  <span class="attr">code</span>: <span class="built_in">string</span>;</span><br><span class="line">  children?: <span class="title class_">AssistStruct</span>[];</span><br><span class="line">  parentGroupCode?: <span class="built_in">string</span>; <span class="comment">//pop stack flag</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="suan-fa-xuan-ze">算法选择</span><a href="#suan-fa-xuan-ze" class="header-anchor">#</a></h2>
<h3><span id="yi-wei-dui-xiang-shu-zu-zhuan-huan-cheng-qian-tao-jie-gou-she-ji">一维对象数组转换成嵌套结构设计：</span><a href="#yi-wei-dui-xiang-shu-zu-zhuan-huan-cheng-qian-tao-jie-gou-she-ji" class="header-anchor">#</a></h3>
<p>检测分组闭合,算法属于括号闭合算法的变种。</p>
<p>使用栈记录，未闭合的分组code。当前列表项中的group-code字段与栈顶的code不相等时，表示分组闭合，并且弹出当前栈顶元素。</p>
<p><img src="/images/group_list.png"></p>
<h2><span id="ju-ti-shi-xian">具体实现</span><a href="#ju-ti-shi-xian" class="header-anchor">#</a></h2>
<h3><span id="yi-wei-dui-xiang-shu-zu-zhuan-huan-cheng-qian-tao-jie-gou-shi-xian">一维对象数组转换成嵌套结构实现：</span><a href="#yi-wei-dui-xiang-shu-zu-zhuan-huan-cheng-qian-tao-jie-gou-shi-xian" class="header-anchor">#</a></h3>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将一维数组转成多层结构</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> compCodes 所有组件的code</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> compDatas 所有组件的数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> 返回和code相关的嵌套结构、</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> subList = (<span class="attr">compCodes</span>: <span class="built_in">string</span>[], <span class="attr">compDatas</span>: <span class="variable constant_">JDV</span>.<span class="property">State</span>[<span class="string">&#x27;compDatas&#x27;</span>]): <span class="title class_">AssistStruct</span>[] =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">groupStack</span>: <span class="title class_">GroupStack</span>[] = [];</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">resultData</span>: <span class="title class_">AssistStruct</span>[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">stackPop</span> = (<span class="params">groupCode?: <span class="built_in">string</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> len = groupStack.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (len &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (groupStack[len].<span class="property">groupCode</span> !== groupCode) &#123;</span><br><span class="line">        groupStack.<span class="title function_">pop</span>();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      len--;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">setResult</span> = (<span class="params">result: AssistStruct[], groupStack: GroupStack[], groupCode: <span class="built_in">string</span>, value: AssistStruct</span>) =&gt; &#123;</span><br><span class="line">    groupStack.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!result[item.<span class="property">index</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (result[item.<span class="property">index</span>].<span class="property">code</span> !== groupCode) &#123;</span><br><span class="line">        <span class="comment">// 如果当前组件的分组不等于结果中的key，向下搜索</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">setResult</span>(result[item.<span class="property">index</span>].<span class="property">children</span> <span class="keyword">as</span> <span class="title class_">AssistStruct</span>[], groupStack.<span class="title function_">slice</span>(index + <span class="number">1</span>), groupCode, value);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (result[item.<span class="property">index</span>].<span class="property">children</span>) &#123;</span><br><span class="line">          (result[item.<span class="property">index</span>].<span class="property">children</span> <span class="keyword">as</span> <span class="title class_">AssistStruct</span>[]).<span class="title function_">push</span>(value);</span><br><span class="line">          item.<span class="property">offsetNumber</span> += <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          result[item.<span class="property">index</span>].<span class="property">children</span> = [value];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  compCodes.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> hasGroup = compDatas[item] ? compDatas[item].<span class="property">config</span>.<span class="property">groupCode</span> : <span class="literal">undefined</span>;</span><br><span class="line">    <span class="title function_">stackPop</span>(hasGroup);</span><br><span class="line">    <span class="keyword">if</span> (compDatas[item].<span class="property">compCode</span> === <span class="string">&#x27;group&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (hasGroup) &#123;</span><br><span class="line">        <span class="comment">// 如果当前组件的父组件在栈顶,更新结果树</span></span><br><span class="line">        <span class="title function_">setResult</span>(resultData, groupStack.<span class="title function_">slice</span>(<span class="number">0</span>), hasGroup, &#123;</span><br><span class="line">          <span class="attr">code</span>: item,</span><br><span class="line">          <span class="attr">children</span>: [],</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果当前分组有父分组,此时分组栈一定不为空，分组索引为父分组长度-1</span></span><br><span class="line">        <span class="comment">// debugger;</span></span><br><span class="line">        groupStack.<span class="title function_">push</span>(&#123;</span><br><span class="line">          <span class="attr">groupCode</span>: item,</span><br><span class="line">          <span class="attr">index</span>: groupStack.<span class="property">length</span> ? groupStack[groupStack.<span class="property">length</span> - <span class="number">1</span>].<span class="property">offsetNumber</span> - <span class="number">1</span> : index,</span><br><span class="line">          <span class="attr">offsetNumber</span>: <span class="number">0</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        groupStack = []; <span class="comment">//没有分组，清空栈</span></span><br><span class="line">        resultData.<span class="title function_">push</span>(&#123;</span><br><span class="line">          <span class="attr">code</span>: item,</span><br><span class="line">          <span class="attr">children</span>: [],</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//如果当前分组没有父分组,此时分组栈一定为空，分组索引为结果长度</span></span><br><span class="line">        groupStack.<span class="title function_">push</span>(&#123;</span><br><span class="line">          <span class="attr">groupCode</span>: item,</span><br><span class="line">          <span class="attr">index</span>: resultData.<span class="property">length</span> - <span class="number">1</span>,</span><br><span class="line">          <span class="attr">offsetNumber</span>: <span class="number">0</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (hasGroup) &#123;</span><br><span class="line">        <span class="comment">// 如果当前组件的父组件在栈顶,更新结果树</span></span><br><span class="line">        <span class="title function_">setResult</span>(resultData, groupStack.<span class="title function_">slice</span>(<span class="number">0</span>), hasGroup, &#123;</span><br><span class="line">          <span class="attr">code</span>: item,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        groupStack = []; <span class="comment">//没有分组，清空栈</span></span><br><span class="line">        resultData.<span class="title function_">push</span>(&#123;</span><br><span class="line">          <span class="attr">code</span>: item,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> resultData;</span><br></pre></td></tr></table></figure>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/tags/project/page/0/">Previous</a></div><div class="pagination-next"><a href="/tags/project/page/2/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/tags/project/">1</a></li><li><a class="pagination-link" href="/tags/project/page/2/">2</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://img1.imgtp.com/2023/09/10/ZBplTO4E.jpg" alt="Ashes Born"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Ashes Born</p><p class="is-size-6 is-block">心中有座观澜阁，土木付炬皆尘生</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>CN</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">20</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">5</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">6</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/sadofriod" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/sadofriod"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/rss2.xml"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/algorithm/"><span class="level-start"><span class="level-item">algorithm</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/error/"><span class="level-start"><span class="level-item">error</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/interesting/"><span class="level-start"><span class="level-item">interesting</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/project/"><span class="level-start"><span class="level-item">project</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/typescript/"><span class="level-start"><span class="level-item">typescript</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-01-11T13:53:18.000Z">2023-01-11</time></p><p class="title"><a href="/%E4%BB%8ECRA%E5%B0%86react%E9%A1%B9%E7%9B%AE%E8%BF%81%E7%A7%BB%E6%88%90%E5%BE%AE%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE-1.html">从CRA将react项目迁移成微前端项目-1</a></p><p class="categories"><a href="/categories/project/">project</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-11-30T14:33:43.000Z">2022-11-30</time></p><p class="title"><a href="/JS%E5%BC%80%E5%8F%91%E4%B8%AD%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%8F%E9%AA%8C.html">JS开发中函数式编程的一些经验</a></p><p class="categories"><a href="/categories/project/">project</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-08-08T11:51:42.000Z">2022-08-08</time></p><p class="title"><a href="/%E5%A2%9E%E9%87%8F%E8%BF%90%E8%A1%8CE2E%E6%B5%8B%E8%AF%95.html">增量运行E2E测试</a></p><p class="categories"><a href="/categories/project/">project</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-08-07T15:00:31.000Z">2022-08-07</time></p><p class="title"><a href="/%20monorepo%E7%BB%93%E6%9E%84%E4%B8%8B%E5%90%AF%E5%8A%A8react%E9%A1%B9%E7%9B%AE%E5%B1%80%E9%83%A8%E7%83%AD%E6%9B%B4%E6%96%B0.html">monorepo结构下启动react项目局部热更新</a></p><p class="categories"><a href="/categories/project/">project</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-04-27T11:52:50.000Z">2022-04-27</time></p><p class="title"><a href="/%E5%B0%86KVM%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AD%98%E5%82%A8%E5%88%B0NAS%E4%B8%8A.html">将KVM的虚拟机存储到NAS上</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/"><span class="level-start"><span class="level-item">2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/"><span class="level-start"><span class="level-item">2021</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/"><span class="level-start"><span class="level-item">2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/"><span class="level-start"><span class="level-item">2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/algorithm/"><span class="tag">algorithm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/error/"><span class="tag">error</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/interesting/"><span class="tag">interesting</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/interestring/"><span class="tag">interestring</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/project/"><span class="tag">project</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/typescript/"><span class="tag">typescript</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://cdn.midjourney.com/ffa4484a-2f5a-4c71-96b8-7749aef5dfd3/0_0_384_N.webp" alt="Ashes Born&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2023 Ashes Born</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>